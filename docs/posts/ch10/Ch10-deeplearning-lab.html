<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.39">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Oren Bochman">

<title>Deep Learning – An Introduction to Statistical Learning</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="../../site_libs/quarto-nav/quarto-nav.js"></script>
<script src="../../site_libs/quarto-nav/headroom.min.js"></script>
<script src="../../site_libs/clipboard/clipboard.min.js"></script>
<script src="../../site_libs/quarto-search/autocomplete.umd.js"></script>
<script src="../../site_libs/quarto-search/fuse.min.js"></script>
<script src="../../site_libs/quarto-search/quarto-search.js"></script>
<meta name="quarto:offset" content="../../">
<script src="../../site_libs/quarto-html/quarto.js"></script>
<script src="../../site_libs/quarto-html/popper.min.js"></script>
<script src="../../site_libs/quarto-html/tippy.umd.min.js"></script>
<script src="../../site_libs/quarto-html/anchor.min.js"></script>
<link href="../../site_libs/quarto-html/tippy.css" rel="stylesheet">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-e26003cea8cd680ca0c55a263523d882.css" rel="stylesheet" class="quarto-color-scheme" id="quarto-text-highlighting-styles">
<link href="../../site_libs/quarto-html/quarto-syntax-highlighting-dark-d166b450ba5a8e9f7a0ab969bf6592c1.css" rel="prefetch" class="quarto-color-scheme quarto-color-alternate" id="quarto-text-highlighting-styles">
<script src="../../site_libs/bootstrap/bootstrap.min.js"></script>
<link href="../../site_libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="../../site_libs/bootstrap/bootstrap-581c437ac42e3565a0eaaf4c4d5a959a.min.css" rel="stylesheet" append-hash="true" class="quarto-color-scheme" id="quarto-bootstrap" data-mode="light">
<link href="../../site_libs/bootstrap/bootstrap-dark-007d2adcd9597ba82898f6769454e788.min.css" rel="prefetch" append-hash="true" class="quarto-color-scheme quarto-color-alternate" id="quarto-bootstrap" data-mode="dark">
<script src="../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.js"></script>
<link href="../../site_libs/quarto-contrib/pseudocode-2.4.1/pseudocode.min.css" rel="stylesheet">
<script src="../../site_libs/quarto-contrib/glightbox/glightbox.min.js"></script>
<link href="../../site_libs/quarto-contrib/glightbox/glightbox.min.css" rel="stylesheet">
<link href="../../site_libs/quarto-contrib/glightbox/lightbox.css" rel="stylesheet">
<script id="quarto-search-options" type="application/json">{
  "location": "navbar",
  "copy-button": false,
  "collapse-after": 3,
  "panel-placement": "end",
  "type": "overlay",
  "limit": 50,
  "keyboard-shortcut": [
    "f",
    "/",
    "s"
  ],
  "show-item-context": false,
  "language": {
    "search-no-results-text": "No results",
    "search-matching-documents-text": "matching documents",
    "search-copy-link-title": "Copy link to search",
    "search-hide-matches-text": "Hide additional matches",
    "search-more-match-text": "more match in this document",
    "search-more-matches-text": "more matches in this document",
    "search-clear-button-title": "Clear",
    "search-text-placeholder": "",
    "search-detached-cancel-button-title": "Cancel",
    "search-submit-button-title": "Submit",
    "search-label": "Search"
  }
}</script>
<style>

      .quarto-title-block .quarto-title-banner {
        background-image: url(../../images/banner_black_3.jpg);
background-size: cover;
      }
</style>

  <script>window.backupDefine = window.define; window.define = undefined;</script><script src="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.js"></script>
  <script>document.addEventListener("DOMContentLoaded", function () {
 var mathElements = document.getElementsByClassName("math");
 var macros = [];
 for (var i = 0; i < mathElements.length; i++) {
  var texText = mathElements[i].firstChild;
  if (mathElements[i].tagName == "SPAN") {
   katex.render(texText.data, mathElements[i], {
    displayMode: mathElements[i].classList.contains('display'),
    throwOnError: false,
    macros: macros,
    fleqn: false
   });
}}});
  </script>
  <script>window.define = window.backupDefine; window.backupDefine = undefined;</script><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@latest/dist/katex.min.css">

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

<link rel="stylesheet" href="../../styles.css">
</head>

<body class="nav-sidebar floating nav-fixed">

<div id="quarto-search-results"></div>
  <header id="quarto-header" class="headroom fixed-top quarto-banner">
    <nav class="navbar navbar-expand-lg " data-bs-theme="dark">
      <div class="navbar-container container-fluid">
      <div class="navbar-brand-container mx-auto">
    <a class="navbar-brand" href="../../index.html">
    <span class="navbar-title">An Introduction to Statistical Learning</span>
    </a>
  </div>
            <div id="quarto-search" class="" title="Search"></div>
          <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarCollapse" aria-controls="navbarCollapse" role="menu" aria-expanded="false" aria-label="Toggle navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
  <span class="navbar-toggler-icon"></span>
</button>
          <div class="collapse navbar-collapse" id="navbarCollapse">
            <ul class="navbar-nav navbar-nav-scroll me-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../index.html"> 
<span class="menu-text">Home</span></a>
  </li>  
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
</ul>
            <ul class="navbar-nav navbar-nav-scroll ms-auto">
  <li class="nav-item">
    <a class="nav-link" href="../../about.html"> 
<span class="menu-text">About</span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://github.com/"> <i class="bi bi-github" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="https://twitter.com"> <i class="bi bi-twitter" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
  <li class="nav-item compact">
    <a class="nav-link" href="../../index.xml"> <i class="bi bi-rss" role="img">
</i> 
<span class="menu-text"></span></a>
  </li>  
</ul>
          </div> <!-- /navcollapse -->
            <div class="quarto-navbar-tools">
  <a href="" class="quarto-color-scheme-toggle quarto-navigation-tool  px-1" onclick="window.quartoToggleColorScheme(); return false;" title="Toggle dark mode"><i class="bi"></i></a>
</div>
      </div> <!-- /container-fluid -->
    </nav>
  <nav class="quarto-secondary-nav">
    <div class="container-fluid d-flex">
      <button type="button" class="quarto-btn-toggle btn" data-bs-toggle="collapse" role="button" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">
        <i class="bi bi-layout-text-sidebar-reverse"></i>
      </button>
        <nav class="quarto-page-breadcrumbs" aria-label="breadcrumb"><ol class="breadcrumb"><li class="breadcrumb-item">Deep Learning</li></ol></nav>
        <a class="flex-grow-1" role="navigation" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item" aria-controls="quarto-sidebar" aria-expanded="false" aria-label="Toggle sidebar navigation" onclick="if (window.quartoToggleHeadroom) { window.quartoToggleHeadroom(); }">      
        </a>
    </div>
  </nav>
</header>
<!-- content -->
<header id="title-block-header" class="quarto-title-block default toc-left page-columns page-full">
  <div class="quarto-title-banner page-columns page-full">
    <div class="quarto-title column-page-right">
      <h1 class="title">Deep Learning</h1>
                                <div class="quarto-categories">
                <div class="quarto-category">lab</div>
                <div class="quarto-category">python</div>
              </div>
                  </div>
  </div>
    
  
  <div class="quarto-title-meta column-page-right">

      <div>
      <div class="quarto-title-meta-heading">Author</div>
      <div class="quarto-title-meta-contents">
               <p>Oren Bochman </p>
            </div>
    </div>
      
      <div>
      <div class="quarto-title-meta-heading">Published</div>
      <div class="quarto-title-meta-contents">
        <p class="date">Wednesday, August 21, 2024</p>
      </div>
    </div>
    
      
    </div>
    
  
  </header><div id="quarto-content" class="quarto-container page-columns page-rows-contents page-layout-full page-navbar">
<!-- sidebar -->
  <nav id="quarto-sidebar" class="sidebar collapse collapse-horizontal quarto-sidebar-collapse-item sidebar-navigation floating overflow-auto">
    <div class="sidebar-menu-container"> 
    <ul class="list-unstyled mt-1">
        <li class="sidebar-item sidebar-item-section">
      <div class="sidebar-item-container"> 
            <a class="sidebar-item-text sidebar-link text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true">
 <span class="menu-text">Book</span></a>
          <a class="sidebar-item-toggle text-start" data-bs-toggle="collapse" data-bs-target="#quarto-sidebar-section-1" role="navigation" aria-expanded="true" aria-label="Toggle section">
            <i class="bi bi-chevron-right ms-2"></i>
          </a> 
      </div>
      <ul id="quarto-sidebar-section-1" class="collapse list-unstyled sidebar-section depth1 show">  
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch01/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 1: Introduction</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch02/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 2: Statistical Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch03/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 3: Linear Regression</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch04/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 4: Classification</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch05/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 5: Resampling Methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch06/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 6: Linear Model Selection and Regularization</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch07/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 7: Moving Beyond Linearity</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch08/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 8: Tree-Based Methods</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch09/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 9: Support Vector Machines</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch10/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 10: Deep Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch11/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 11: Survival Analysis and Censored Data</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch12/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 12: Unsupervised Learning</span></a>
  </div>
</li>
          <li class="sidebar-item">
  <div class="sidebar-item-container"> 
  <a href="../../posts/ch13/index.html" class="sidebar-item-text sidebar-link">
 <span class="menu-text">Chapter 13: Multiple Testing</span></a>
  </div>
</li>
      </ul>
  </li>
    </ul>
    </div>
    <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Table of contents</h2>
   
  <ul>
  <li><a href="#torch-specific-imports" id="toc-torch-specific-imports" class="nav-link active" data-scroll-target="#torch-specific-imports">Torch-Specific Imports</a></li>
  <li><a href="#single-layer-network-on-hitters-data" id="toc-single-layer-network-on-hitters-data" class="nav-link" data-scroll-target="#single-layer-network-on-hitters-data">Single Layer Network on Hitters Data</a>
  <ul class="collapse">
  <li><a href="#linear-models" id="toc-linear-models" class="nav-link" data-scroll-target="#linear-models">Linear Models</a></li>
  <li><a href="#specifying-a-network-classes-and-inheritance" id="toc-specifying-a-network-classes-and-inheritance" class="nav-link" data-scroll-target="#specifying-a-network-classes-and-inheritance">Specifying a Network: Classes and Inheritance</a></li>
  <li><a href="#cleanup" id="toc-cleanup" class="nav-link" data-scroll-target="#cleanup">Cleanup</a></li>
  </ul></li>
  <li><a href="#multilayer-network-on-the-mnist-digit-data" id="toc-multilayer-network-on-the-mnist-digit-data" class="nav-link" data-scroll-target="#multilayer-network-on-the-mnist-digit-data">Multilayer Network on the MNIST Digit Data</a></li>
  <li><a href="#convolutional-neural-networks" id="toc-convolutional-neural-networks" class="nav-link" data-scroll-target="#convolutional-neural-networks">Convolutional Neural Networks</a>
  <ul class="collapse">
  <li><a href="#hardware-acceleration" id="toc-hardware-acceleration" class="nav-link" data-scroll-target="#hardware-acceleration">Hardware Acceleration</a></li>
  </ul></li>
  <li><a href="#using-pretrained-cnn-models" id="toc-using-pretrained-cnn-models" class="nav-link" data-scroll-target="#using-pretrained-cnn-models">Using Pretrained CNN Models</a></li>
  <li><a href="#imdb-document-classification" id="toc-imdb-document-classification" class="nav-link" data-scroll-target="#imdb-document-classification">IMDB Document Classification</a>
  <ul class="collapse">
  <li><a href="#comparison-to-lasso" id="toc-comparison-to-lasso" class="nav-link" data-scroll-target="#comparison-to-lasso">Comparison to Lasso</a></li>
  </ul></li>
  <li><a href="#recurrent-neural-networks" id="toc-recurrent-neural-networks" class="nav-link" data-scroll-target="#recurrent-neural-networks">Recurrent Neural Networks</a>
  <ul class="collapse">
  <li><a href="#sequential-models-for-document-classification" id="toc-sequential-models-for-document-classification" class="nav-link" data-scroll-target="#sequential-models-for-document-classification">Sequential Models for Document Classification</a></li>
  <li><a href="#time-series-prediction" id="toc-time-series-prediction" class="nav-link" data-scroll-target="#time-series-prediction">Time Series Prediction</a></li>
  </ul></li>
  </ul>
<div class="toc-actions"><ul><li><a href="https://github.com/OrenBochman/notes-islr-py/edit/main/posts/ch10/Ch10-deeplearning-lab.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/OrenBochman/notes-islr-py/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></nav>
</nav>
<div id="quarto-sidebar-glass" class="quarto-sidebar-collapse-item" data-bs-toggle="collapse" data-bs-target=".quarto-sidebar-collapse-item"></div>
<!-- margin-sidebar -->
    <div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
    </div>
<!-- main -->
<main class="content quarto-banner-title-block column-page-right" id="quarto-document-content">





<p><a target="_blank" href="https://colab.research.google.com/github/intro-stat-learning/ISLP_labs/blob/v2.2/Ch10-deeplearning-lab.ipynb"> <img src="https://colab.research.google.com/assets/colab-badge.svg" alt="Open In Colab"> </a></p>
<div class="quarto-figure quarto-figure-center">
<figure class="figure">
<p><img src="https://mybinder.org/badge_logo.svg" class="img-fluid figure-img"></p>
<figcaption>Binder</figcaption>
</figure>
</div>
<p>In this section we demonstrate how to fit the examples discussed in the text. We use the <code>Python</code> <code>torch</code> package, along with the <code>pytorch_lightning</code> package which provides utilities to simplify fitting and evaluating models. This code can be impressively fast with certain special processors, such as Apple’s new M1 chip. The package is well-structured, flexible, and will feel comfortable to <code>Python</code> users. A good companion is the site <a href="https://pytorch.org/tutorials/beginner/basics/intro.html">pytorch.org/tutorials</a>. Much of our code is adapted from there, as well as the <code>pytorch_lightning</code> documentation. {The precise URLs at the time of writing are <a href="https://pytorch.org/tutorials/beginner/basics/intro.html" class="uri">https://pytorch.org/tutorials/beginner/basics/intro.html</a> and <a href="https://pytorch-lightning.readthedocs.io/en/latest/" class="uri">https://pytorch-lightning.readthedocs.io/en/latest/</a>.}</p>
<p>We start with several standard imports that we have seen before.</p>
<div id="1e823bd9" class="cell" data-execution_count="1">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> numpy <span class="im">as</span> np, pandas <span class="im">as</span> pd</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> matplotlib.pyplot <span class="im">import</span> subplots</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.linear_model <span class="im">import</span> <span class="op">\</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>     (LinearRegression,</span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>      LogisticRegression,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>      Lasso)</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.preprocessing <span class="im">import</span> StandardScaler</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> KFold</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.pipeline <span class="im">import</span> Pipeline</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP <span class="im">import</span> load_data</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.models <span class="im">import</span> ModelSpec <span class="im">as</span> MS</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> sklearn.model_selection <span class="im">import</span> <span class="op">\</span></span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>     (train_test_split,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>      GridSearchCV)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="torch-specific-imports" class="level3">
<h3 class="anchored" data-anchor-id="torch-specific-imports">Torch-Specific Imports</h3>
<p>There are a number of imports for <code>torch</code>. (These are not included with <code>ISLP</code>, so must be installed separately.) First we import the main library and essential tools used to specify sequentially-structured networks.</p>
<div id="0507161a" class="cell" data-execution_count="2">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> torch</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch <span class="im">import</span> nn</span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.optim <span class="im">import</span> RMSprop</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torch.utils.data <span class="im">import</span> TensorDataset</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>There are several other helper packages for <code>torch</code>. For instance, the <code>torchmetrics</code> package has utilities to compute various metrics to evaluate performance when fitting a model. The <code>torchinfo</code> package provides a useful summary of the layers of a model. We use the <code>read_image()</code> function when loading test images in Section~.</p>
<p>If you have not already installed the packages <code>torchvision</code> and <code>torchinfo</code> you can install them by running <code>pip install torchinfo torchvision</code>. We can now import from <code>torchinfo</code>.</p>
<div id="547cabdd" class="cell" data-execution_count="3">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchmetrics <span class="im">import</span> (MeanAbsoluteError,</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>                          R2Score)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchinfo <span class="im">import</span> summary</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The package <code>pytorch_lightning</code> is a somewhat higher-level interface to <code>torch</code> that simplifies the specification and fitting of models by reducing the amount of boilerplate code needed (compared to using <code>torch</code> alone).</p>
<div id="6bf50514" class="cell" data-execution_count="4">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytorch_lightning <span class="im">import</span> Trainer</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytorch_lightning.loggers <span class="im">import</span> CSVLogger</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In order to reproduce results we use <code>seed_everything()</code>. We will also instruct <code>torch</code> to use deterministic algorithms where possible.</p>
<div id="dce67860" class="cell" data-execution_count="5">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> pytorch_lightning <span class="im">import</span> seed_everything</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>seed_everything(<span class="dv">0</span>, workers<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>torch.use_deterministic_algorithms(<span class="va">True</span>, warn_only<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Seed set to 0</code></pre>
</div>
</div>
<p>We will use several datasets shipped with <code>torchvision</code> for our examples: a pretrained network for image classification, as well as some transforms used for preprocessing.</p>
<div id="8bbc8577" class="cell" data-execution_count="6">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.io <span class="im">import</span> read_image</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.datasets <span class="im">import</span> MNIST, CIFAR100</span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.models <span class="im">import</span> (resnet50,</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>                                ResNet50_Weights)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> torchvision.transforms <span class="im">import</span> (Resize,</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>                                    Normalize,</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>                                    CenterCrop,</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>                                    ToTensor)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We have provided a few utilities in <code>ISLP</code> specifically for this lab. The <code>SimpleDataModule</code> and <code>SimpleModule</code> are simple versions of objects used in <code>pytorch_lightning</code>, the high-level module for fitting <code>torch</code> models. Although more advanced uses such as computing on graphical processing units (GPUs) and parallel data processing are possible in this module, we will not be focusing much on these in this lab. The <code>ErrorTracker</code> handles collections of targets and predictions over each mini-batch in the validation or test stage, allowing computation of the metric over the entire validation or test data set.</p>
<div id="99b8221a" class="cell" data-execution_count="7">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.torch <span class="im">import</span> (SimpleDataModule,</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>                        SimpleModule,</span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>                        ErrorTracker,</span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>                        rec_num_workers)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>In addition we have included some helper functions to load the <code>IMDb</code> database, as well as a lookup that maps integers to particular keys in the database. We’ve included a slightly modified copy of the preprocessed <code>IMDb</code> data from <code>keras</code>, a separate package for fitting deep learning models. This saves us significant preprocessing and allows us to focus on specifying and fitting the models themselves.</p>
<div id="a2d8f60a" class="cell" data-execution_count="8">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> ISLP.torch.imdb <span class="im">import</span> (load_lookup,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                             load_tensor,</span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                             load_sparse,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                             load_sequential)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we introduce some utility imports not directly related to <code>torch</code>. The <code>glob()</code> function from the <code>glob</code> module is used to find all files matching wildcard characters, which we will use in our example applying the <code>ResNet50</code> model to some of our own images. The <code>json</code> module will be used to load a JSON file for looking up classes to identify the labels of the pictures in the <code>ResNet50</code> example.</p>
<div id="af0b59ce" class="cell" data-execution_count="9">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="im">from</span> glob <span class="im">import</span> glob</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a><span class="im">import</span> json</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="single-layer-network-on-hitters-data" class="level2">
<h2 class="anchored" data-anchor-id="single-layer-network-on-hitters-data">Single Layer Network on Hitters Data</h2>
<p>We start by fitting the models in Section~ on the <code>Hitters</code> data.</p>
<div id="f0529bf0" class="cell" data-execution_count="10">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>Hitters <span class="op">=</span> load_data(<span class="st">'Hitters'</span>).dropna()</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> Hitters.shape[<span class="dv">0</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We will fit two linear models (least squares and lasso) and compare their performance to that of a neural network. For this comparison we will use mean absolute error on a validation dataset. <span class="math display">\begin{equation*}
\begin{split}
\mbox{MAE}(y,\hat{y}) = \frac{1}{n} \sum_{i=1}^n |y_i-\hat{y}_i|.
\end{split}
\end{equation*}</span> We set up the model matrix and the response.</p>
<div id="53e11dcb" class="cell" data-execution_count="11">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>model <span class="op">=</span> MS(Hitters.columns.drop(<span class="st">'Salary'</span>), intercept<span class="op">=</span><span class="va">False</span>)</span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> model.fit_transform(Hitters).to_numpy()</span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>Y <span class="op">=</span> Hitters[<span class="st">'Salary'</span>].to_numpy()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>to_numpy()</code> method above converts <code>pandas</code> data frames or series to <code>numpy</code> arrays. We do this because we will need to use <code>sklearn</code> to fit the lasso model, and it requires this conversion. We also use a linear regression method from <code>sklearn</code>, rather than the method in Chapter~3 from <code>statsmodels</code>, to facilitate the comparisons.</p>
<p>We now split the data into test and training, fixing the random state used by <code>sklearn</code> to do the split.</p>
<div id="222064e4" class="cell" data-execution_count="12">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>(X_train, </span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a> X_test,</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a> Y_train,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a> Y_test) <span class="op">=</span> train_test_split(X,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>                            Y,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>                            test_size<span class="op">=</span><span class="dv">1</span><span class="op">/</span><span class="dv">3</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>                            random_state<span class="op">=</span><span class="dv">1</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<section id="linear-models" class="level3">
<h3 class="anchored" data-anchor-id="linear-models">Linear Models</h3>
<p>We fit the linear model and evaluate the test error directly.</p>
<div id="ba6ff34d" class="cell" data-execution_count="13">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a>hit_lm <span class="op">=</span> LinearRegression().fit(X_train, Y_train)</span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>Yhat_test <span class="op">=</span> hit_lm.predict(X_test)</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>np.<span class="bu">abs</span>(Yhat_test <span class="op">-</span> Y_test).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="13">
<pre><code>259.7152883314627</code></pre>
</div>
</div>
<p>Next we fit the lasso using <code>sklearn</code>. We are using mean absolute error to select and evaluate a model, rather than mean squared error. The specialized solver we used in Section~ uses only mean squared error. So here, with a bit more work, we create a cross-validation grid and perform the cross-validation directly.</p>
<p>We encode a pipeline with two steps: we first normalize the features using a <code>StandardScaler()</code> transform, and then fit the lasso without further normalization.</p>
<div id="74a9f618" class="cell" data-execution_count="14">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>scaler <span class="op">=</span> StandardScaler(with_mean<span class="op">=</span><span class="va">True</span>, with_std<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>lasso <span class="op">=</span> Lasso(warm_start<span class="op">=</span><span class="va">True</span>, max_iter<span class="op">=</span><span class="dv">30000</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>standard_lasso <span class="op">=</span> Pipeline(steps<span class="op">=</span>[(<span class="st">'scaler'</span>, scaler),</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>                                 (<span class="st">'lasso'</span>, lasso)])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We need to create a grid of values for <span class="math inline">\lambda</span>. As is common practice, we choose a grid of 100 values of <span class="math inline">\lambda</span>, uniform on the log scale from <code>lam_max</code> down to <code>0.01*lam_max</code>. Here <code>lam_max</code> is the smallest value of <span class="math inline">\lambda</span> with an all-zero solution. This value equals the largest absolute inner-product between any predictor and the (centered) response. {The derivation of this result is beyond the scope of this book.}</p>
<div id="96b596e1" class="cell" data-execution_count="15">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>X_s <span class="op">=</span> scaler.fit_transform(X_train)</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>n <span class="op">=</span> X_s.shape[<span class="dv">0</span>]</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>lam_max <span class="op">=</span> np.fabs(X_s.T.dot(Y_train <span class="op">-</span> Y_train.mean())).<span class="bu">max</span>() <span class="op">/</span> n</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>param_grid <span class="op">=</span> {<span class="st">'lasso__alpha'</span>: np.exp(np.linspace(<span class="dv">0</span>, np.log(<span class="fl">0.01</span>), <span class="dv">100</span>))</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>             <span class="op">*</span> lam_max}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we had to transform the data first, since the scale of the variables impacts the choice of <span class="math inline">\lambda</span>. We now perform cross-validation using this sequence of <span class="math inline">\lambda</span> values.</p>
<div id="a51396a5" class="cell" data-execution_count="16">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>cv <span class="op">=</span> KFold(<span class="dv">10</span>,</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>           shuffle<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>           random_state<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>grid <span class="op">=</span> GridSearchCV(standard_lasso,</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>                    param_grid,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>                    cv<span class="op">=</span>cv,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                    scoring<span class="op">=</span><span class="st">'neg_mean_absolute_error'</span>)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>grid.fit(X_train, Y_train)<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We extract the lasso model with best cross-validated mean absolute error, and evaluate its performance on <code>X_test</code> and <code>Y_test</code>, which were not used in cross-validation.</p>
<div id="17ca1394" class="cell" data-execution_count="17">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>trained_lasso <span class="op">=</span> grid.best_estimator_</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>Yhat_test <span class="op">=</span> trained_lasso.predict(X_test)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>np.fabs(Yhat_test <span class="op">-</span> Y_test).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="17">
<pre><code>235.6754837478029</code></pre>
</div>
</div>
<p>This is similar to the results we got for the linear model fit by least squares. However, these results can vary a lot for different train/test splits; we encourage the reader to try a different seed in code block 12 and rerun the subsequent code up to this point.</p>
</section>
<section id="specifying-a-network-classes-and-inheritance" class="level3">
<h3 class="anchored" data-anchor-id="specifying-a-network-classes-and-inheritance">Specifying a Network: Classes and Inheritance</h3>
<p>To fit the neural network, we first set up a model structure that describes the network. Doing so requires us to define new classes specific to the model we wish to fit. Typically this is done in <code>pytorch</code> by sub-classing a generic representation of a network, which is the approach we take here. Although this example is simple, we will go through the steps in some detail, since it will serve us well for the more complex examples to follow.</p>
<div id="8bfe6a82" class="cell" data-execution_count="18">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> HittersModel(nn.Module):</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size):</span>
<span id="cb21-4"><a href="#cb21-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(HittersModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb21-5"><a href="#cb21-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.flatten <span class="op">=</span> nn.Flatten()</span>
<span id="cb21-6"><a href="#cb21-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.sequential <span class="op">=</span> nn.Sequential(</span>
<span id="cb21-7"><a href="#cb21-7" aria-hidden="true" tabindex="-1"></a>            nn.Linear(input_size, <span class="dv">50</span>),</span>
<span id="cb21-8"><a href="#cb21-8" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb21-9"><a href="#cb21-9" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.4</span>),</span>
<span id="cb21-10"><a href="#cb21-10" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">50</span>, <span class="dv">1</span>))</span>
<span id="cb21-11"><a href="#cb21-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb21-12"><a href="#cb21-12" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb21-13"><a href="#cb21-13" aria-hidden="true" tabindex="-1"></a>        x <span class="op">=</span> <span class="va">self</span>.flatten(x)</span>
<span id="cb21-14"><a href="#cb21-14" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.flatten(<span class="va">self</span>.sequential(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The <code>class</code> statement identifies the code chunk as a declaration for a class <code>HittersModel</code> that inherits from the base class <code>nn.Module</code>. This base class is ubiquitous in <code>torch</code> and represents the mappings in the neural networks.</p>
<p>Indented beneath the <code>class</code> statement are the methods of this class: in this case <code>__init__</code> and <code>forward</code>. The <code>__init__</code> method is called when an instance of the class is created as in the cell below. In the methods, <code>self</code> always refers to an instance of the class. In the <code>__init__</code> method, we have attached two objects to <code>self</code> as attributes: <code>flatten</code> and <code>sequential</code>. These are used in the <code>forward</code> method to describe the map that this module implements.</p>
<p>There is one additional line in the <code>__init__</code> method, which is a call to <code>super()</code>. This function allows subclasses (i.e.&nbsp;<code>HittersModel</code>) to access methods of the class they inherit from. For example, the class <code>nn.Module</code> has its own <code>__init__</code> method, which is different from the <code>HittersModel.__init__()</code> method we’ve written above. Using <code>super()</code> allows us to call the method of the base class. For <code>torch</code> models, we will always be making this <code>super()</code> call as it is necessary for the model to be properly interpreted by <code>torch</code>.</p>
<p>The object <code>nn.Module</code> has more methods than simply <code>__init__</code> and <code>forward</code>. These methods are directly accessible to <code>HittersModel</code> instances because of this inheritance. One such method we will see shortly is the <code>eval()</code> method, used to disable dropout for when we want to evaluate the model on test data.</p>
<div id="ad7a9aa0" class="cell" data-execution_count="19">
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a>hit_model <span class="op">=</span> HittersModel(X.shape[<span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The object <code>self.sequential</code> is a composition of four maps. The first maps the 19 features of <code>Hitters</code> to 50 dimensions, introducing <span class="math inline">50\times 19+50</span> parameters for the weights and <em>intercept</em> of the map (often called the <em>bias</em>). This layer is then mapped to a ReLU layer followed by a 40% dropout layer, and finally a linear map down to 1 dimension, again with a bias. The total number of trainable parameters is therefore <span class="math inline">50\times 19+50+50+1=1051</span>.</p>
<p>The package <code>torchinfo</code> provides a <code>summary()</code> function that neatly summarizes this information. We specify the size of the input and see the size of each tensor as it passes through layers of the network.</p>
<div id="4fb6a149" class="cell" data-execution_count="20">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>summary(hit_model, </span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>        input_size<span class="op">=</span>X_train.shape,</span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/home/oren/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116: UserWarning: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility (Triggered internally at ../aten/src/ATen/Context.cpp:185.)
  return F.linear(input, self.weight, self.bias)</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="20">
<pre><code>===================================================================================================================
Layer (type:depth-idx)                   Input Shape               Output Shape              Param #
===================================================================================================================
HittersModel                             [175, 19]                 [175]                     --
├─Flatten: 1-1                           [175, 19]                 [175, 19]                 --
├─Sequential: 1-2                        [175, 19]                 [175, 1]                  --
│    └─Linear: 2-1                       [175, 19]                 [175, 50]                 1,000
│    └─ReLU: 2-2                         [175, 50]                 [175, 50]                 --
│    └─Dropout: 2-3                      [175, 50]                 [175, 50]                 --
│    └─Linear: 2-4                       [175, 50]                 [175, 1]                  51
===================================================================================================================
Total params: 1,051
Trainable params: 1,051
Non-trainable params: 0
Total mult-adds (M): 0.18
===================================================================================================================
Input size (MB): 0.01
Forward/backward pass size (MB): 0.07
Params size (MB): 0.00
Estimated Total Size (MB): 0.09
===================================================================================================================</code></pre>
</div>
</div>
<p>We have truncated the end of the output slightly, here and in subsequent uses.</p>
<p>We now need to transform our training data into a form accessible to <code>torch</code>. The basic datatype in <code>torch</code> is a <code>tensor</code>, which is very similar to an <code>ndarray</code> from early chapters. We also note here that <code>torch</code> typically works with 32-bit (<em>single precision</em>) rather than 64-bit (<em>double precision</em>) floating point numbers. We therefore convert our data to <code>np.float32</code> before forming the tensor. The <span class="math inline">X</span> and <span class="math inline">Y</span> tensors are then arranged into a <code>Dataset</code> recognized by <code>torch</code> using <code>TensorDataset()</code>.</p>
<div id="c98a0f88" class="cell" data-execution_count="21">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>X_train_t <span class="op">=</span> torch.tensor(X_train.astype(np.float32))</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>Y_train_t <span class="op">=</span> torch.tensor(Y_train.astype(np.float32))</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>hit_train <span class="op">=</span> TensorDataset(X_train_t, Y_train_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We do the same for the test data.</p>
<div id="f13c9e33" class="cell" data-execution_count="22">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>X_test_t <span class="op">=</span> torch.tensor(X_test.astype(np.float32))</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>Y_test_t <span class="op">=</span> torch.tensor(Y_test.astype(np.float32))</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>hit_test <span class="op">=</span> TensorDataset(X_test_t, Y_test_t)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, this dataset is passed to a <code>DataLoader()</code> which ultimately passes data into our network. While this may seem like a lot of overhead, this structure is helpful for more complex tasks where data may live on different machines, or where data must be passed to a GPU. We provide a helper function <code>SimpleDataModule()</code> in <code>ISLP</code> to make this task easier for standard usage. One of its arguments is <code>num_workers</code>, which indicates how many processes we will use for loading the data. For small data like <code>Hitters</code> this will have little effect, but it does provide an advantage for the <code>MNIST</code> and <code>CIFAR100</code> examples below. The <code>torch</code> package will inspect the process running and determine a maximum number of workers. {This depends on the computing hardware and the number of cores available.} We’ve included a function <code>rec_num_workers()</code> to compute this so we know how many workers might be reasonable (here the max was 16).</p>
<div id="e29d792f" class="cell" data-execution_count="23">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>max_num_workers <span class="op">=</span> rec_num_workers()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The general training setup in <code>pytorch_lightning</code> involves training, validation and test data. These are each represented by different data loaders. During each epoch, we run a training step to learn the model and a validation step to track the error. The test data is typically used at the end of training to evaluate the model.</p>
<p>In this case, as we had split only into test and training, we’ll use the test data as validation data with the argument <code>validation=hit_test</code>. The <code>validation</code> argument can be a float between 0 and 1, an integer, or a <code>Dataset</code>. If a float (respectively, integer), it is interpreted as a percentage (respectively number) of the <em>training</em> observations to be used for validation. If it is a <code>Dataset</code>, it is passed directly to a data loader.</p>
<div id="8a642abd" class="cell" data-execution_count="24">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>hit_dm <span class="op">=</span> SimpleDataModule(hit_train,</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>                          hit_test,</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>                          batch_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>                          num_workers<span class="op">=</span><span class="bu">min</span>(<span class="dv">4</span>, max_num_workers),</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>                          validation<span class="op">=</span>hit_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we must provide a <code>pytorch_lightning</code> module that controls the steps performed during the training process. We provide methods for our <code>SimpleModule()</code> that simply record the value of the loss function and any additional metrics at the end of each epoch. These operations are controlled by the methods <code>SimpleModule.[training/test/validation]_step()</code>, though we will not be modifying these in our examples.</p>
<div id="160ac5e6" class="cell" data-execution_count="25">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>hit_module <span class="op">=</span> SimpleModule.regression(hit_model,</span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>                           metrics<span class="op">=</span>{<span class="st">'mae'</span>:MeanAbsoluteError()})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>By using the <code>SimpleModule.regression()</code> method, we indicate that we will use squared-error loss as in (). We have also asked for mean absolute error to be tracked as well in the metrics that are logged.</p>
<p>We log our results via <code>CSVLogger()</code>, which in this case stores the results in a CSV file within a directory <code>logs/hitters</code>. After the fitting is complete, this allows us to load the results as a <code>pd.DataFrame()</code> and visualize them below. There are several ways to log the results within <code>pytorch_lightning</code>, though we will not cover those here in detail.</p>
<div id="7f11abb5" class="cell" data-execution_count="26">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>hit_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'hitters'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally we are ready to train our model and log the results. We use the <code>Trainer()</code> object from <code>pytorch_lightning</code> to do this work. The argument <code>datamodule=hit_dm</code> tells the trainer how training/validation/test logs are produced, while the first argument <code>hit_module</code> specifies the network architecture as well as the training/validation/test steps. The <code>callbacks</code> argument allows for several tasks to be carried out at various points while training a model. Here our <code>ErrorTracker()</code> callback will enable us to compute validation error while training and, finally, the test error. We now fit the model for 50 epochs.</p>
<div id="cff11aae" class="cell" data-execution_count="27">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a>hit_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>                      max_epochs<span class="op">=</span><span class="dv">50</span>,</span>
<span id="cb32-3"><a href="#cb32-3" aria-hidden="true" tabindex="-1"></a>                      log_every_n_steps<span class="op">=</span><span class="dv">5</span>,</span>
<span id="cb32-4"><a href="#cb32-4" aria-hidden="true" tabindex="-1"></a>                      logger<span class="op">=</span>hit_logger,</span>
<span id="cb32-5"><a href="#cb32-5" aria-hidden="true" tabindex="-1"></a>                      callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb32-6"><a href="#cb32-6" aria-hidden="true" tabindex="-1"></a>hit_trainer.fit(hit_module, datamodule<span class="op">=</span>hit_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
You are using a CUDA device ('NVIDIA GeForce RTX 3070 Laptop GPU') that has Tensor Cores. To properly utilize them, you should set `torch.set_float32_matmul_precision('medium' | 'high')` which will trade-off precision for performance. For more details, read https://pytorch.org/docs/stable/generated/torch.set_float32_matmul_precision.html#torch.set_float32_matmul_precision
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type         | Params
---------------------------------------
0 | model | HittersModel | 1.1 K 
1 | loss  | MSELoss      | 0     
---------------------------------------
1.1 K     Trainable params
0         Non-trainable params
1.1 K     Total params
0.004     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Sanity Checking: |          | 0/? [00:00&lt;?, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[27], line 6</span>
<span class="ansi-green-fg ansi-bold">      1</span> hit_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                       max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">50</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                       log_every_n_steps<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">5</span>,
<span class="ansi-green-fg ansi-bold">      4</span>                       logger<span style="color:rgb(98,98,98)">=</span>hit_logger,
<span class="ansi-green-fg ansi-bold">      5</span>                       callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 6</span> <span class="ansi-yellow-bg">hit_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">hit_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">hit_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1031</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1029</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training:
<span class="ansi-green-fg ansi-bold">   1030</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> isolate_rng():
<span class="ansi-green-fg">-&gt; 1031</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_sanity_check</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg ansi-bold">   1033</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fit_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1060</span>, in <span class="ansi-cyan-fg">Trainer._run_sanity_check</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1057</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_start</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1059</span> <span style="font-style:italic;color:rgb(95,135,135)"># run eval step</span>
<span class="ansi-green-fg">-&gt; 1060</span> <span class="ansi-yellow-bg">val_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1062</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_end</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1064</span> <span style="font-style:italic;color:rgb(95,135,135)"># reset logger connector</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:261</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_validation_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    254</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_validation_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    255</span>                               trainer,
<span class="ansi-green-fg ansi-bold">    256</span>                               pl_module,
<span class="ansi-green-fg ansi-bold">    257</span>                               batch,
<span class="ansi-green-fg ansi-bold">    258</span>                               batch_idx,
<span class="ansi-green-fg ansi-bold">    259</span>                               dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    260</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 261</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    262</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[18], line 14</span>, in <span class="ansi-cyan-fg">HittersModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     12</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg ansi-bold">     13</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>flatten(x)
<span class="ansi-green-fg">---&gt; 14</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sequential</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/container.py:217</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    215</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg ansi-bold">    216</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg">--&gt; 217</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    218</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>At each step of SGD, the algorithm randomly selects 32 training observations for the computation of the gradient. Recall from Section~ that an epoch amounts to the number of SGD steps required to process <span class="math inline">n</span> observations. Since the training set has <span class="math inline">n=175</span>, and we specified a <code>batch_size</code> of 32 in the construction of <code>hit_dm</code>, an epoch is <span class="math inline">175/32=5.5</span> SGD steps.</p>
<p>After having fit the model, we can evaluate performance on our test data using the <code>test()</code> method of our trainer.</p>
<div id="cf84890a" class="cell" data-execution_count="28">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a>hit_trainer.test(hit_module, datamodule<span class="op">=</span>hit_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>Testing: |          | 0/? [00:00&lt;?, ?it/s]</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[28], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">hit_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">test</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">hit_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">hit_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:754</span>, in <span class="ansi-cyan-fg">Trainer.test</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    752</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    753</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>testing <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 754</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    755</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_test_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">verbose</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span>
<span class="ansi-green-fg ansi-bold">    756</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:794</span>, in <span class="ansi-cyan-fg">Trainer._test_impl</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    790</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    791</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    792</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn, ckpt_path, model_provided<span style="color:rgb(98,98,98)">=</span>model_provided, model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    793</span> )
<span class="ansi-green-fg">--&gt; 794</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    795</span> <span style="font-style:italic;color:rgb(95,135,135)"># remove the tensors from the test results</span>
<span class="ansi-green-fg ansi-bold">    796</span> results <span style="color:rgb(98,98,98)">=</span> convert_tensors_to_scalars(results)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1026</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1023</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>zero_grad(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>zero_grad_kwargs)
<span class="ansi-green-fg ansi-bold">   1025</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>evaluating:
<span class="ansi-green-fg">-&gt; 1026</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1027</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predicting:
<span class="ansi-green-fg ansi-bold">   1028</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predict_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:297</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_test_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    290</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_test_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    291</span>                         trainer,
<span class="ansi-green-fg ansi-bold">    292</span>                         pl_module,
<span class="ansi-green-fg ansi-bold">    293</span>                         batch,
<span class="ansi-green-fg ansi-bold">    294</span>                         batch_idx,
<span class="ansi-green-fg ansi-bold">    295</span>                         dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    296</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 297</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    298</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[18], line 14</span>, in <span class="ansi-cyan-fg">HittersModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     12</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg ansi-bold">     13</span>     x <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>flatten(x)
<span class="ansi-green-fg">---&gt; 14</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">sequential</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/container.py:217</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    215</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg ansi-bold">    216</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg">--&gt; 217</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    218</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>The results of the fit have been logged into a CSV file. We can find the results specific to this run in the <code>experiment.metrics_file_path</code> attribute of our logger. Note that each time the model is fit, the logger will output results into a new subdirectory of our directory <code>logs/hitters</code>.</p>
<p>We now create a plot of the MAE (mean absolute error) as a function of the number of epochs. First we retrieve the logged summaries.</p>
<div id="4b484015" class="cell" data-execution_count="29">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>hit_results <span class="op">=</span> pd.read_csv(hit_logger.experiment.metrics_file_path)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[29], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> hit_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">hit_logger</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">experiment</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">metrics_file_path</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg ansi-bold">   1013</span> kwds_defaults <span style="color:rgb(98,98,98)">=</span> _refine_defaults_read(
<span class="ansi-green-fg ansi-bold">   1014</span>     dialect,
<span class="ansi-green-fg ansi-bold">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1022</span>     dtype_backend<span style="color:rgb(98,98,98)">=</span>dtype_backend,
<span class="ansi-green-fg ansi-bold">   1023</span> )
<span class="ansi-green-fg ansi-bold">   1024</span> kwds<span style="color:rgb(98,98,98)">.</span>update(kwds_defaults)
<span class="ansi-green-fg">-&gt; 1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg ansi-bold">    617</span> _validate_names(kwds<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">names</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg ansi-bold">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; 620</span> parser <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg ansi-bold">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg ansi-bold">   1617</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>options[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> kwds[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">   1619</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles: IOHandles <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; 1620</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg ansi-bold">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg ansi-bold">   1879</span>         mode <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">-&gt; 1880</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">compression</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">memory_map</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding_errors</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">strict</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">storage_options</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1891</span> f <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles<span style="color:rgb(98,98,98)">.</span>handle

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg ansi-bold">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg ansi-bold">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg ansi-bold">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg ansi-bold">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs<span style="color:rgb(98,98,98)">.</span>encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs<span style="color:rgb(98,98,98)">.</span>mode:
<span class="ansi-green-fg ansi-bold">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; 873</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg ansi-bold">    882</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">open</span>(handle, ioargs<span style="color:rgb(98,98,98)">.</span>mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'logs/hitters/version_1/metrics.csv'</pre>
</div>
</div>
</div>
<p>Since we will produce similar plots in later examples, we write a simple generic function to produce this plot.</p>
<div id="90320d9e" class="cell" data-execution_count="30">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="kw">def</span> summary_plot(results,</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>                 ax,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>                 col<span class="op">=</span><span class="st">'loss'</span>,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>                 valid_legend<span class="op">=</span><span class="st">'Validation'</span>,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>                 training_legend<span class="op">=</span><span class="st">'Training'</span>,</span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>                 ylabel<span class="op">=</span><span class="st">'Loss'</span>,</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>                 fontsize<span class="op">=</span><span class="dv">20</span>):</span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (column,</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>         color,</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>         label) <span class="kw">in</span> <span class="bu">zip</span>([<span class="ss">f'train_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">_epoch'</span>,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>                        <span class="ss">f'valid_</span><span class="sc">{</span>col<span class="sc">}</span><span class="ss">'</span>],</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>                       [<span class="st">'black'</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>                        <span class="st">'red'</span>],</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>                       [training_legend,</span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>                        valid_legend]):</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        results.plot(x<span class="op">=</span><span class="st">'epoch'</span>,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>                     y<span class="op">=</span>column,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>                     label<span class="op">=</span>label,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>                     marker<span class="op">=</span><span class="st">'o'</span>,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>                     color<span class="op">=</span>color,</span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>                     ax<span class="op">=</span>ax)</span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    ax.set_xlabel(<span class="st">'Epoch'</span>)</span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    ax.set_ylabel(ylabel)</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">return</span> ax</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now set up our axes, and use our function to produce the MAE plot.</p>
<div id="22d6df8f" class="cell" data-execution_count="31">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>ax <span class="op">=</span> summary_plot(hit_results,</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>                  ax,</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>                  col<span class="op">=</span><span class="st">'mae'</span>,</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>                  ylabel<span class="op">=</span><span class="st">'MAE'</span>,</span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>                  valid_legend<span class="op">=</span><span class="st">'Validation (=Test)'</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="dv">0</span>, <span class="dv">400</span>])</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">50</span>, <span class="dv">11</span>).astype(<span class="bu">int</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[31], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> fig, ax <span style="color:rgb(98,98,98)">=</span> subplots(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>, figsize<span style="color:rgb(98,98,98)">=</span>(<span style="color:rgb(98,98,98)">6</span>, <span style="color:rgb(98,98,98)">6</span>))
<span class="ansi-green-fg">----&gt; 2</span> ax <span style="color:rgb(98,98,98)">=</span> summary_plot(<span class="ansi-yellow-bg">hit_results</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                   ax,
<span class="ansi-green-fg ansi-bold">      4</span>                   col<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">mae</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      5</span>                   ylabel<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">MAE</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      6</span>                   valid_legend<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Validation (=Test)</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">      7</span> ax<span style="color:rgb(98,98,98)">.</span>set_ylim([<span style="color:rgb(98,98,98)">0</span>, <span style="color:rgb(98,98,98)">400</span>])
<span class="ansi-green-fg ansi-bold">      8</span> ax<span style="color:rgb(98,98,98)">.</span>set_xticks(np<span style="color:rgb(98,98,98)">.</span>linspace(<span style="color:rgb(98,98,98)">0</span>, <span style="color:rgb(98,98,98)">50</span>, <span style="color:rgb(98,98,98)">11</span>)<span style="color:rgb(98,98,98)">.</span>astype(<span style="color:rgb(0,135,0)">int</span>));

<span class="ansi-red-fg">NameError</span>: name 'hit_results' is not defined</pre>
</div>
</div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="Ch10-deeplearning-lab_files/figure-html/cell-32-output-2.png" class="lightbox" data-gallery="quarto-lightbox-gallery-2"><img src="Ch10-deeplearning-lab_files/figure-html/cell-32-output-2.png" width="507" height="490" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>We can predict directly from the final model, and evaluate its performance on the test data. Before fitting, we call the <code>eval()</code> method of <code>hit_model</code>. This tells <code>torch</code> to effectively consider this model to be fitted, so that we can use it to predict on new data. For our model here, the biggest change is that the dropout layers will be turned off, i.e.&nbsp;no weights will be randomly dropped in predicting on new data.</p>
<div id="6e816e97" class="cell" data-execution_count="32">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a>hit_model.<span class="bu">eval</span>() </span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>preds <span class="op">=</span> hit_module(X_test_t)</span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>torch.<span class="bu">abs</span>(Y_test_t <span class="op">-</span> preds).mean()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="32">
<pre><code>tensor(711.3991, grad_fn=&lt;MeanBackward0&gt;)</code></pre>
</div>
</div>
</section>
<section id="cleanup" class="level3">
<h3 class="anchored" data-anchor-id="cleanup">Cleanup</h3>
<p>In setting up our data module, we had initiated several worker processes that will remain running. We delete all references to the torch objects to ensure these processes will be killed.</p>
<div id="68d4f585" class="cell" data-execution_count="33">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(Hitters,</span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a>    hit_model, hit_dm,</span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a>    hit_logger,</span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a>    hit_test, hit_train,</span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>    X, Y,</span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>    X_test, X_train,</span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>    Y_test, Y_train,</span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>    X_test_t, Y_test_t,</span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>    hit_trainer, hit_module)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="multilayer-network-on-the-mnist-digit-data" class="level2">
<h2 class="anchored" data-anchor-id="multilayer-network-on-the-mnist-digit-data">Multilayer Network on the MNIST Digit Data</h2>
<p>The <code>torchvision</code> package comes with a number of example datasets, including the <code>MNIST</code> digit data. Our first step is to retrieve the training and test data sets; the <code>MNIST()</code> function within <code>torchvision.datasets</code> is provided for this purpose. The data will be downloaded the first time this function is executed, and stored in the directory <code>data/MNIST</code>.</p>
<div id="cc2dffeb" class="cell" data-execution_count="34">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>(mnist_train, </span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a> mnist_test) <span class="op">=</span> [MNIST(root<span class="op">=</span><span class="st">'data'</span>,</span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a>                      train<span class="op">=</span>train,</span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a>                      download<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a>                      transform<span class="op">=</span>ToTensor())</span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>                <span class="cf">for</span> train <span class="kw">in</span> [<span class="va">True</span>, <span class="va">False</span>]]</span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>mnist_train</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="34">
<pre><code>Dataset MNIST
    Number of datapoints: 60000
    Root location: data
    Split: Train
    StandardTransform
Transform: ToTensor()</code></pre>
</div>
</div>
<p>There are 60,000 images in the training data and 10,000 in the test data. The images are <span class="math inline">28\times 28</span>, and stored as a matrix of pixels. We need to transform each one into a vector.</p>
<p>Neural networks are somewhat sensitive to the scale of the inputs, much as ridge and lasso regularization are affected by scaling. Here the inputs are eight-bit grayscale values between 0 and 255, so we rescale to the unit interval. {Note: eight bits means <span class="math inline">2^8</span>, which equals 256. Since the convention is to start at <span class="math inline">0</span>, the possible values range from <span class="math inline">0</span> to <span class="math inline">255</span>.} This transformation, along with some reordering of the axes, is performed by the <code>ToTensor()</code> transform from the <code>torchvision.transforms</code> package.</p>
<p>As in our <code>Hitters</code> example, we form a data module from the training and test datasets, setting aside 20% of the training images for validation.</p>
<div id="178af211" class="cell" data-execution_count="35">
<div class="sourceCode cell-code" id="cb46"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb46-1"><a href="#cb46-1" aria-hidden="true" tabindex="-1"></a>mnist_dm <span class="op">=</span> SimpleDataModule(mnist_train,</span>
<span id="cb46-2"><a href="#cb46-2" aria-hidden="true" tabindex="-1"></a>                            mnist_test,</span>
<span id="cb46-3"><a href="#cb46-3" aria-hidden="true" tabindex="-1"></a>                            validation<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb46-4"><a href="#cb46-4" aria-hidden="true" tabindex="-1"></a>                            num_workers<span class="op">=</span>max_num_workers,</span>
<span id="cb46-5"><a href="#cb46-5" aria-hidden="true" tabindex="-1"></a>                            batch_size<span class="op">=</span><span class="dv">256</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Let’s take a look at the data that will get fed into our network. We loop through the first few chunks of the test dataset, breaking after 2 batches:</p>
<div id="a70bb257" class="cell" data-execution_count="36">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (X_ ,Y_) <span class="kw">in</span> <span class="bu">enumerate</span>(mnist_dm.train_dataloader()):</span>
<span id="cb47-2"><a href="#cb47-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'X: '</span>, X_.shape)</span>
<span id="cb47-3"><a href="#cb47-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Y: '</span>, Y_.shape)</span>
<span id="cb47-4"><a href="#cb47-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&gt;=</span> <span class="dv">1</span>:</span>
<span id="cb47-5"><a href="#cb47-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X:  torch.Size([256, 1, 28, 28])
Y:  torch.Size([256])
X:  torch.Size([256, 1, 28, 28])
Y:  torch.Size([256])</code></pre>
</div>
</div>
<p>We see that the <span class="math inline">X</span> for each batch consists of 256 images of size <code>1x28x28</code>. Here the <code>1</code> indicates a single channel (greyscale). For RGB images such as <code>CIFAR100</code> below, we will see that the <code>1</code> in the size will be replaced by <code>3</code> for the three RGB channels.</p>
<p>Now we are ready to specify our neural network.</p>
<div id="22fa76c4" class="cell" data-execution_count="37">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MNISTModel(nn.Module):</span>
<span id="cb49-2"><a href="#cb49-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb49-3"><a href="#cb49-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(MNISTModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb49-4"><a href="#cb49-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layer1 <span class="op">=</span> nn.Sequential(</span>
<span id="cb49-5"><a href="#cb49-5" aria-hidden="true" tabindex="-1"></a>            nn.Flatten(),</span>
<span id="cb49-6"><a href="#cb49-6" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">28</span><span class="op">*</span><span class="dv">28</span>, <span class="dv">256</span>),</span>
<span id="cb49-7"><a href="#cb49-7" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb49-8"><a href="#cb49-8" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.4</span>))</span>
<span id="cb49-9"><a href="#cb49-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.layer2 <span class="op">=</span> nn.Sequential(</span>
<span id="cb49-10"><a href="#cb49-10" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">256</span>, <span class="dv">128</span>),</span>
<span id="cb49-11"><a href="#cb49-11" aria-hidden="true" tabindex="-1"></a>            nn.ReLU(),</span>
<span id="cb49-12"><a href="#cb49-12" aria-hidden="true" tabindex="-1"></a>            nn.Dropout(<span class="fl">0.3</span>))</span>
<span id="cb49-13"><a href="#cb49-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._forward <span class="op">=</span> nn.Sequential(</span>
<span id="cb49-14"><a href="#cb49-14" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layer1,</span>
<span id="cb49-15"><a href="#cb49-15" aria-hidden="true" tabindex="-1"></a>            <span class="va">self</span>.layer2,</span>
<span id="cb49-16"><a href="#cb49-16" aria-hidden="true" tabindex="-1"></a>            nn.Linear(<span class="dv">128</span>, <span class="dv">10</span>))</span>
<span id="cb49-17"><a href="#cb49-17" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb49-18"><a href="#cb49-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>._forward(x)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that in the first layer, each <code>1x28x28</code> image is flattened, then mapped to 256 dimensions where we apply a ReLU activation with 40% dropout. A second layer maps the first layer’s output down to 128 dimensions, applying a ReLU activation with 30% dropout. Finally, the 128 dimensions are mapped down to 10, the number of classes in the <code>MNIST</code> data.</p>
<div id="a513a3b5" class="cell" data-execution_count="38">
<div class="sourceCode cell-code" id="cb50"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb50-1"><a href="#cb50-1" aria-hidden="true" tabindex="-1"></a>mnist_model <span class="op">=</span> MNISTModel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can check that the model produces output of expected size based on our existing batch <code>X_</code> above.</p>
<div id="d6f096e4" class="cell" data-execution_count="39">
<div class="sourceCode cell-code" id="cb51"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb51-1"><a href="#cb51-1" aria-hidden="true" tabindex="-1"></a>mnist_model(X_).size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="39">
<pre><code>torch.Size([256, 10])</code></pre>
</div>
</div>
<p>Let’s take a look at the summary of the model. Instead of an <code>input_size</code> we can pass a tensor of correct shape. In this case, we pass through the final batched <code>X_</code> from above.</p>
<div id="54c3c259" class="cell" data-execution_count="40">
<div class="sourceCode cell-code" id="cb53"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb53-1"><a href="#cb53-1" aria-hidden="true" tabindex="-1"></a>summary(mnist_model,</span>
<span id="cb53-2"><a href="#cb53-2" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>X_,</span>
<span id="cb53-3"><a href="#cb53-3" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb53-4"><a href="#cb53-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb53-5"><a href="#cb53-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="40">
<pre><code>===================================================================================================================
Layer (type:depth-idx)                   Input Shape               Output Shape              Param #
===================================================================================================================
MNISTModel                               [256, 1, 28, 28]          [256, 10]                 --
├─Sequential: 1-1                        [256, 1, 28, 28]          [256, 10]                 --
│    └─Sequential: 2-1                   [256, 1, 28, 28]          [256, 256]                --
│    │    └─Flatten: 3-1                 [256, 1, 28, 28]          [256, 784]                --
│    │    └─Linear: 3-2                  [256, 784]                [256, 256]                200,960
│    │    └─ReLU: 3-3                    [256, 256]                [256, 256]                --
│    │    └─Dropout: 3-4                 [256, 256]                [256, 256]                --
│    └─Sequential: 2-2                   [256, 256]                [256, 128]                --
│    │    └─Linear: 3-5                  [256, 256]                [256, 128]                32,896
│    │    └─ReLU: 3-6                    [256, 128]                [256, 128]                --
│    │    └─Dropout: 3-7                 [256, 128]                [256, 128]                --
│    └─Linear: 2-3                       [256, 128]                [256, 10]                 1,290
===================================================================================================================
Total params: 235,146
Trainable params: 235,146
Non-trainable params: 0
Total mult-adds (M): 60.20
===================================================================================================================
Input size (MB): 0.80
Forward/backward pass size (MB): 0.81
Params size (MB): 0.94
Estimated Total Size (MB): 2.55
===================================================================================================================</code></pre>
</div>
</div>
<p>Having set up both the model and the data module, fitting this model is now almost identical to the <code>Hitters</code> example. In contrast to our regression model, here we will use the <code>SimpleModule.classification()</code> method which uses the cross-entropy loss function instead of mean squared error. It must be supplied with the number of classes in the problem.</p>
<div id="1c80aab8" class="cell" data-execution_count="41">
<div class="sourceCode cell-code" id="cb55"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb55-1"><a href="#cb55-1" aria-hidden="true" tabindex="-1"></a>mnist_module <span class="op">=</span> SimpleModule.classification(mnist_model,</span>
<span id="cb55-2"><a href="#cb55-2" aria-hidden="true" tabindex="-1"></a>                                           num_classes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb55-3"><a href="#cb55-3" aria-hidden="true" tabindex="-1"></a>mnist_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'MNIST'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Now we are ready to go. The final step is to supply training data, and fit the model. We disable the progress bar below to avoid lengthy output in the browser when running.</p>
<div id="bf53b65a" class="cell" data-execution_count="42">
<div class="sourceCode cell-code" id="cb56"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb56-1"><a href="#cb56-1" aria-hidden="true" tabindex="-1"></a>mnist_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb56-2"><a href="#cb56-2" aria-hidden="true" tabindex="-1"></a>                        max_epochs<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb56-3"><a href="#cb56-3" aria-hidden="true" tabindex="-1"></a>                        logger<span class="op">=</span>mnist_logger,</span>
<span id="cb56-4"><a href="#cb56-4" aria-hidden="true" tabindex="-1"></a>                        enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb56-5"><a href="#cb56-5" aria-hidden="true" tabindex="-1"></a>                        callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb56-6"><a href="#cb56-6" aria-hidden="true" tabindex="-1"></a>mnist_trainer.fit(mnist_module,</span>
<span id="cb56-7"><a href="#cb56-7" aria-hidden="true" tabindex="-1"></a>                  datamodule<span class="op">=</span>mnist_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type             | Params
-------------------------------------------
0 | model | MNISTModel       | 235 K 
1 | loss  | CrossEntropyLoss | 0     
-------------------------------------------
235 K     Trainable params
0         Non-trainable params
235 K     Total params
0.941     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[42], line 6</span>
<span class="ansi-green-fg ansi-bold">      1</span> mnist_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                         max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">30</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                         logger<span style="color:rgb(98,98,98)">=</span>mnist_logger,
<span class="ansi-green-fg ansi-bold">      4</span>                         enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      5</span>                         callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 6</span> <span class="ansi-yellow-bg">mnist_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mnist_module</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span class="ansi-yellow-bg">                  </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">mnist_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1033</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1031</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_run_sanity_check()
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg">-&gt; 1033</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1034</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1035</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Unexpected state </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:205</span>, in <span class="ansi-cyan-fg">_FitLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    203</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    204</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_start()
<span class="ansi-green-fg">--&gt; 205</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end()
<span class="ansi-green-fg ansi-bold">    207</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:363</span>, in <span class="ansi-cyan-fg">_FitLoop.advance</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    361</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_epoch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    362</span>     <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_data_fetcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 363</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">epoch_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_data_fetcher</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:140</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.run</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    138</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>done:
<span class="ansi-green-fg ansi-bold">    139</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 140</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">data_fetcher</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    141</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end(data_fetcher)
<span class="ansi-green-fg ansi-bold">    142</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:250</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.advance</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    247</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_batch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    248</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>automatic_optimization:
<span class="ansi-green-fg ansi-bold">    249</span>         <span style="font-style:italic;color:rgb(95,135,135)"># in automatic optimization, there can only be one optimizer</span>
<span class="ansi-green-fg">--&gt; 250</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">automatic_optimization</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizers</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    251</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    252</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>manual_optimization<span style="color:rgb(98,98,98)">.</span>run(kwargs)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:190</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization.run</span><span class="ansi-blue-fg">(self, optimizer, batch_idx, kwargs)</span>
<span class="ansi-green-fg ansi-bold">    183</span>         closure()
<span class="ansi-green-fg ansi-bold">    185</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    186</span> <span style="font-style:italic;color:rgb(95,135,135)"># BACKWARD PASS</span>
<span class="ansi-green-fg ansi-bold">    187</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    188</span> <span style="font-style:italic;color:rgb(95,135,135)"># gradient update with accumulated gradients</span>
<span class="ansi-green-fg ansi-bold">    189</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">--&gt; 190</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    192</span> result <span style="color:rgb(98,98,98)">=</span> closure<span style="color:rgb(98,98,98)">.</span>consume_result()
<span class="ansi-green-fg ansi-bold">    193</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> result<span style="color:rgb(98,98,98)">.</span>loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:268</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._optimizer_step</span><span class="ansi-blue-fg">(self, batch_idx, train_step_and_backward_closure)</span>
<span class="ansi-green-fg ansi-bold">    265</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_ready()
<span class="ansi-green-fg ansi-bold">    267</span> <span style="font-style:italic;color:rgb(95,135,135)"># model hook</span>
<span class="ansi-green-fg">--&gt; 268</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_lightning_module_hook</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">optimizer_step</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">current_epoch</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">train_step_and_backward_closure</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    277</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> should_accumulate:
<span class="ansi-green-fg ansi-bold">    278</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_completed()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:157</span>, in <span class="ansi-cyan-fg">_call_lightning_module_hook</span><span class="ansi-blue-fg">(trainer, hook_name, pl_module, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    154</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> hook_name
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[LightningModule]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>pl_module<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 157</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    159</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    160</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1303</span>, in <span class="ansi-cyan-fg">LightningModule.optimizer_step</span><span class="ansi-blue-fg">(self, epoch, batch_idx, optimizer, optimizer_closure)</span>
<span class="ansi-green-fg ansi-bold">   1264</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">optimizer_step</span>(
<span class="ansi-green-fg ansi-bold">   1265</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">   1266</span>     epoch: <span style="color:rgb(0,135,0)">int</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1269</span>     optimizer_closure: Optional[Callable[[], Any]] <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">   1270</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">   1271</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Override this method to adjust the default way the :class:`~pytorch_lightning.trainer.trainer.Trainer` calls</span>
<span class="ansi-green-fg ansi-bold">   1272</span> <span style="font-style:italic;color:rgb(175,0,0)">    the optimizer.</span>
<span class="ansi-green-fg ansi-bold">   1273</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1301</span> 
<span class="ansi-green-fg ansi-bold">   1302</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">-&gt; 1303</span>     <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">optimizer_closure</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/optimizer.py:152</span>, in <span class="ansi-cyan-fg">LightningOptimizer.step</span><span class="ansi-blue-fg">(self, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    149</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> MisconfigurationException(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">When `optimizer.step(closure)` is called, the closure should be callable</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    151</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_strategy <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 152</span> step_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_strategy</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    154</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_on_after_step()
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:239</span>, in <span class="ansi-cyan-fg">Strategy.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, closure, model, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    237</span> <span style="font-style:italic;color:rgb(95,135,135)"># TODO(fabric): remove assertion once strategy's optimizer_step typing is fixed</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">isinstance</span>(model, pl<span style="color:rgb(98,98,98)">.</span>LightningModule)
<span class="ansi-green-fg">--&gt; 239</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:122</span>, in <span class="ansi-cyan-fg">Precision.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, model, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    120</span> <span style="font-style:italic;color:rgb(175,0,0)">"""Hook to run the optimizer step."""</span>
<span class="ansi-green-fg ansi-bold">    121</span> closure <span style="color:rgb(98,98,98)">=</span> partial(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_wrap_closure, model, optimizer, closure)
<span class="ansi-green-fg">--&gt; 122</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:391</span>, in <span class="ansi-cyan-fg">Optimizer.profile_hook_step.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    386</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    387</span>             <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(
<span class="ansi-green-fg ansi-bold">    388</span>                 <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>func<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> must return None or a tuple of (new_args, new_kwargs), but got </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>result<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    389</span>             )
<span class="ansi-green-fg">--&gt; 391</span> out <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    392</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_optimizer_step_code()
<span class="ansi-green-fg ansi-bold">    394</span> <span style="font-style:italic;color:rgb(95,135,135)"># call optimizer step post hooks</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:76</span>, in <span class="ansi-cyan-fg">_use_grad_for_differentiable.&lt;locals&gt;._use_grad</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     74</span>     torch<span style="color:rgb(98,98,98)">.</span>set_grad_enabled(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>defaults[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">differentiable</span><span style="color:rgb(175,0,0)">'</span>])
<span class="ansi-green-fg ansi-bold">     75</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()
<span class="ansi-green-fg">---&gt; 76</span>     ret <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     77</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">     78</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/rmsprop.py:109</span>, in <span class="ansi-cyan-fg">RMSprop.step</span><span class="ansi-blue-fg">(self, closure)</span>
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> closure <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    108</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>enable_grad():
<span class="ansi-green-fg">--&gt; 109</span>         loss <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    111</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> group <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>param_groups:
<span class="ansi-green-fg ansi-bold">    112</span>     params_with_grad <span style="color:rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:108</span>, in <span class="ansi-cyan-fg">Precision._wrap_closure</span><span class="ansi-blue-fg">(self, model, optimizer, closure)</span>
<span class="ansi-green-fg ansi-bold">     95</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">_wrap_closure</span>(
<span class="ansi-green-fg ansi-bold">     96</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">     97</span>     model: <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">pl.LightningModule</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">     98</span>     optimizer: Optimizer,
<span class="ansi-green-fg ansi-bold">     99</span>     closure: Callable[[], Any],
<span class="ansi-green-fg ansi-bold">    100</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Any:
<span class="ansi-green-fg ansi-bold">    101</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""This double-closure allows makes sure the ``closure`` is executed before the ``on_before_optimizer_step``</span>
<span class="ansi-green-fg ansi-bold">    102</span> <span style="font-style:italic;color:rgb(175,0,0)">    hook is called.</span>
<span class="ansi-green-fg ansi-bold">    103</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    106</span> 
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 108</span>     closure_result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    109</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_after_closure(model, optimizer)
<span class="ansi-green-fg ansi-bold">    110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> closure_result

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:144</span>, in <span class="ansi-cyan-fg">Closure.__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    142</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">    143</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">__call__</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(98,98,98)">*</span>args: Any, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Optional[Tensor]:
<span class="ansi-green-fg">--&gt; 144</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    145</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result<span style="color:rgb(98,98,98)">.</span>loss

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/utils/_contextlib.py:115</span>, in <span class="ansi-cyan-fg">context_decorator.&lt;locals&gt;.decorate_context</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    112</span> <span style="color:rgb(175,0,255)">@functools</span><span style="color:rgb(98,98,98)">.</span>wraps(func)
<span class="ansi-green-fg ansi-bold">    113</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">decorate_context</span>(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">    114</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> ctx_factory():
<span class="ansi-green-fg">--&gt; 115</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:138</span>, in <span class="ansi-cyan-fg">Closure.closure</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    135</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_zero_grad_fn()
<span class="ansi-green-fg ansi-bold">    137</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> step_output<span style="color:rgb(98,98,98)">.</span>closure_loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 138</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_backward_fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">step_output</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    140</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:239</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._make_backward_fn.&lt;locals&gt;.backward_fn</span><span class="ansi-blue-fg">(loss)</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward_fn</span>(loss: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 239</span>     <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_strategy_hook</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">backward</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:309</span>, in <span class="ansi-cyan-fg">_call_strategy_hook</span><span class="ansi-blue-fg">(trainer, hook_name, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    306</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    308</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Strategy]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 309</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    311</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    312</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:213</span>, in <span class="ansi-cyan-fg">Strategy.backward</span><span class="ansi-blue-fg">(self, closure_loss, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    211</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>pre_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg">--&gt; 213</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    215</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg ansi-bold">    216</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:72</span>, in <span class="ansi-cyan-fg">Precision.backward</span><span class="ansi-blue-fg">(self, tensor, model, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     52</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">     53</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward</span>(  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[override]</span>
<span class="ansi-green-fg ansi-bold">     54</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     59</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any,
<span class="ansi-green-fg ansi-bold">     60</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     61</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Performs the actual backpropagation.</span>
<span class="ansi-green-fg ansi-bold">     62</span> 
<span class="ansi-green-fg ansi-bold">     63</span> <span style="font-style:italic;color:rgb(175,0,0)">    Args:</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     70</span> 
<span class="ansi-green-fg ansi-bold">     71</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">---&gt; 72</span>     <span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">tensor</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1090</span>, in <span class="ansi-cyan-fg">LightningModule.backward</span><span class="ansi-blue-fg">(self, loss, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1088</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_fabric<span style="color:rgb(98,98,98)">.</span>backward(loss, <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">   1089</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1090</span>     <span class="ansi-yellow-bg">loss</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/_tensor.py:525</span>, in <span class="ansi-cyan-fg">Tensor.backward</span><span class="ansi-blue-fg">(self, gradient, retain_graph, create_graph, inputs)</span>
<span class="ansi-green-fg ansi-bold">    515</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> has_torch_function_unary(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg ansi-bold">    516</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> handle_torch_function(
<span class="ansi-green-fg ansi-bold">    517</span>         Tensor<span style="color:rgb(98,98,98)">.</span>backward,
<span class="ansi-green-fg ansi-bold">    518</span>         (<span style="color:rgb(0,135,0)">self</span>,),
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    523</span>         inputs<span style="color:rgb(98,98,98)">=</span>inputs,
<span class="ansi-green-fg ansi-bold">    524</span>     )
<span class="ansi-green-fg">--&gt; 525</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">autograd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    526</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">gradient</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">inputs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">inputs</span>
<span class="ansi-green-fg ansi-bold">    527</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/__init__.py:267</span>, in <span class="ansi-cyan-fg">backward</span><span class="ansi-blue-fg">(tensors, grad_tensors, retain_graph, create_graph, grad_variables, inputs)</span>
<span class="ansi-green-fg ansi-bold">    262</span>     retain_graph <span style="color:rgb(98,98,98)">=</span> create_graph
<span class="ansi-green-fg ansi-bold">    264</span> <span style="font-style:italic;color:rgb(95,135,135)"># The reason we repeat the same comment below is that</span>
<span class="ansi-green-fg ansi-bold">    265</span> <span style="font-style:italic;color:rgb(95,135,135)"># some Python versions print out the first line of a multi-line function</span>
<span class="ansi-green-fg ansi-bold">    266</span> <span style="font-style:italic;color:rgb(95,135,135)"># calls in the traceback and some print out the last line</span>
<span class="ansi-green-fg">--&gt; 267</span> <span class="ansi-yellow-bg">_engine_run_backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    268</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">tensors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">grad_tensors_</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">allow_unreachable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">accumulate_grad</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/graph.py:744</span>, in <span class="ansi-cyan-fg">_engine_run_backward</span><span class="ansi-blue-fg">(t_outputs, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    742</span>     unregister_hooks <span style="color:rgb(98,98,98)">=</span> _register_logging_hooks_on_whole_graph(t_outputs)
<span class="ansi-green-fg ansi-bold">    743</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 744</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">Variable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_execution_engine</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run_backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">  </span><span style="font-style:italic;color:rgb(95,135,135)" class="ansi-yellow-bg"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    745</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">t_outputs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span>
<span class="ansi-green-fg ansi-bold">    746</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>  <span style="font-style:italic;color:rgb(95,135,135)"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    747</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">    748</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> attach_logging_hooks:

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>We have suppressed the output here, which is a progress report on the fitting of the model, grouped by epoch. This is very useful, since on large datasets fitting can take time. Fitting this model took 245 seconds on a MacBook Pro with an Apple M1 Pro chip with 10 cores and 16 GB of RAM. Here we specified a validation split of 20%, so training is actually performed on 80% of the 60,000 observations in the training set. This is an alternative to actually supplying validation data, like we did for the <code>Hitters</code> data. SGD uses batches of 256 observations in computing the gradient, and doing the arithmetic, we see that an epoch corresponds to 188 gradient steps.</p>
<p><code>SimpleModule.classification()</code> includes an accuracy metric by default. Other classification metrics can be added from <code>torchmetrics</code>. We will use our <code>summary_plot()</code> function to display accuracy across epochs.</p>
<div id="cf2e84f7" class="cell" data-execution_count="43">
<div class="sourceCode cell-code" id="cb58"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb58-1"><a href="#cb58-1" aria-hidden="true" tabindex="-1"></a>mnist_results <span class="op">=</span> pd.read_csv(mnist_logger.experiment.metrics_file_path)</span>
<span id="cb58-2"><a href="#cb58-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb58-3"><a href="#cb58-3" aria-hidden="true" tabindex="-1"></a>summary_plot(mnist_results,</span>
<span id="cb58-4"><a href="#cb58-4" aria-hidden="true" tabindex="-1"></a>             ax,</span>
<span id="cb58-5"><a href="#cb58-5" aria-hidden="true" tabindex="-1"></a>             col<span class="op">=</span><span class="st">'accuracy'</span>,</span>
<span id="cb58-6"><a href="#cb58-6" aria-hidden="true" tabindex="-1"></a>             ylabel<span class="op">=</span><span class="st">'Accuracy'</span>)</span>
<span id="cb58-7"><a href="#cb58-7" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="fl">0.5</span>, <span class="dv">1</span>])</span>
<span id="cb58-8"><a href="#cb58-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb58-9"><a href="#cb58-9" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">7</span>).astype(<span class="bu">int</span>))<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[43], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> mnist_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mnist_logger</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">experiment</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">metrics_file_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> fig, ax <span style="color:rgb(98,98,98)">=</span> subplots(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>, figsize<span style="color:rgb(98,98,98)">=</span>(<span style="color:rgb(98,98,98)">6</span>, <span style="color:rgb(98,98,98)">6</span>))
<span class="ansi-green-fg ansi-bold">      3</span> summary_plot(mnist_results,
<span class="ansi-green-fg ansi-bold">      4</span>              ax,
<span class="ansi-green-fg ansi-bold">      5</span>              col<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">accuracy</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      6</span>              ylabel<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Accuracy</span><span style="color:rgb(175,0,0)">'</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg ansi-bold">   1013</span> kwds_defaults <span style="color:rgb(98,98,98)">=</span> _refine_defaults_read(
<span class="ansi-green-fg ansi-bold">   1014</span>     dialect,
<span class="ansi-green-fg ansi-bold">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1022</span>     dtype_backend<span style="color:rgb(98,98,98)">=</span>dtype_backend,
<span class="ansi-green-fg ansi-bold">   1023</span> )
<span class="ansi-green-fg ansi-bold">   1024</span> kwds<span style="color:rgb(98,98,98)">.</span>update(kwds_defaults)
<span class="ansi-green-fg">-&gt; 1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg ansi-bold">    617</span> _validate_names(kwds<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">names</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg ansi-bold">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; 620</span> parser <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg ansi-bold">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg ansi-bold">   1617</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>options[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> kwds[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">   1619</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles: IOHandles <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; 1620</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg ansi-bold">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg ansi-bold">   1879</span>         mode <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">-&gt; 1880</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">compression</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">memory_map</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding_errors</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">strict</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">storage_options</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1891</span> f <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles<span style="color:rgb(98,98,98)">.</span>handle

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg ansi-bold">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg ansi-bold">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg ansi-bold">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg ansi-bold">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs<span style="color:rgb(98,98,98)">.</span>encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs<span style="color:rgb(98,98,98)">.</span>mode:
<span class="ansi-green-fg ansi-bold">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; 873</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg ansi-bold">    882</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">open</span>(handle, ioargs<span style="color:rgb(98,98,98)">.</span>mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'logs/MNIST/version_1/metrics.csv'</pre>
</div>
</div>
</div>
<p>Once again we evaluate the accuracy using the <code>test()</code> method of our trainer. This model achieves 97% accuracy on the test data.</p>
<div id="a6fcb7f1" class="cell" data-execution_count="44">
<div class="sourceCode cell-code" id="cb59"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb59-1"><a href="#cb59-1" aria-hidden="true" tabindex="-1"></a>mnist_trainer.test(mnist_module,</span>
<span id="cb59-2"><a href="#cb59-2" aria-hidden="true" tabindex="-1"></a>                   datamodule<span class="op">=</span>mnist_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       Test metric             DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
      test_accuracy         0.08829999715089798
        test_loss            2.305781841278076
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="44">
<pre><code>[{'test_loss': 2.305781841278076, 'test_accuracy': 0.08829999715089798}]</code></pre>
</div>
</div>
<p>Table~ also reports the error rates resulting from LDA (Chapter~) and multiclass logistic regression. For LDA we refer the reader to Section~. Although we could use the <code>sklearn</code> function <code>LogisticRegression()</code> to fit<br>
multiclass logistic regression, we are set up here to fit such a model with <code>torch</code>. We just have an input layer and an output layer, and omit the hidden layers!</p>
<div id="482459db" class="cell" data-execution_count="45">
<div class="sourceCode cell-code" id="cb63"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb63-1"><a href="#cb63-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> MNIST_MLR(nn.Module):</span>
<span id="cb63-2"><a href="#cb63-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb63-3"><a href="#cb63-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(MNIST_MLR, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb63-4"><a href="#cb63-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.linear <span class="op">=</span> nn.Sequential(nn.Flatten(),</span>
<span id="cb63-5"><a href="#cb63-5" aria-hidden="true" tabindex="-1"></a>                                    nn.Linear(<span class="dv">784</span>, <span class="dv">10</span>))</span>
<span id="cb63-6"><a href="#cb63-6" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb63-7"><a href="#cb63-7" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.linear(x)</span>
<span id="cb63-8"><a href="#cb63-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb63-9"><a href="#cb63-9" aria-hidden="true" tabindex="-1"></a>mlr_model <span class="op">=</span> MNIST_MLR()</span>
<span id="cb63-10"><a href="#cb63-10" aria-hidden="true" tabindex="-1"></a>mlr_module <span class="op">=</span> SimpleModule.classification(mlr_model,</span>
<span id="cb63-11"><a href="#cb63-11" aria-hidden="true" tabindex="-1"></a>                                         num_classes<span class="op">=</span><span class="dv">10</span>)</span>
<span id="cb63-12"><a href="#cb63-12" aria-hidden="true" tabindex="-1"></a>mlr_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'MNIST_MLR'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="5b4e7dbb" class="cell" data-execution_count="46">
<div class="sourceCode cell-code" id="cb64"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb64-1"><a href="#cb64-1" aria-hidden="true" tabindex="-1"></a>mlr_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb64-2"><a href="#cb64-2" aria-hidden="true" tabindex="-1"></a>                      max_epochs<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb64-3"><a href="#cb64-3" aria-hidden="true" tabindex="-1"></a>                      enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb64-4"><a href="#cb64-4" aria-hidden="true" tabindex="-1"></a>                      callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb64-5"><a href="#cb64-5" aria-hidden="true" tabindex="-1"></a>mlr_trainer.fit(mlr_module, datamodule<span class="op">=</span>mnist_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
/home/oren/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/connectors/logger_connector/logger_connector.py:75: Starting from v1.9.0, `tensorboardX` has been removed as a dependency of the `pytorch_lightning` package, due to potential conflicts with other packages in the ML ecosystem. For this reason, `logger=True` will use `CSVLogger` as the default logger, unless the `tensorboard` or `tensorboardX` packages are found. Please `pip install lightning[extra]` or one of them to enable TensorBoard support by default
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type             | Params
-------------------------------------------
0 | model | MNIST_MLR        | 7.9 K 
1 | loss  | CrossEntropyLoss | 0     
-------------------------------------------
7.9 K     Trainable params
0         Non-trainable params
7.9 K     Total params
0.031     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[46], line 5</span>
<span class="ansi-green-fg ansi-bold">      1</span> mlr_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                       max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">30</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                       enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      4</span>                       callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 5</span> <span class="ansi-yellow-bg">mlr_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">mlr_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">mnist_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1033</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1031</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_run_sanity_check()
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg">-&gt; 1033</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1034</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1035</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Unexpected state </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:205</span>, in <span class="ansi-cyan-fg">_FitLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    203</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    204</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_start()
<span class="ansi-green-fg">--&gt; 205</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end()
<span class="ansi-green-fg ansi-bold">    207</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:363</span>, in <span class="ansi-cyan-fg">_FitLoop.advance</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    361</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_epoch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    362</span>     <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_data_fetcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 363</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">epoch_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_data_fetcher</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:140</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.run</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    138</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>done:
<span class="ansi-green-fg ansi-bold">    139</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 140</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">data_fetcher</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    141</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end(data_fetcher)
<span class="ansi-green-fg ansi-bold">    142</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:250</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.advance</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    247</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_batch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    248</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>automatic_optimization:
<span class="ansi-green-fg ansi-bold">    249</span>         <span style="font-style:italic;color:rgb(95,135,135)"># in automatic optimization, there can only be one optimizer</span>
<span class="ansi-green-fg">--&gt; 250</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">automatic_optimization</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizers</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    251</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    252</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>manual_optimization<span style="color:rgb(98,98,98)">.</span>run(kwargs)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:190</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization.run</span><span class="ansi-blue-fg">(self, optimizer, batch_idx, kwargs)</span>
<span class="ansi-green-fg ansi-bold">    183</span>         closure()
<span class="ansi-green-fg ansi-bold">    185</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    186</span> <span style="font-style:italic;color:rgb(95,135,135)"># BACKWARD PASS</span>
<span class="ansi-green-fg ansi-bold">    187</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    188</span> <span style="font-style:italic;color:rgb(95,135,135)"># gradient update with accumulated gradients</span>
<span class="ansi-green-fg ansi-bold">    189</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">--&gt; 190</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    192</span> result <span style="color:rgb(98,98,98)">=</span> closure<span style="color:rgb(98,98,98)">.</span>consume_result()
<span class="ansi-green-fg ansi-bold">    193</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> result<span style="color:rgb(98,98,98)">.</span>loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:268</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._optimizer_step</span><span class="ansi-blue-fg">(self, batch_idx, train_step_and_backward_closure)</span>
<span class="ansi-green-fg ansi-bold">    265</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_ready()
<span class="ansi-green-fg ansi-bold">    267</span> <span style="font-style:italic;color:rgb(95,135,135)"># model hook</span>
<span class="ansi-green-fg">--&gt; 268</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_lightning_module_hook</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">optimizer_step</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">current_epoch</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">train_step_and_backward_closure</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    277</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> should_accumulate:
<span class="ansi-green-fg ansi-bold">    278</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_completed()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:157</span>, in <span class="ansi-cyan-fg">_call_lightning_module_hook</span><span class="ansi-blue-fg">(trainer, hook_name, pl_module, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    154</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> hook_name
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[LightningModule]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>pl_module<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 157</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    159</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    160</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1303</span>, in <span class="ansi-cyan-fg">LightningModule.optimizer_step</span><span class="ansi-blue-fg">(self, epoch, batch_idx, optimizer, optimizer_closure)</span>
<span class="ansi-green-fg ansi-bold">   1264</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">optimizer_step</span>(
<span class="ansi-green-fg ansi-bold">   1265</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">   1266</span>     epoch: <span style="color:rgb(0,135,0)">int</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1269</span>     optimizer_closure: Optional[Callable[[], Any]] <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">   1270</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">   1271</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Override this method to adjust the default way the :class:`~pytorch_lightning.trainer.trainer.Trainer` calls</span>
<span class="ansi-green-fg ansi-bold">   1272</span> <span style="font-style:italic;color:rgb(175,0,0)">    the optimizer.</span>
<span class="ansi-green-fg ansi-bold">   1273</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1301</span> 
<span class="ansi-green-fg ansi-bold">   1302</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">-&gt; 1303</span>     <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">optimizer_closure</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/optimizer.py:152</span>, in <span class="ansi-cyan-fg">LightningOptimizer.step</span><span class="ansi-blue-fg">(self, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    149</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> MisconfigurationException(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">When `optimizer.step(closure)` is called, the closure should be callable</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    151</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_strategy <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 152</span> step_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_strategy</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    154</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_on_after_step()
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:239</span>, in <span class="ansi-cyan-fg">Strategy.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, closure, model, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    237</span> <span style="font-style:italic;color:rgb(95,135,135)"># TODO(fabric): remove assertion once strategy's optimizer_step typing is fixed</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">isinstance</span>(model, pl<span style="color:rgb(98,98,98)">.</span>LightningModule)
<span class="ansi-green-fg">--&gt; 239</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:122</span>, in <span class="ansi-cyan-fg">Precision.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, model, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    120</span> <span style="font-style:italic;color:rgb(175,0,0)">"""Hook to run the optimizer step."""</span>
<span class="ansi-green-fg ansi-bold">    121</span> closure <span style="color:rgb(98,98,98)">=</span> partial(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_wrap_closure, model, optimizer, closure)
<span class="ansi-green-fg">--&gt; 122</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:391</span>, in <span class="ansi-cyan-fg">Optimizer.profile_hook_step.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    386</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    387</span>             <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(
<span class="ansi-green-fg ansi-bold">    388</span>                 <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>func<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> must return None or a tuple of (new_args, new_kwargs), but got </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>result<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    389</span>             )
<span class="ansi-green-fg">--&gt; 391</span> out <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    392</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_optimizer_step_code()
<span class="ansi-green-fg ansi-bold">    394</span> <span style="font-style:italic;color:rgb(95,135,135)"># call optimizer step post hooks</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:76</span>, in <span class="ansi-cyan-fg">_use_grad_for_differentiable.&lt;locals&gt;._use_grad</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     74</span>     torch<span style="color:rgb(98,98,98)">.</span>set_grad_enabled(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>defaults[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">differentiable</span><span style="color:rgb(175,0,0)">'</span>])
<span class="ansi-green-fg ansi-bold">     75</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()
<span class="ansi-green-fg">---&gt; 76</span>     ret <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     77</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">     78</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/rmsprop.py:109</span>, in <span class="ansi-cyan-fg">RMSprop.step</span><span class="ansi-blue-fg">(self, closure)</span>
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> closure <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    108</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>enable_grad():
<span class="ansi-green-fg">--&gt; 109</span>         loss <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    111</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> group <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>param_groups:
<span class="ansi-green-fg ansi-bold">    112</span>     params_with_grad <span style="color:rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:108</span>, in <span class="ansi-cyan-fg">Precision._wrap_closure</span><span class="ansi-blue-fg">(self, model, optimizer, closure)</span>
<span class="ansi-green-fg ansi-bold">     95</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">_wrap_closure</span>(
<span class="ansi-green-fg ansi-bold">     96</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">     97</span>     model: <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">pl.LightningModule</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">     98</span>     optimizer: Optimizer,
<span class="ansi-green-fg ansi-bold">     99</span>     closure: Callable[[], Any],
<span class="ansi-green-fg ansi-bold">    100</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Any:
<span class="ansi-green-fg ansi-bold">    101</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""This double-closure allows makes sure the ``closure`` is executed before the ``on_before_optimizer_step``</span>
<span class="ansi-green-fg ansi-bold">    102</span> <span style="font-style:italic;color:rgb(175,0,0)">    hook is called.</span>
<span class="ansi-green-fg ansi-bold">    103</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    106</span> 
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 108</span>     closure_result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    109</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_after_closure(model, optimizer)
<span class="ansi-green-fg ansi-bold">    110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> closure_result

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:144</span>, in <span class="ansi-cyan-fg">Closure.__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    142</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">    143</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">__call__</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(98,98,98)">*</span>args: Any, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Optional[Tensor]:
<span class="ansi-green-fg">--&gt; 144</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    145</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result<span style="color:rgb(98,98,98)">.</span>loss

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/utils/_contextlib.py:115</span>, in <span class="ansi-cyan-fg">context_decorator.&lt;locals&gt;.decorate_context</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    112</span> <span style="color:rgb(175,0,255)">@functools</span><span style="color:rgb(98,98,98)">.</span>wraps(func)
<span class="ansi-green-fg ansi-bold">    113</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">decorate_context</span>(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">    114</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> ctx_factory():
<span class="ansi-green-fg">--&gt; 115</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:138</span>, in <span class="ansi-cyan-fg">Closure.closure</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    135</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_zero_grad_fn()
<span class="ansi-green-fg ansi-bold">    137</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> step_output<span style="color:rgb(98,98,98)">.</span>closure_loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 138</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_backward_fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">step_output</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    140</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:239</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._make_backward_fn.&lt;locals&gt;.backward_fn</span><span class="ansi-blue-fg">(loss)</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward_fn</span>(loss: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 239</span>     <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_strategy_hook</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">backward</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:309</span>, in <span class="ansi-cyan-fg">_call_strategy_hook</span><span class="ansi-blue-fg">(trainer, hook_name, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    306</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    308</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Strategy]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 309</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    311</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    312</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:213</span>, in <span class="ansi-cyan-fg">Strategy.backward</span><span class="ansi-blue-fg">(self, closure_loss, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    211</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>pre_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg">--&gt; 213</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    215</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg ansi-bold">    216</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:72</span>, in <span class="ansi-cyan-fg">Precision.backward</span><span class="ansi-blue-fg">(self, tensor, model, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     52</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">     53</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward</span>(  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[override]</span>
<span class="ansi-green-fg ansi-bold">     54</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     59</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any,
<span class="ansi-green-fg ansi-bold">     60</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     61</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Performs the actual backpropagation.</span>
<span class="ansi-green-fg ansi-bold">     62</span> 
<span class="ansi-green-fg ansi-bold">     63</span> <span style="font-style:italic;color:rgb(175,0,0)">    Args:</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     70</span> 
<span class="ansi-green-fg ansi-bold">     71</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">---&gt; 72</span>     <span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">tensor</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1090</span>, in <span class="ansi-cyan-fg">LightningModule.backward</span><span class="ansi-blue-fg">(self, loss, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1088</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_fabric<span style="color:rgb(98,98,98)">.</span>backward(loss, <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">   1089</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1090</span>     <span class="ansi-yellow-bg">loss</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/_tensor.py:525</span>, in <span class="ansi-cyan-fg">Tensor.backward</span><span class="ansi-blue-fg">(self, gradient, retain_graph, create_graph, inputs)</span>
<span class="ansi-green-fg ansi-bold">    515</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> has_torch_function_unary(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg ansi-bold">    516</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> handle_torch_function(
<span class="ansi-green-fg ansi-bold">    517</span>         Tensor<span style="color:rgb(98,98,98)">.</span>backward,
<span class="ansi-green-fg ansi-bold">    518</span>         (<span style="color:rgb(0,135,0)">self</span>,),
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    523</span>         inputs<span style="color:rgb(98,98,98)">=</span>inputs,
<span class="ansi-green-fg ansi-bold">    524</span>     )
<span class="ansi-green-fg">--&gt; 525</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">autograd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    526</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">gradient</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">inputs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">inputs</span>
<span class="ansi-green-fg ansi-bold">    527</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/__init__.py:267</span>, in <span class="ansi-cyan-fg">backward</span><span class="ansi-blue-fg">(tensors, grad_tensors, retain_graph, create_graph, grad_variables, inputs)</span>
<span class="ansi-green-fg ansi-bold">    262</span>     retain_graph <span style="color:rgb(98,98,98)">=</span> create_graph
<span class="ansi-green-fg ansi-bold">    264</span> <span style="font-style:italic;color:rgb(95,135,135)"># The reason we repeat the same comment below is that</span>
<span class="ansi-green-fg ansi-bold">    265</span> <span style="font-style:italic;color:rgb(95,135,135)"># some Python versions print out the first line of a multi-line function</span>
<span class="ansi-green-fg ansi-bold">    266</span> <span style="font-style:italic;color:rgb(95,135,135)"># calls in the traceback and some print out the last line</span>
<span class="ansi-green-fg">--&gt; 267</span> <span class="ansi-yellow-bg">_engine_run_backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    268</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">tensors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">grad_tensors_</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">allow_unreachable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">accumulate_grad</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/graph.py:744</span>, in <span class="ansi-cyan-fg">_engine_run_backward</span><span class="ansi-blue-fg">(t_outputs, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    742</span>     unregister_hooks <span style="color:rgb(98,98,98)">=</span> _register_logging_hooks_on_whole_graph(t_outputs)
<span class="ansi-green-fg ansi-bold">    743</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 744</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">Variable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_execution_engine</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run_backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">  </span><span style="font-style:italic;color:rgb(95,135,135)" class="ansi-yellow-bg"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    745</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">t_outputs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span>
<span class="ansi-green-fg ansi-bold">    746</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>  <span style="font-style:italic;color:rgb(95,135,135)"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    747</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">    748</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> attach_logging_hooks:

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>We fit the model just as before and compute the test results.</p>
<div id="5ea4ab92" class="cell" data-execution_count="47">
<div class="sourceCode cell-code" id="cb66"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb66-1"><a href="#cb66-1" aria-hidden="true" tabindex="-1"></a>mlr_trainer.test(mlr_module,</span>
<span id="cb66-2"><a href="#cb66-2" aria-hidden="true" tabindex="-1"></a>                 datamodule<span class="op">=</span>mnist_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       Test metric             DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
      test_accuracy         0.05660000070929527
        test_loss            2.34493350982666
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="47">
<pre><code>[{'test_loss': 2.34493350982666, 'test_accuracy': 0.05660000070929527}]</code></pre>
</div>
</div>
<p>The accuracy is above 90% even for this pretty simple model.</p>
<p>As in the <code>Hitters</code> example, we delete some of the objects we created above.</p>
<div id="d0915075" class="cell" data-execution_count="48">
<div class="sourceCode cell-code" id="cb70"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb70-1"><a href="#cb70-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(mnist_test,</span>
<span id="cb70-2"><a href="#cb70-2" aria-hidden="true" tabindex="-1"></a>    mnist_train,</span>
<span id="cb70-3"><a href="#cb70-3" aria-hidden="true" tabindex="-1"></a>    mnist_model,</span>
<span id="cb70-4"><a href="#cb70-4" aria-hidden="true" tabindex="-1"></a>    mnist_dm,</span>
<span id="cb70-5"><a href="#cb70-5" aria-hidden="true" tabindex="-1"></a>    mnist_trainer,</span>
<span id="cb70-6"><a href="#cb70-6" aria-hidden="true" tabindex="-1"></a>    mnist_module,</span>
<span id="cb70-7"><a href="#cb70-7" aria-hidden="true" tabindex="-1"></a>    mnist_results,</span>
<span id="cb70-8"><a href="#cb70-8" aria-hidden="true" tabindex="-1"></a>    mlr_model,</span>
<span id="cb70-9"><a href="#cb70-9" aria-hidden="true" tabindex="-1"></a>    mlr_module,</span>
<span id="cb70-10"><a href="#cb70-10" aria-hidden="true" tabindex="-1"></a>    mlr_trainer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[48], line 7</span>
<span class="ansi-green-fg ansi-bold">      1</span> <span style="font-weight:bold;color:rgb(0,135,0)">del</span>(mnist_test,
<span class="ansi-green-fg ansi-bold">      2</span>     mnist_train,
<span class="ansi-green-fg ansi-bold">      3</span>     mnist_model,
<span class="ansi-green-fg ansi-bold">      4</span>     mnist_dm,
<span class="ansi-green-fg ansi-bold">      5</span>     mnist_trainer,
<span class="ansi-green-fg ansi-bold">      6</span>     mnist_module,
<span class="ansi-green-fg">----&gt; 7</span>     mnist_results,
<span class="ansi-green-fg ansi-bold">      8</span>     mlr_model,
<span class="ansi-green-fg ansi-bold">      9</span>     mlr_module,
<span class="ansi-green-fg ansi-bold">     10</span>     mlr_trainer)

<span class="ansi-red-fg">NameError</span>: name 'mnist_results' is not defined</pre>
</div>
</div>
</div>
</section>
<section id="convolutional-neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="convolutional-neural-networks">Convolutional Neural Networks</h2>
<p>In this section we fit a CNN to the <code>CIFAR100</code> data, which is available in the <code>torchvision</code> package. It is arranged in a similar fashion as the <code>MNIST</code> data.</p>
<div id="d2906749" class="cell" data-execution_count="49">
<div class="sourceCode cell-code" id="cb71"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb71-1"><a href="#cb71-1" aria-hidden="true" tabindex="-1"></a>(cifar_train, </span>
<span id="cb71-2"><a href="#cb71-2" aria-hidden="true" tabindex="-1"></a> cifar_test) <span class="op">=</span> [CIFAR100(root<span class="op">=</span><span class="st">"data"</span>,</span>
<span id="cb71-3"><a href="#cb71-3" aria-hidden="true" tabindex="-1"></a>                         train<span class="op">=</span>train,</span>
<span id="cb71-4"><a href="#cb71-4" aria-hidden="true" tabindex="-1"></a>                         download<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb71-5"><a href="#cb71-5" aria-hidden="true" tabindex="-1"></a>             <span class="cf">for</span> train <span class="kw">in</span> [<span class="va">True</span>, <span class="va">False</span>]]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Files already downloaded and verified
Files already downloaded and verified</code></pre>
</div>
</div>
<div id="1310b35f" class="cell" data-execution_count="50">
<div class="sourceCode cell-code" id="cb73"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb73-1"><a href="#cb73-1" aria-hidden="true" tabindex="-1"></a>transform <span class="op">=</span> ToTensor()</span>
<span id="cb73-2"><a href="#cb73-2" aria-hidden="true" tabindex="-1"></a>cifar_train_X <span class="op">=</span> torch.stack([transform(x) <span class="cf">for</span> x <span class="kw">in</span></span>
<span id="cb73-3"><a href="#cb73-3" aria-hidden="true" tabindex="-1"></a>                            cifar_train.data])</span>
<span id="cb73-4"><a href="#cb73-4" aria-hidden="true" tabindex="-1"></a>cifar_test_X <span class="op">=</span> torch.stack([transform(x) <span class="cf">for</span> x <span class="kw">in</span></span>
<span id="cb73-5"><a href="#cb73-5" aria-hidden="true" tabindex="-1"></a>                            cifar_test.data])</span>
<span id="cb73-6"><a href="#cb73-6" aria-hidden="true" tabindex="-1"></a>cifar_train <span class="op">=</span> TensorDataset(cifar_train_X,</span>
<span id="cb73-7"><a href="#cb73-7" aria-hidden="true" tabindex="-1"></a>                            torch.tensor(cifar_train.targets))</span>
<span id="cb73-8"><a href="#cb73-8" aria-hidden="true" tabindex="-1"></a>cifar_test <span class="op">=</span> TensorDataset(cifar_test_X,</span>
<span id="cb73-9"><a href="#cb73-9" aria-hidden="true" tabindex="-1"></a>                            torch.tensor(cifar_test.targets))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                                                  Testing: |          | 0/? [00:05&lt;?, ?it/s]</code></pre>
</div>
</div>
<p>The <code>CIFAR100</code> dataset consists of 50,000 training images, each represented by a three-dimensional tensor: each three-color image is represented as a set of three channels, each of which consists of <span class="math inline">32\times 32</span> eight-bit pixels. We standardize as we did for the digits, but keep the array structure. This is accomplished with the <code>ToTensor()</code> transform.</p>
<p>Creating the data module is similar to the <code>MNIST</code> example.</p>
<div id="34704ffe" class="cell" data-execution_count="51">
<div class="sourceCode cell-code" id="cb75"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb75-1"><a href="#cb75-1" aria-hidden="true" tabindex="-1"></a>cifar_dm <span class="op">=</span> SimpleDataModule(cifar_train,</span>
<span id="cb75-2"><a href="#cb75-2" aria-hidden="true" tabindex="-1"></a>                            cifar_test,</span>
<span id="cb75-3"><a href="#cb75-3" aria-hidden="true" tabindex="-1"></a>                            validation<span class="op">=</span><span class="fl">0.2</span>,</span>
<span id="cb75-4"><a href="#cb75-4" aria-hidden="true" tabindex="-1"></a>                            num_workers<span class="op">=</span>max_num_workers,</span>
<span id="cb75-5"><a href="#cb75-5" aria-hidden="true" tabindex="-1"></a>                            batch_size<span class="op">=</span><span class="dv">128</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We again look at the shape of typical batches in our data loaders.</p>
<div id="f5c3ff68" class="cell" data-execution_count="52">
<div class="sourceCode cell-code" id="cb76"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb76-1"><a href="#cb76-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (X_ ,Y_) <span class="kw">in</span> <span class="bu">enumerate</span>(cifar_dm.train_dataloader()):</span>
<span id="cb76-2"><a href="#cb76-2" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'X: '</span>, X_.shape)</span>
<span id="cb76-3"><a href="#cb76-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="st">'Y: '</span>, Y_.shape)</span>
<span id="cb76-4"><a href="#cb76-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&gt;=</span> <span class="dv">1</span>:</span>
<span id="cb76-5"><a href="#cb76-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>X:  torch.Size([128, 3, 32, 32])
Y:  torch.Size([128])
X:  torch.Size([128, 3, 32, 32])
Y:  torch.Size([128])</code></pre>
</div>
</div>
<p>Before we start, we look at some of the training images; similar code produced Figure~ on page . The example below also illustrates that <code>TensorDataset</code> objects can be indexed with integers — we are choosing random images from the training data by indexing <code>cifar_train</code>. In order to display correctly, we must reorder the dimensions by a call to <code>np.transpose()</code>.</p>
<div id="cc3ade6a" class="cell" data-execution_count="53">
<div class="sourceCode cell-code" id="cb78"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb78-1"><a href="#cb78-1" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> subplots(<span class="dv">5</span>, <span class="dv">5</span>, figsize<span class="op">=</span>(<span class="dv">10</span>,<span class="dv">10</span>))</span>
<span id="cb78-2"><a href="#cb78-2" aria-hidden="true" tabindex="-1"></a>rng <span class="op">=</span> np.random.default_rng(<span class="dv">4</span>)</span>
<span id="cb78-3"><a href="#cb78-3" aria-hidden="true" tabindex="-1"></a>indices <span class="op">=</span> rng.choice(np.arange(<span class="bu">len</span>(cifar_train)), <span class="dv">25</span>,</span>
<span id="cb78-4"><a href="#cb78-4" aria-hidden="true" tabindex="-1"></a>                     replace<span class="op">=</span><span class="va">False</span>).reshape((<span class="dv">5</span>,<span class="dv">5</span>))</span>
<span id="cb78-5"><a href="#cb78-5" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb78-6"><a href="#cb78-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> j <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>):</span>
<span id="cb78-7"><a href="#cb78-7" aria-hidden="true" tabindex="-1"></a>        idx <span class="op">=</span> indices[i,j]</span>
<span id="cb78-8"><a href="#cb78-8" aria-hidden="true" tabindex="-1"></a>        axes[i,j].imshow(np.transpose(cifar_train[idx][<span class="dv">0</span>],</span>
<span id="cb78-9"><a href="#cb78-9" aria-hidden="true" tabindex="-1"></a>                                      [<span class="dv">1</span>,<span class="dv">2</span>,<span class="dv">0</span>]),</span>
<span id="cb78-10"><a href="#cb78-10" aria-hidden="true" tabindex="-1"></a>                                      interpolation<span class="op">=</span><span class="va">None</span>)</span>
<span id="cb78-11"><a href="#cb78-11" aria-hidden="true" tabindex="-1"></a>        axes[i,j].set_xticks([])</span>
<span id="cb78-12"><a href="#cb78-12" aria-hidden="true" tabindex="-1"></a>        axes[i,j].set_yticks([])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display">
<div>
<figure class="figure">
<p><a href="Ch10-deeplearning-lab_files/figure-html/cell-54-output-1.png" class="lightbox" data-gallery="quarto-lightbox-gallery-3"><img src="Ch10-deeplearning-lab_files/figure-html/cell-54-output-1.png" width="762" height="758" class="figure-img"></a></p>
</figure>
</div>
</div>
</div>
<p>Here the <code>imshow()</code> method recognizes from the shape of its argument that it is a 3-dimensional array, with the last dimension indexing the three RGB color channels.</p>
<p>We specify a moderately-sized CNN for demonstration purposes, similar in structure to Figure~. We use several layers, each consisting of convolution, ReLU, and max-pooling steps. We first define a module that defines one of these layers. As in our previous examples, we overwrite the <code>__init__()</code> and <code>forward()</code> methods of <code>nn.Module</code>. This user-defined module can now be used in ways just like <code>nn.Linear()</code> or <code>nn.Dropout()</code>.</p>
<div id="7fa0c453" class="cell" data-execution_count="54">
<div class="sourceCode cell-code" id="cb79"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb79-1"><a href="#cb79-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> BuildingBlock(nn.Module):</span>
<span id="cb79-2"><a href="#cb79-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-3"><a href="#cb79-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>,</span>
<span id="cb79-4"><a href="#cb79-4" aria-hidden="true" tabindex="-1"></a>                 in_channels,</span>
<span id="cb79-5"><a href="#cb79-5" aria-hidden="true" tabindex="-1"></a>                 out_channels):</span>
<span id="cb79-6"><a href="#cb79-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-7"><a href="#cb79-7" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(BuildingBlock, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb79-8"><a href="#cb79-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv <span class="op">=</span> nn.Conv2d(in_channels<span class="op">=</span>in_channels,</span>
<span id="cb79-9"><a href="#cb79-9" aria-hidden="true" tabindex="-1"></a>                              out_channels<span class="op">=</span>out_channels,</span>
<span id="cb79-10"><a href="#cb79-10" aria-hidden="true" tabindex="-1"></a>                              kernel_size<span class="op">=</span>(<span class="dv">3</span>,<span class="dv">3</span>),</span>
<span id="cb79-11"><a href="#cb79-11" aria-hidden="true" tabindex="-1"></a>                              padding<span class="op">=</span><span class="st">'same'</span>)</span>
<span id="cb79-12"><a href="#cb79-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> nn.ReLU()</span>
<span id="cb79-13"><a href="#cb79-13" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.pool <span class="op">=</span> nn.MaxPool2d(kernel_size<span class="op">=</span>(<span class="dv">2</span>,<span class="dv">2</span>))</span>
<span id="cb79-14"><a href="#cb79-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb79-15"><a href="#cb79-15" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb79-16"><a href="#cb79-16" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.pool(<span class="va">self</span>.activation(<span class="va">self</span>.conv(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice that we used the <code>padding = "same"</code> argument to <code>nn.Conv2d()</code>, which ensures that the output channels have the same dimension as the input channels. There are 32 channels in the first hidden layer, in contrast to the three channels in the input layer. We use a <span class="math inline">3\times 3</span> convolution filter for each channel in all the layers. Each convolution is followed by a max-pooling layer over <span class="math inline">2\times2</span> blocks.</p>
<p>In forming our deep learning model for the <code>CIFAR100</code> data, we use several of our <code>BuildingBlock()</code> modules sequentially. This simple example illustrates some of the power of <code>torch</code>. Users can define modules of their own, which can be combined in other modules. Ultimately, everything is fit by a generic trainer.</p>
<div id="fb0553c8" class="cell" data-execution_count="55">
<div class="sourceCode cell-code" id="cb80"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb80-1"><a href="#cb80-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> CIFARModel(nn.Module):</span>
<span id="cb80-2"><a href="#cb80-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-3"><a href="#cb80-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb80-4"><a href="#cb80-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(CIFARModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb80-5"><a href="#cb80-5" aria-hidden="true" tabindex="-1"></a>        sizes <span class="op">=</span> [(<span class="dv">3</span>,<span class="dv">32</span>),</span>
<span id="cb80-6"><a href="#cb80-6" aria-hidden="true" tabindex="-1"></a>                 (<span class="dv">32</span>,<span class="dv">64</span>),</span>
<span id="cb80-7"><a href="#cb80-7" aria-hidden="true" tabindex="-1"></a>                 (<span class="dv">64</span>,<span class="dv">128</span>),</span>
<span id="cb80-8"><a href="#cb80-8" aria-hidden="true" tabindex="-1"></a>                 (<span class="dv">128</span>,<span class="dv">256</span>)]</span>
<span id="cb80-9"><a href="#cb80-9" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.conv <span class="op">=</span> nn.Sequential(<span class="op">*</span>[BuildingBlock(in_, out_)</span>
<span id="cb80-10"><a href="#cb80-10" aria-hidden="true" tabindex="-1"></a>                                    <span class="cf">for</span> in_, out_ <span class="kw">in</span> sizes])</span>
<span id="cb80-11"><a href="#cb80-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb80-12"><a href="#cb80-12" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output <span class="op">=</span> nn.Sequential(nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb80-13"><a href="#cb80-13" aria-hidden="true" tabindex="-1"></a>                                    nn.Linear(<span class="dv">2</span><span class="op">*</span><span class="dv">2</span><span class="op">*</span><span class="dv">256</span>, <span class="dv">512</span>),</span>
<span id="cb80-14"><a href="#cb80-14" aria-hidden="true" tabindex="-1"></a>                                    nn.ReLU(),</span>
<span id="cb80-15"><a href="#cb80-15" aria-hidden="true" tabindex="-1"></a>                                    nn.Linear(<span class="dv">512</span>, <span class="dv">100</span>))</span>
<span id="cb80-16"><a href="#cb80-16" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb80-17"><a href="#cb80-17" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> <span class="va">self</span>.conv(x)</span>
<span id="cb80-18"><a href="#cb80-18" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> torch.flatten(val, start_dim<span class="op">=</span><span class="dv">1</span>)</span>
<span id="cb80-19"><a href="#cb80-19" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> <span class="va">self</span>.output(val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We build the model and look at the summary. (We had created examples of <code>X_</code> earlier.)</p>
<div id="8e333c35" class="cell" data-execution_count="56">
<div class="sourceCode cell-code" id="cb81"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb81-1"><a href="#cb81-1" aria-hidden="true" tabindex="-1"></a>cifar_model <span class="op">=</span> CIFARModel()</span>
<span id="cb81-2"><a href="#cb81-2" aria-hidden="true" tabindex="-1"></a>summary(cifar_model,</span>
<span id="cb81-3"><a href="#cb81-3" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>X_,</span>
<span id="cb81-4"><a href="#cb81-4" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb81-5"><a href="#cb81-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb81-6"><a href="#cb81-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="56">
<pre><code>===================================================================================================================
Layer (type:depth-idx)                   Input Shape               Output Shape              Param #
===================================================================================================================
CIFARModel                               [128, 3, 32, 32]          [128, 100]                --
├─Sequential: 1-1                        [128, 3, 32, 32]          [128, 256, 2, 2]          --
│    └─BuildingBlock: 2-1                [128, 3, 32, 32]          [128, 32, 16, 16]         --
│    │    └─Conv2d: 3-1                  [128, 3, 32, 32]          [128, 32, 32, 32]         896
│    │    └─ReLU: 3-2                    [128, 32, 32, 32]         [128, 32, 32, 32]         --
│    │    └─MaxPool2d: 3-3               [128, 32, 32, 32]         [128, 32, 16, 16]         --
│    └─BuildingBlock: 2-2                [128, 32, 16, 16]         [128, 64, 8, 8]           --
│    │    └─Conv2d: 3-4                  [128, 32, 16, 16]         [128, 64, 16, 16]         18,496
│    │    └─ReLU: 3-5                    [128, 64, 16, 16]         [128, 64, 16, 16]         --
│    │    └─MaxPool2d: 3-6               [128, 64, 16, 16]         [128, 64, 8, 8]           --
│    └─BuildingBlock: 2-3                [128, 64, 8, 8]           [128, 128, 4, 4]          --
│    │    └─Conv2d: 3-7                  [128, 64, 8, 8]           [128, 128, 8, 8]          73,856
│    │    └─ReLU: 3-8                    [128, 128, 8, 8]          [128, 128, 8, 8]          --
│    │    └─MaxPool2d: 3-9               [128, 128, 8, 8]          [128, 128, 4, 4]          --
│    └─BuildingBlock: 2-4                [128, 128, 4, 4]          [128, 256, 2, 2]          --
│    │    └─Conv2d: 3-10                 [128, 128, 4, 4]          [128, 256, 4, 4]          295,168
│    │    └─ReLU: 3-11                   [128, 256, 4, 4]          [128, 256, 4, 4]          --
│    │    └─MaxPool2d: 3-12              [128, 256, 4, 4]          [128, 256, 2, 2]          --
├─Sequential: 1-2                        [128, 1024]               [128, 100]                --
│    └─Dropout: 2-5                      [128, 1024]               [128, 1024]               --
│    └─Linear: 2-6                       [128, 1024]               [128, 512]                524,800
│    └─ReLU: 2-7                         [128, 512]                [128, 512]                --
│    └─Linear: 2-8                       [128, 512]                [128, 100]                51,300
===================================================================================================================
Total params: 964,516
Trainable params: 964,516
Non-trainable params: 0
Total mult-adds (G): 2.01
===================================================================================================================
Input size (MB): 1.57
Forward/backward pass size (MB): 63.54
Params size (MB): 3.86
Estimated Total Size (MB): 68.97
===================================================================================================================</code></pre>
</div>
</div>
<p>The total number of trainable parameters is 964,516. By studying the size of the parameters, we can see that the channels halve in both dimensions after each of these max-pooling operations. After the last of these we have a layer with 256 channels of dimension <span class="math inline">2\times 2</span>. These are then flattened to a dense layer of size 1,024; in other words, each of the <span class="math inline">2\times 2</span> matrices is turned into a <span class="math inline">4</span>-vector, and put side-by-side in one layer. This is followed by a dropout regularization layer, then another dense layer of size 512, and finally, the output layer.</p>
<p>Up to now, we have been using a default optimizer in <code>SimpleModule()</code>. For these data, experiments show that a smaller learning rate performs better than the default 0.01. We use a custom optimizer here with a learning rate of 0.001. Besides this, the logging and training follow a similar pattern to our previous examples. The optimizer takes an argument <code>params</code> that informs the optimizer which parameters are involved in SGD (stochastic gradient descent).</p>
<p>We saw earlier that entries of a module’s parameters are tensors. In passing the parameters to the optimizer we are doing more than simply passing arrays; part of the structure of the graph is encoded in the tensors themselves.</p>
<div id="2b89d6b5" class="cell" data-execution_count="57">
<div class="sourceCode cell-code" id="cb83"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb83-1"><a href="#cb83-1" aria-hidden="true" tabindex="-1"></a>cifar_optimizer <span class="op">=</span> RMSprop(cifar_model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb83-2"><a href="#cb83-2" aria-hidden="true" tabindex="-1"></a>cifar_module <span class="op">=</span> SimpleModule.classification(cifar_model,</span>
<span id="cb83-3"><a href="#cb83-3" aria-hidden="true" tabindex="-1"></a>                                    num_classes<span class="op">=</span><span class="dv">100</span>,</span>
<span id="cb83-4"><a href="#cb83-4" aria-hidden="true" tabindex="-1"></a>                                    optimizer<span class="op">=</span>cifar_optimizer)</span>
<span id="cb83-5"><a href="#cb83-5" aria-hidden="true" tabindex="-1"></a>cifar_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'CIFAR100'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="925397ed" class="cell" data-execution_count="58">
<div class="sourceCode cell-code" id="cb84"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb84-1"><a href="#cb84-1" aria-hidden="true" tabindex="-1"></a>cifar_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb84-2"><a href="#cb84-2" aria-hidden="true" tabindex="-1"></a>                        max_epochs<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb84-3"><a href="#cb84-3" aria-hidden="true" tabindex="-1"></a>                        logger<span class="op">=</span>cifar_logger,</span>
<span id="cb84-4"><a href="#cb84-4" aria-hidden="true" tabindex="-1"></a>                        enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb84-5"><a href="#cb84-5" aria-hidden="true" tabindex="-1"></a>                        callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb84-6"><a href="#cb84-6" aria-hidden="true" tabindex="-1"></a>cifar_trainer.fit(cifar_module,</span>
<span id="cb84-7"><a href="#cb84-7" aria-hidden="true" tabindex="-1"></a>                  datamodule<span class="op">=</span>cifar_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
Missing logger folder: logs/CIFAR100
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type             | Params
-------------------------------------------
0 | model | CIFARModel       | 964 K 
1 | loss  | CrossEntropyLoss | 0     
-------------------------------------------
964 K     Trainable params
0         Non-trainable params
964 K     Total params
3.858     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[58], line 6</span>
<span class="ansi-green-fg ansi-bold">      1</span> cifar_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                         max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">30</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                         logger<span style="color:rgb(98,98,98)">=</span>cifar_logger,
<span class="ansi-green-fg ansi-bold">      4</span>                         enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      5</span>                         callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 6</span> <span class="ansi-yellow-bg">cifar_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">cifar_module</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span class="ansi-yellow-bg">                  </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">cifar_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1033</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1031</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_run_sanity_check()
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg">-&gt; 1033</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1034</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1035</span> <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Unexpected state </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:205</span>, in <span class="ansi-cyan-fg">_FitLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    203</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">    204</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_start()
<span class="ansi-green-fg">--&gt; 205</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end()
<span class="ansi-green-fg ansi-bold">    207</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/fit_loop.py:363</span>, in <span class="ansi-cyan-fg">_FitLoop.advance</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    361</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_epoch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    362</span>     <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_data_fetcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 363</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">epoch_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_data_fetcher</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:140</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.run</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    138</span> <span style="font-weight:bold;color:rgb(0,135,0)">while</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>done:
<span class="ansi-green-fg ansi-bold">    139</span>     <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 140</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">advance</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">data_fetcher</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    141</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>on_advance_end(data_fetcher)
<span class="ansi-green-fg ansi-bold">    142</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_restarting <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/training_epoch_loop.py:250</span>, in <span class="ansi-cyan-fg">_TrainingEpochLoop.advance</span><span class="ansi-blue-fg">(self, data_fetcher)</span>
<span class="ansi-green-fg ansi-bold">    247</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">run_training_batch</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg ansi-bold">    248</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>automatic_optimization:
<span class="ansi-green-fg ansi-bold">    249</span>         <span style="font-style:italic;color:rgb(95,135,135)"># in automatic optimization, there can only be one optimizer</span>
<span class="ansi-green-fg">--&gt; 250</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">automatic_optimization</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizers</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    251</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    252</span>         batch_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>manual_optimization<span style="color:rgb(98,98,98)">.</span>run(kwargs)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:190</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization.run</span><span class="ansi-blue-fg">(self, optimizer, batch_idx, kwargs)</span>
<span class="ansi-green-fg ansi-bold">    183</span>         closure()
<span class="ansi-green-fg ansi-bold">    185</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    186</span> <span style="font-style:italic;color:rgb(95,135,135)"># BACKWARD PASS</span>
<span class="ansi-green-fg ansi-bold">    187</span> <span style="font-style:italic;color:rgb(95,135,135)"># ------------------------------</span>
<span class="ansi-green-fg ansi-bold">    188</span> <span style="font-style:italic;color:rgb(95,135,135)"># gradient update with accumulated gradients</span>
<span class="ansi-green-fg ansi-bold">    189</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">--&gt; 190</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    192</span> result <span style="color:rgb(98,98,98)">=</span> closure<span style="color:rgb(98,98,98)">.</span>consume_result()
<span class="ansi-green-fg ansi-bold">    193</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> result<span style="color:rgb(98,98,98)">.</span>loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:268</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._optimizer_step</span><span class="ansi-blue-fg">(self, batch_idx, train_step_and_backward_closure)</span>
<span class="ansi-green-fg ansi-bold">    265</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_ready()
<span class="ansi-green-fg ansi-bold">    267</span> <span style="font-style:italic;color:rgb(95,135,135)"># model hook</span>
<span class="ansi-green-fg">--&gt; 268</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_lightning_module_hook</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">optimizer_step</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">current_epoch</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">train_step_and_backward_closure</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    277</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> should_accumulate:
<span class="ansi-green-fg ansi-bold">    278</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>optim_progress<span style="color:rgb(98,98,98)">.</span>optimizer<span style="color:rgb(98,98,98)">.</span>step<span style="color:rgb(98,98,98)">.</span>increment_completed()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:157</span>, in <span class="ansi-cyan-fg">_call_lightning_module_hook</span><span class="ansi-blue-fg">(trainer, hook_name, pl_module, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    154</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> hook_name
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[LightningModule]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>pl_module<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 157</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    159</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    160</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1303</span>, in <span class="ansi-cyan-fg">LightningModule.optimizer_step</span><span class="ansi-blue-fg">(self, epoch, batch_idx, optimizer, optimizer_closure)</span>
<span class="ansi-green-fg ansi-bold">   1264</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">optimizer_step</span>(
<span class="ansi-green-fg ansi-bold">   1265</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">   1266</span>     epoch: <span style="color:rgb(0,135,0)">int</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1269</span>     optimizer_closure: Optional[Callable[[], Any]] <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">   1270</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">   1271</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Override this method to adjust the default way the :class:`~pytorch_lightning.trainer.trainer.Trainer` calls</span>
<span class="ansi-green-fg ansi-bold">   1272</span> <span style="font-style:italic;color:rgb(175,0,0)">    the optimizer.</span>
<span class="ansi-green-fg ansi-bold">   1273</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1301</span> 
<span class="ansi-green-fg ansi-bold">   1302</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">-&gt; 1303</span>     <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">optimizer_closure</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/optimizer.py:152</span>, in <span class="ansi-cyan-fg">LightningOptimizer.step</span><span class="ansi-blue-fg">(self, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    149</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> MisconfigurationException(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">When `optimizer.step(closure)` is called, the closure should be callable</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">    151</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_strategy <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">--&gt; 152</span> step_output <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_strategy</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    154</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_on_after_step()
<span class="ansi-green-fg ansi-bold">    156</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:239</span>, in <span class="ansi-cyan-fg">Strategy.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, closure, model, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    237</span> <span style="font-style:italic;color:rgb(95,135,135)"># TODO(fabric): remove assertion once strategy's optimizer_step typing is fixed</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">isinstance</span>(model, pl<span style="color:rgb(98,98,98)">.</span>LightningModule)
<span class="ansi-green-fg">--&gt; 239</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">optimizer_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:122</span>, in <span class="ansi-cyan-fg">Precision.optimizer_step</span><span class="ansi-blue-fg">(self, optimizer, model, closure, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    120</span> <span style="font-style:italic;color:rgb(175,0,0)">"""Hook to run the optimizer step."""</span>
<span class="ansi-green-fg ansi-bold">    121</span> closure <span style="color:rgb(98,98,98)">=</span> partial(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_wrap_closure, model, optimizer, closure)
<span class="ansi-green-fg">--&gt; 122</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">optimizer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:391</span>, in <span class="ansi-cyan-fg">Optimizer.profile_hook_step.&lt;locals&gt;.wrapper</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    386</span>         <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    387</span>             <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(
<span class="ansi-green-fg ansi-bold">    388</span>                 <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>func<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> must return None or a tuple of (new_args, new_kwargs), but got </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>result<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    389</span>             )
<span class="ansi-green-fg">--&gt; 391</span> out <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    392</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_optimizer_step_code()
<span class="ansi-green-fg ansi-bold">    394</span> <span style="font-style:italic;color:rgb(95,135,135)"># call optimizer step post hooks</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/optimizer.py:76</span>, in <span class="ansi-cyan-fg">_use_grad_for_differentiable.&lt;locals&gt;._use_grad</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     74</span>     torch<span style="color:rgb(98,98,98)">.</span>set_grad_enabled(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>defaults[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">differentiable</span><span style="color:rgb(175,0,0)">'</span>])
<span class="ansi-green-fg ansi-bold">     75</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()
<span class="ansi-green-fg">---&gt; 76</span>     ret <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     77</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">     78</span>     torch<span style="color:rgb(98,98,98)">.</span>_dynamo<span style="color:rgb(98,98,98)">.</span>graph_break()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/optim/rmsprop.py:109</span>, in <span class="ansi-cyan-fg">RMSprop.step</span><span class="ansi-blue-fg">(self, closure)</span>
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> closure <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">    108</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>enable_grad():
<span class="ansi-green-fg">--&gt; 109</span>         loss <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    111</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> group <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>param_groups:
<span class="ansi-green-fg ansi-bold">    112</span>     params_with_grad <span style="color:rgb(98,98,98)">=</span> []

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:108</span>, in <span class="ansi-cyan-fg">Precision._wrap_closure</span><span class="ansi-blue-fg">(self, model, optimizer, closure)</span>
<span class="ansi-green-fg ansi-bold">     95</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">_wrap_closure</span>(
<span class="ansi-green-fg ansi-bold">     96</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">     97</span>     model: <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">pl.LightningModule</span><span style="color:rgb(175,0,0)">"</span>,
<span class="ansi-green-fg ansi-bold">     98</span>     optimizer: Optimizer,
<span class="ansi-green-fg ansi-bold">     99</span>     closure: Callable[[], Any],
<span class="ansi-green-fg ansi-bold">    100</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Any:
<span class="ansi-green-fg ansi-bold">    101</span> <span style="color:rgb(188,188,188)">    </span><span style="font-style:italic;color:rgb(175,0,0)">"""This double-closure allows makes sure the ``closure`` is executed before the ``on_before_optimizer_step``</span>
<span class="ansi-green-fg ansi-bold">    102</span> <span style="font-style:italic;color:rgb(175,0,0)">    hook is called.</span>
<span class="ansi-green-fg ansi-bold">    103</span> 
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    106</span> 
<span class="ansi-green-fg ansi-bold">    107</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">--&gt; 108</span>     closure_result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    109</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_after_closure(model, optimizer)
<span class="ansi-green-fg ansi-bold">    110</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> closure_result

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:144</span>, in <span class="ansi-cyan-fg">Closure.__call__</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    142</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">    143</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">__call__</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(98,98,98)">*</span>args: Any, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Optional[Tensor]:
<span class="ansi-green-fg">--&gt; 144</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    145</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_result<span style="color:rgb(98,98,98)">.</span>loss

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/utils/_contextlib.py:115</span>, in <span class="ansi-cyan-fg">context_decorator.&lt;locals&gt;.decorate_context</span><span class="ansi-blue-fg">(*args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    112</span> <span style="color:rgb(175,0,255)">@functools</span><span style="color:rgb(98,98,98)">.</span>wraps(func)
<span class="ansi-green-fg ansi-bold">    113</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">decorate_context</span>(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs):
<span class="ansi-green-fg ansi-bold">    114</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> ctx_factory():
<span class="ansi-green-fg">--&gt; 115</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">func</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:138</span>, in <span class="ansi-cyan-fg">Closure.closure</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    135</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_zero_grad_fn()
<span class="ansi-green-fg ansi-bold">    137</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="font-weight:bold;color:rgb(175,0,255)">and</span> step_output<span style="color:rgb(98,98,98)">.</span>closure_loss <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 138</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_backward_fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">step_output</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    140</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> step_output

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/optimization/automatic.py:239</span>, in <span class="ansi-cyan-fg">_AutomaticOptimization._make_backward_fn.&lt;locals&gt;.backward_fn</span><span class="ansi-blue-fg">(loss)</span>
<span class="ansi-green-fg ansi-bold">    238</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward_fn</span>(loss: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg">--&gt; 239</span>     <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_strategy_hook</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">backward</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:309</span>, in <span class="ansi-cyan-fg">_call_strategy_hook</span><span class="ansi-blue-fg">(trainer, hook_name, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    306</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    308</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Strategy]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 309</span>     output <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    311</span> <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    312</span> pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/strategies/strategy.py:213</span>, in <span class="ansi-cyan-fg">Strategy.backward</span><span class="ansi-blue-fg">(self, closure_loss, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    211</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>pre_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg">--&gt; 213</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">precision_plugin</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">closure_loss</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">optimizer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    215</span> closure_loss <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>precision_plugin<span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss, <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module)
<span class="ansi-green-fg ansi-bold">    216</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>post_backward(closure_loss)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/plugins/precision/precision.py:72</span>, in <span class="ansi-cyan-fg">Precision.backward</span><span class="ansi-blue-fg">(self, tensor, model, optimizer, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     52</span> <span style="color:rgb(175,0,255)">@override</span>
<span class="ansi-green-fg ansi-bold">     53</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">backward</span>(  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[override]</span>
<span class="ansi-green-fg ansi-bold">     54</span>     <span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     59</span>     <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs: Any,
<span class="ansi-green-fg ansi-bold">     60</span> ) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     61</span> <span style="color:rgb(188,188,188)">    </span><span style="color:rgb(175,0,0)">r</span><span style="font-style:italic;color:rgb(175,0,0)">"""Performs the actual backpropagation.</span>
<span class="ansi-green-fg ansi-bold">     62</span> 
<span class="ansi-green-fg ansi-bold">     63</span> <span style="font-style:italic;color:rgb(175,0,0)">    Args:</span>
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">     70</span> 
<span class="ansi-green-fg ansi-bold">     71</span> <span style="font-style:italic;color:rgb(175,0,0)">    """</span>
<span class="ansi-green-fg">---&gt; 72</span>     <span class="ansi-yellow-bg">model</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">tensor</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/core/module.py:1090</span>, in <span class="ansi-cyan-fg">LightningModule.backward</span><span class="ansi-blue-fg">(self, loss, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1088</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_fabric<span style="color:rgb(98,98,98)">.</span>backward(loss, <span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg ansi-bold">   1089</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1090</span>     <span class="ansi-yellow-bg">loss</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/_tensor.py:525</span>, in <span class="ansi-cyan-fg">Tensor.backward</span><span class="ansi-blue-fg">(self, gradient, retain_graph, create_graph, inputs)</span>
<span class="ansi-green-fg ansi-bold">    515</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> has_torch_function_unary(<span style="color:rgb(0,135,0)">self</span>):
<span class="ansi-green-fg ansi-bold">    516</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> handle_torch_function(
<span class="ansi-green-fg ansi-bold">    517</span>         Tensor<span style="color:rgb(98,98,98)">.</span>backward,
<span class="ansi-green-fg ansi-bold">    518</span>         (<span style="color:rgb(0,135,0)">self</span>,),
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">    523</span>         inputs<span style="color:rgb(98,98,98)">=</span>inputs,
<span class="ansi-green-fg ansi-bold">    524</span>     )
<span class="ansi-green-fg">--&gt; 525</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">autograd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    526</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">gradient</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">inputs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">inputs</span>
<span class="ansi-green-fg ansi-bold">    527</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/__init__.py:267</span>, in <span class="ansi-cyan-fg">backward</span><span class="ansi-blue-fg">(tensors, grad_tensors, retain_graph, create_graph, grad_variables, inputs)</span>
<span class="ansi-green-fg ansi-bold">    262</span>     retain_graph <span style="color:rgb(98,98,98)">=</span> create_graph
<span class="ansi-green-fg ansi-bold">    264</span> <span style="font-style:italic;color:rgb(95,135,135)"># The reason we repeat the same comment below is that</span>
<span class="ansi-green-fg ansi-bold">    265</span> <span style="font-style:italic;color:rgb(95,135,135)"># some Python versions print out the first line of a multi-line function</span>
<span class="ansi-green-fg ansi-bold">    266</span> <span style="font-style:italic;color:rgb(95,135,135)"># calls in the traceback and some print out the last line</span>
<span class="ansi-green-fg">--&gt; 267</span> <span class="ansi-yellow-bg">_engine_run_backward</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    268</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">tensors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    269</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">grad_tensors_</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    270</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">retain_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    271</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">create_graph</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    272</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">inputs</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    273</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">allow_unreachable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    274</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">accumulate_grad</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">True</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    275</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/autograd/graph.py:744</span>, in <span class="ansi-cyan-fg">_engine_run_backward</span><span class="ansi-blue-fg">(t_outputs, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    742</span>     unregister_hooks <span style="color:rgb(98,98,98)">=</span> _register_logging_hooks_on_whole_graph(t_outputs)
<span class="ansi-green-fg ansi-bold">    743</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg">--&gt; 744</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">Variable</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_execution_engine</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run_backward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">  </span><span style="font-style:italic;color:rgb(95,135,135)" class="ansi-yellow-bg"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    745</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">t_outputs</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span>
<span class="ansi-green-fg ansi-bold">    746</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">)</span>  <span style="font-style:italic;color:rgb(95,135,135)"># Calls into the C++ engine to run the backward pass</span>
<span class="ansi-green-fg ansi-bold">    747</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">    748</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> attach_logging_hooks:

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>This model can take 10 minutes or more to run and achieves about 42% accuracy on the test data. Although this is not terrible for 100-class data (a random classifier gets 1% accuracy), searching the web we see results around 75%. Typically it takes a lot of architecture carpentry, fiddling with regularization, and time, to achieve such results.</p>
<p>Let’s take a look at the validation and training accuracy across epochs.</p>
<div id="105861bc" class="cell" data-execution_count="59">
<div class="sourceCode cell-code" id="cb86"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb86-1"><a href="#cb86-1" aria-hidden="true" tabindex="-1"></a>log_path <span class="op">=</span> cifar_logger.experiment.metrics_file_path</span>
<span id="cb86-2"><a href="#cb86-2" aria-hidden="true" tabindex="-1"></a>cifar_results <span class="op">=</span> pd.read_csv(log_path)</span>
<span id="cb86-3"><a href="#cb86-3" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb86-4"><a href="#cb86-4" aria-hidden="true" tabindex="-1"></a>summary_plot(cifar_results,</span>
<span id="cb86-5"><a href="#cb86-5" aria-hidden="true" tabindex="-1"></a>             ax,</span>
<span id="cb86-6"><a href="#cb86-6" aria-hidden="true" tabindex="-1"></a>             col<span class="op">=</span><span class="st">'accuracy'</span>,</span>
<span id="cb86-7"><a href="#cb86-7" aria-hidden="true" tabindex="-1"></a>             ylabel<span class="op">=</span><span class="st">'Accuracy'</span>)</span>
<span id="cb86-8"><a href="#cb86-8" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">6</span>).astype(<span class="bu">int</span>))</span>
<span id="cb86-9"><a href="#cb86-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb86-10"><a href="#cb86-10" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="dv">0</span>, <span class="dv">1</span>])<span class="op">;</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[59], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> log_path <span style="color:rgb(98,98,98)">=</span> cifar_logger<span style="color:rgb(98,98,98)">.</span>experiment<span style="color:rgb(98,98,98)">.</span>metrics_file_path
<span class="ansi-green-fg">----&gt; 2</span> cifar_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">log_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      3</span> fig, ax <span style="color:rgb(98,98,98)">=</span> subplots(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>, figsize<span style="color:rgb(98,98,98)">=</span>(<span style="color:rgb(98,98,98)">6</span>, <span style="color:rgb(98,98,98)">6</span>))
<span class="ansi-green-fg ansi-bold">      4</span> summary_plot(cifar_results,
<span class="ansi-green-fg ansi-bold">      5</span>              ax,
<span class="ansi-green-fg ansi-bold">      6</span>              col<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">accuracy</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      7</span>              ylabel<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Accuracy</span><span style="color:rgb(175,0,0)">'</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg ansi-bold">   1013</span> kwds_defaults <span style="color:rgb(98,98,98)">=</span> _refine_defaults_read(
<span class="ansi-green-fg ansi-bold">   1014</span>     dialect,
<span class="ansi-green-fg ansi-bold">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1022</span>     dtype_backend<span style="color:rgb(98,98,98)">=</span>dtype_backend,
<span class="ansi-green-fg ansi-bold">   1023</span> )
<span class="ansi-green-fg ansi-bold">   1024</span> kwds<span style="color:rgb(98,98,98)">.</span>update(kwds_defaults)
<span class="ansi-green-fg">-&gt; 1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg ansi-bold">    617</span> _validate_names(kwds<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">names</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg ansi-bold">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; 620</span> parser <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg ansi-bold">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg ansi-bold">   1617</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>options[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> kwds[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">   1619</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles: IOHandles <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; 1620</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg ansi-bold">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg ansi-bold">   1879</span>         mode <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">-&gt; 1880</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">compression</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">memory_map</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding_errors</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">strict</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">storage_options</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1891</span> f <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles<span style="color:rgb(98,98,98)">.</span>handle

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg ansi-bold">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg ansi-bold">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg ansi-bold">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg ansi-bold">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs<span style="color:rgb(98,98,98)">.</span>encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs<span style="color:rgb(98,98,98)">.</span>mode:
<span class="ansi-green-fg ansi-bold">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; 873</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg ansi-bold">    882</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">open</span>(handle, ioargs<span style="color:rgb(98,98,98)">.</span>mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'logs/CIFAR100/version_0/metrics.csv'</pre>
</div>
</div>
</div>
<p>Finally, we evaluate our model on our test data.</p>
<div id="de1389d6" class="cell" data-execution_count="60">
<div class="sourceCode cell-code" id="cb87"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb87-1"><a href="#cb87-1" aria-hidden="true" tabindex="-1"></a>cifar_trainer.test(cifar_module,</span>
<span id="cb87-2"><a href="#cb87-2" aria-hidden="true" tabindex="-1"></a>                   datamodule<span class="op">=</span>cifar_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-stdout">
<pre><code>────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
       Test metric             DataLoader 0
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────
      test_accuracy        0.010900000110268593
        test_loss           4.6055097579956055
────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="60">
<pre><code>[{'test_loss': 4.6055097579956055, 'test_accuracy': 0.010900000110268593}]</code></pre>
</div>
</div>
<section id="hardware-acceleration" class="level3">
<h3 class="anchored" data-anchor-id="hardware-acceleration">Hardware Acceleration</h3>
<p>As deep learning has become ubiquitous in machine learning, hardware manufacturers have produced special libraries that can often speed up the gradient-descent steps.</p>
<p>For instance, Mac OS devices with the M1 chip may have the <em>Metal</em> programming framework enabled, which can speed up the <code>torch</code> computations. We present an example of how to use this acceleration.</p>
<p>The main changes are to the <code>Trainer()</code> call as well as to the metrics that will be evaluated on the data. These metrics must be told where the data will be located at evaluation time. This is accomplished with a call to the <code>to()</code> method of the metrics.</p>
<div id="b13c4aff" class="cell" data-execution_count="61">
<div class="sourceCode cell-code" id="cb91"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb91-1"><a href="#cb91-1" aria-hidden="true" tabindex="-1"></a><span class="cf">try</span>:</span>
<span id="cb91-2"><a href="#cb91-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> name, metric <span class="kw">in</span> cifar_module.metrics.items():</span>
<span id="cb91-3"><a href="#cb91-3" aria-hidden="true" tabindex="-1"></a>        cifar_module.metrics[name] <span class="op">=</span> metric.to(<span class="st">'mps'</span>)</span>
<span id="cb91-4"><a href="#cb91-4" aria-hidden="true" tabindex="-1"></a>    cifar_trainer_mps <span class="op">=</span> Trainer(accelerator<span class="op">=</span><span class="st">'mps'</span>,</span>
<span id="cb91-5"><a href="#cb91-5" aria-hidden="true" tabindex="-1"></a>                                deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb91-6"><a href="#cb91-6" aria-hidden="true" tabindex="-1"></a>                                enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb91-7"><a href="#cb91-7" aria-hidden="true" tabindex="-1"></a>                                max_epochs<span class="op">=</span><span class="dv">30</span>)</span>
<span id="cb91-8"><a href="#cb91-8" aria-hidden="true" tabindex="-1"></a>    cifar_trainer_mps.fit(cifar_module,</span>
<span id="cb91-9"><a href="#cb91-9" aria-hidden="true" tabindex="-1"></a>                          datamodule<span class="op">=</span>cifar_dm)</span>
<span id="cb91-10"><a href="#cb91-10" aria-hidden="true" tabindex="-1"></a>    cifar_trainer_mps.test(cifar_module,</span>
<span id="cb91-11"><a href="#cb91-11" aria-hidden="true" tabindex="-1"></a>                          datamodule<span class="op">=</span>cifar_dm)</span>
<span id="cb91-12"><a href="#cb91-12" aria-hidden="true" tabindex="-1"></a><span class="cf">except</span>:</span>
<span id="cb91-13"><a href="#cb91-13" aria-hidden="true" tabindex="-1"></a>    <span class="cf">pass</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>This yields approximately two- or three-fold acceleration for each epoch. We have protected this code block using <code>try:</code> and <code>except:</code> clauses; if it works, we get the speedup, if it fails, nothing happens.</p>
</section>
</section>
<section id="using-pretrained-cnn-models" class="level2">
<h2 class="anchored" data-anchor-id="using-pretrained-cnn-models">Using Pretrained CNN Models</h2>
<p>We now show how to use a CNN pretrained on the <code>imagenet</code> database to classify natural images, and demonstrate how we produced Figure~. We copied six JPEG images from a digital photo album into the directory <code>book_images</code>. These images are available from the data section of &lt;www.statlearning.com&gt;, the ISLP book website. Download <code>book_images.zip</code>; when clicked it creates the <code>book_images</code> directory.</p>
<p>The pretrained network we use is called <code>resnet50</code>; specification details can be found on the web. We will read in the images, and convert them into the array format expected by the <code>torch</code> software to match the specifications in <code>resnet50</code>. The conversion involves a resize, a crop and then a predefined standardization for each of the three channels. We now read in the images and preprocess them.</p>
<div id="2dbba5ae" class="cell" data-execution_count="62">
<div class="sourceCode cell-code" id="cb92"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb92-1"><a href="#cb92-1" aria-hidden="true" tabindex="-1"></a>resize <span class="op">=</span> Resize((<span class="dv">232</span>,<span class="dv">232</span>), antialias<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb92-2"><a href="#cb92-2" aria-hidden="true" tabindex="-1"></a>crop <span class="op">=</span> CenterCrop(<span class="dv">224</span>)</span>
<span id="cb92-3"><a href="#cb92-3" aria-hidden="true" tabindex="-1"></a>normalize <span class="op">=</span> Normalize([<span class="fl">0.485</span>,<span class="fl">0.456</span>,<span class="fl">0.406</span>],</span>
<span id="cb92-4"><a href="#cb92-4" aria-hidden="true" tabindex="-1"></a>                      [<span class="fl">0.229</span>,<span class="fl">0.224</span>,<span class="fl">0.225</span>])</span>
<span id="cb92-5"><a href="#cb92-5" aria-hidden="true" tabindex="-1"></a>imgfiles <span class="op">=</span> <span class="bu">sorted</span>([f <span class="cf">for</span> f <span class="kw">in</span> glob(<span class="st">'book_images/*'</span>)])</span>
<span id="cb92-6"><a href="#cb92-6" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> torch.stack([torch.div(crop(resize(read_image(f))), <span class="dv">255</span>)</span>
<span id="cb92-7"><a href="#cb92-7" aria-hidden="true" tabindex="-1"></a>                    <span class="cf">for</span> f <span class="kw">in</span> imgfiles])</span>
<span id="cb92-8"><a href="#cb92-8" aria-hidden="true" tabindex="-1"></a>imgs <span class="op">=</span> normalize(imgs)</span>
<span id="cb92-9"><a href="#cb92-9" aria-hidden="true" tabindex="-1"></a>imgs.size()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[62], line 6</span>
<span class="ansi-green-fg ansi-bold">      3</span> normalize <span style="color:rgb(98,98,98)">=</span> Normalize([<span style="color:rgb(98,98,98)">0.485</span>,<span style="color:rgb(98,98,98)">0.456</span>,<span style="color:rgb(98,98,98)">0.406</span>],
<span class="ansi-green-fg ansi-bold">      4</span>                       [<span style="color:rgb(98,98,98)">0.229</span>,<span style="color:rgb(98,98,98)">0.224</span>,<span style="color:rgb(98,98,98)">0.225</span>])
<span class="ansi-green-fg ansi-bold">      5</span> imgfiles <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">sorted</span>([f <span style="font-weight:bold;color:rgb(0,135,0)">for</span> f <span style="font-weight:bold;color:rgb(175,0,255)">in</span> glob(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">book_images/*</span><span style="color:rgb(175,0,0)">'</span>)])
<span class="ansi-green-fg">----&gt; 6</span> imgs <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">stack</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">torch</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">div</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">crop</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">resize</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">read_image</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">255</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span class="ansi-yellow-bg">                    </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">for</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(175,0,255)" class="ansi-yellow-bg">in</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">imgfiles</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      8</span> imgs <span style="color:rgb(98,98,98)">=</span> normalize(imgs)
<span class="ansi-green-fg ansi-bold">      9</span> imgs<span style="color:rgb(98,98,98)">.</span>size()

<span class="ansi-red-fg">RuntimeError</span>: stack expects a non-empty TensorList</pre>
</div>
</div>
</div>
<p>We now set up the trained network with the weights we read in code block~6. The model has 50 layers, with a fair bit of complexity.</p>
<div id="78ed79f9" class="cell" data-execution_count="63">
<div class="sourceCode cell-code" id="cb93"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb93-1"><a href="#cb93-1" aria-hidden="true" tabindex="-1"></a>resnet_model <span class="op">=</span> resnet50(weights<span class="op">=</span>ResNet50_Weights.DEFAULT)</span>
<span id="cb93-2"><a href="#cb93-2" aria-hidden="true" tabindex="-1"></a>summary(resnet_model,</span>
<span id="cb93-3"><a href="#cb93-3" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>imgs,</span>
<span id="cb93-4"><a href="#cb93-4" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb93-5"><a href="#cb93-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb93-6"><a href="#cb93-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[63], line 3</span>
<span class="ansi-green-fg ansi-bold">      1</span> resnet_model <span style="color:rgb(98,98,98)">=</span> resnet50(weights<span style="color:rgb(98,98,98)">=</span>ResNet50_Weights<span style="color:rgb(98,98,98)">.</span>DEFAULT)
<span class="ansi-green-fg ansi-bold">      2</span> summary(resnet_model,
<span class="ansi-green-fg">----&gt; 3</span>         input_data<span style="color:rgb(98,98,98)">=</span><span class="ansi-yellow-bg">imgs</span>,
<span class="ansi-green-fg ansi-bold">      4</span>         col_names<span style="color:rgb(98,98,98)">=</span>[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">input_size</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      5</span>                    <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">output_size</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      6</span>                    <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">num_params</span><span style="color:rgb(175,0,0)">'</span>])

<span class="ansi-red-fg">NameError</span>: name 'imgs' is not defined</pre>
</div>
</div>
</div>
<p>We set the mode to <code>eval()</code> to ensure that the model is ready to predict on new data.</p>
<div id="5baa444f" class="cell" data-execution_count="64">
<div class="sourceCode cell-code" id="cb94"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb94-1"><a href="#cb94-1" aria-hidden="true" tabindex="-1"></a>resnet_model.<span class="bu">eval</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="64">
<pre><code>ResNet(
  (conv1): Conv2d(3, 64, kernel_size=(7, 7), stride=(2, 2), padding=(3, 3), bias=False)
  (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
  (relu): ReLU(inplace=True)
  (maxpool): MaxPool2d(kernel_size=3, stride=2, padding=1, dilation=1, ceil_mode=False)
  (layer1): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(64, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
        (1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(256, 64, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(64, 64, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(64, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(64, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer2): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(256, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(256, 512, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (3): Bottleneck(
      (conv1): Conv2d(512, 128, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(128, 128, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(128, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(128, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer3): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(512, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(512, 1024, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (3): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (4): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (5): Bottleneck(
      (conv1): Conv2d(1024, 256, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(256, 256, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(256, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(256, 1024, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(1024, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (layer4): Sequential(
    (0): Bottleneck(
      (conv1): Conv2d(1024, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(2, 2), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
      (downsample): Sequential(
        (0): Conv2d(1024, 2048, kernel_size=(1, 1), stride=(2, 2), bias=False)
        (1): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      )
    )
    (1): Bottleneck(
      (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
    (2): Bottleneck(
      (conv1): Conv2d(2048, 512, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn1): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv2): Conv2d(512, 512, kernel_size=(3, 3), stride=(1, 1), padding=(1, 1), bias=False)
      (bn2): BatchNorm2d(512, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (conv3): Conv2d(512, 2048, kernel_size=(1, 1), stride=(1, 1), bias=False)
      (bn3): BatchNorm2d(2048, eps=1e-05, momentum=0.1, affine=True, track_running_stats=True)
      (relu): ReLU(inplace=True)
    )
  )
  (avgpool): AdaptiveAvgPool2d(output_size=(1, 1))
  (fc): Linear(in_features=2048, out_features=1000, bias=True)
)</code></pre>
</div>
</div>
<p>Inspecting the output above, we see that when setting up the <code>resnet_model</code>, the authors defined a <code>Bottleneck</code>, much like our <code>BuildingBlock</code> module.</p>
<p>We now feed our six images through the fitted network.</p>
<div id="59a13982" class="cell" data-execution_count="65">
<div class="sourceCode cell-code" id="cb96"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb96-1"><a href="#cb96-1" aria-hidden="true" tabindex="-1"></a>img_preds <span class="op">=</span> resnet_model(imgs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[65], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> img_preds <span style="color:rgb(98,98,98)">=</span> resnet_model(<span class="ansi-yellow-bg">imgs</span>)

<span class="ansi-red-fg">NameError</span>: name 'imgs' is not defined</pre>
</div>
</div>
</div>
<p>Let’s look at the predicted probabilities for each of the top 3 choices. First we compute the probabilities by applying the softmax to the logits in <code>img_preds</code>. Note that we have had to call the <code>detach()</code> method on the tensor <code>img_preds</code> in order to convert it to our a more familiar <code>ndarray</code>.</p>
<div id="3135efca" class="cell" data-execution_count="66">
<div class="sourceCode cell-code" id="cb97"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb97-1"><a href="#cb97-1" aria-hidden="true" tabindex="-1"></a>img_probs <span class="op">=</span> np.exp(np.asarray(img_preds.detach()))</span>
<span id="cb97-2"><a href="#cb97-2" aria-hidden="true" tabindex="-1"></a>img_probs <span class="op">/=</span> img_probs.<span class="bu">sum</span>(<span class="dv">1</span>)[:,<span class="va">None</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">NameError</span>                                 Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[66], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> img_probs <span style="color:rgb(98,98,98)">=</span> np<span style="color:rgb(98,98,98)">.</span>exp(np<span style="color:rgb(98,98,98)">.</span>asarray(<span class="ansi-yellow-bg">img_preds</span><span style="color:rgb(98,98,98)">.</span>detach()))
<span class="ansi-green-fg ansi-bold">      2</span> img_probs <span style="color:rgb(98,98,98)">/</span><span style="color:rgb(98,98,98)">=</span> img_probs<span style="color:rgb(98,98,98)">.</span>sum(<span style="color:rgb(98,98,98)">1</span>)[:,<span style="font-weight:bold;color:rgb(0,135,0)">None</span>]

<span class="ansi-red-fg">NameError</span>: name 'img_preds' is not defined</pre>
</div>
</div>
</div>
<p>In order to see the class labels, we must download the index file associated with <code>imagenet</code>. {This is avalable from the book website and <a href="https://s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json">s3.amazonaws.com/deep-learning-models/image-models/imagenet_class_index.json</a>.}</p>
<div id="eded5a30" class="cell" data-execution_count="67">
<div class="sourceCode cell-code" id="cb98"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb98-1"><a href="#cb98-1" aria-hidden="true" tabindex="-1"></a>labs <span class="op">=</span> json.load(<span class="bu">open</span>(<span class="st">'imagenet_class_index.json'</span>))</span>
<span id="cb98-2"><a href="#cb98-2" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> pd.DataFrame([(<span class="bu">int</span>(k), v[<span class="dv">1</span>]) <span class="cf">for</span> k, v <span class="kw">in</span> </span>
<span id="cb98-3"><a href="#cb98-3" aria-hidden="true" tabindex="-1"></a>                           labs.items()],</span>
<span id="cb98-4"><a href="#cb98-4" aria-hidden="true" tabindex="-1"></a>                           columns<span class="op">=</span>[<span class="st">'idx'</span>, <span class="st">'label'</span>])</span>
<span id="cb98-5"><a href="#cb98-5" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> class_labels.set_index(<span class="st">'idx'</span>)</span>
<span id="cb98-6"><a href="#cb98-6" aria-hidden="true" tabindex="-1"></a>class_labels <span class="op">=</span> class_labels.sort_index()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[67], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> labs <span style="color:rgb(98,98,98)">=</span> json<span style="color:rgb(98,98,98)">.</span>load(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">imagenet_class_index.json</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">      2</span> class_labels <span style="color:rgb(98,98,98)">=</span> pd<span style="color:rgb(98,98,98)">.</span>DataFrame([(<span style="color:rgb(0,135,0)">int</span>(k), v[<span style="color:rgb(98,98,98)">1</span>]) <span style="font-weight:bold;color:rgb(0,135,0)">for</span> k, v <span style="font-weight:bold;color:rgb(175,0,255)">in</span> 
<span class="ansi-green-fg ansi-bold">      3</span>                            labs<span style="color:rgb(98,98,98)">.</span>items()],
<span class="ansi-green-fg ansi-bold">      4</span>                            columns<span style="color:rgb(98,98,98)">=</span>[<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">idx</span><span style="color:rgb(175,0,0)">'</span>, <span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">label</span><span style="color:rgb(175,0,0)">'</span>])
<span class="ansi-green-fg ansi-bold">      5</span> class_labels <span style="color:rgb(98,98,98)">=</span> class_labels<span style="color:rgb(98,98,98)">.</span>set_index(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">idx</span><span style="color:rgb(175,0,0)">'</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/IPython/core/interactiveshell.py:324</span>, in <span class="ansi-cyan-fg">_modified_open</span><span class="ansi-blue-fg">(file, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    317</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> file <span style="font-weight:bold;color:rgb(175,0,255)">in</span> {<span style="color:rgb(98,98,98)">0</span>, <span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">2</span>}:
<span class="ansi-green-fg ansi-bold">    318</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">ValueError</span>(
<span class="ansi-green-fg ansi-bold">    319</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">IPython won</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">t let you open fd=</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>file<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)"> by default </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    320</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">as it is likely to crash IPython. If you know what you are doing, </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    321</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">you can use builtins</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)"> open.</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    322</span>     )
<span class="ansi-green-fg">--&gt; 324</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">io_open</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">file</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'imagenet_class_index.json'</pre>
</div>
</div>
</div>
<p>We’ll now construct a data frame for each image file with the labels with the three highest probabilities as estimated by the model above.</p>
<div id="2acf944a" class="cell" data-execution_count="68">
<div class="sourceCode cell-code" id="cb99"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb99-1"><a href="#cb99-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> i, imgfile <span class="kw">in</span> <span class="bu">enumerate</span>(imgfiles):</span>
<span id="cb99-2"><a href="#cb99-2" aria-hidden="true" tabindex="-1"></a>    img_df <span class="op">=</span> class_labels.copy()</span>
<span id="cb99-3"><a href="#cb99-3" aria-hidden="true" tabindex="-1"></a>    img_df[<span class="st">'prob'</span>] <span class="op">=</span> img_probs[i]</span>
<span id="cb99-4"><a href="#cb99-4" aria-hidden="true" tabindex="-1"></a>    img_df <span class="op">=</span> img_df.sort_values(by<span class="op">=</span><span class="st">'prob'</span>, ascending<span class="op">=</span><span class="va">False</span>)[:<span class="dv">3</span>]</span>
<span id="cb99-5"><a href="#cb99-5" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(<span class="ss">f'Image: </span><span class="sc">{</span>imgfile<span class="sc">}</span><span class="ss">'</span>)</span>
<span id="cb99-6"><a href="#cb99-6" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(img_df.reset_index().drop(columns<span class="op">=</span>[<span class="st">'idx'</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We see that the model is quite confident about <code>Flamingo.jpg</code>, but a little less so for the other images.</p>
<p>We end this section with our usual cleanup.</p>
<div id="46bb3a6f" class="cell" data-execution_count="69">
<div class="sourceCode cell-code" id="cb100"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb100-1"><a href="#cb100-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(cifar_test,</span>
<span id="cb100-2"><a href="#cb100-2" aria-hidden="true" tabindex="-1"></a>    cifar_train,</span>
<span id="cb100-3"><a href="#cb100-3" aria-hidden="true" tabindex="-1"></a>    cifar_dm,</span>
<span id="cb100-4"><a href="#cb100-4" aria-hidden="true" tabindex="-1"></a>    cifar_module,</span>
<span id="cb100-5"><a href="#cb100-5" aria-hidden="true" tabindex="-1"></a>    cifar_logger,</span>
<span id="cb100-6"><a href="#cb100-6" aria-hidden="true" tabindex="-1"></a>    cifar_optimizer,</span>
<span id="cb100-7"><a href="#cb100-7" aria-hidden="true" tabindex="-1"></a>    cifar_trainer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="imdb-document-classification" class="level2">
<h2 class="anchored" data-anchor-id="imdb-document-classification">IMDB Document Classification</h2>
<p>We now implement models for sentiment classification (Section~) on the <code>IMDB</code> dataset. As mentioned above code block~8, we are using a preprocessed version of the <code>IMDB</code> dataset found in the <code>keras</code> package. As <code>keras</code> uses <code>tensorflow</code>, a different tensor and deep learning library, we have converted the data to be suitable for <code>torch</code>. The code used to convert from <code>keras</code> is available in the module <code>ISLP.torch._make_imdb</code>. It requires some of the <code>keras</code> packages to run. These data use a dictionary of size 10,000.</p>
<p>We have stored three different representations of the review data for this lab:</p>
<ul>
<li><code>load_tensor()</code>, a sparse tensor version usable by <code>torch</code>;</li>
<li><code>load_sparse()</code>, a sparse matrix version usable by <code>sklearn</code>, since we will compare with a lasso fit;</li>
<li><code>load_sequential()</code>, a padded version of the original sequence representation, limited to the last 500 words of each review.</li>
</ul>
<div id="23db3cf9" class="cell" data-execution_count="70">
<div class="sourceCode cell-code" id="cb101"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb101-1"><a href="#cb101-1" aria-hidden="true" tabindex="-1"></a>(imdb_seq_train,</span>
<span id="cb101-2"><a href="#cb101-2" aria-hidden="true" tabindex="-1"></a> imdb_seq_test) <span class="op">=</span> load_sequential(root<span class="op">=</span><span class="st">'data/IMDB'</span>)</span>
<span id="cb101-3"><a href="#cb101-3" aria-hidden="true" tabindex="-1"></a>padded_sample <span class="op">=</span> np.asarray(imdb_seq_train.tensors[<span class="dv">0</span>][<span class="dv">0</span>])</span>
<span id="cb101-4"><a href="#cb101-4" aria-hidden="true" tabindex="-1"></a>sample_review <span class="op">=</span> padded_sample[padded_sample <span class="op">&gt;</span> <span class="dv">0</span>][:<span class="dv">12</span>]</span>
<span id="cb101-5"><a href="#cb101-5" aria-hidden="true" tabindex="-1"></a>sample_review[:<span class="dv">12</span>]</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieving "IMDB_S_train.tensor.gz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".
Retrieving "IMDB_S_test.tensor.gz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".
Retrieving "IMDB_Y_test.npy" from "http://imdb.jtaylor.su.domains/jtaylor/data/".
Retrieving "IMDB_Y_train.npy" from "http://imdb.jtaylor.su.domains/jtaylor/data/".</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="70">
<pre><code>array([   1,   14,   22,   16,   43,  530,  973, 1622, 1385,   65,  458,
       4468], dtype=int32)</code></pre>
</div>
</div>
<p>The datasets <code>imdb_seq_train</code> and <code>imdb_seq_test</code> are both instances of the class <code>TensorDataset</code>. The tensors used to construct them can be found in the <code>tensors</code> attribute, with the first tensor the features <code>X</code> and the second the outcome <code>Y</code>. We have taken the first row of features and stored it as <code>padded_sample</code>. In the preprocessing used to form these data, sequences were padded with 0s in the beginning if they were not long enough, hence we remove this padding by restricting to entries where <code>padded_sample &gt; 0</code>. We then provide the first 12 words of the sample review.</p>
<p>We can find these words in the <code>lookup</code> dictionary from the <code>ISLP.torch.imdb</code> module.</p>
<div id="0e0e3b96" class="cell" data-execution_count="71">
<div class="sourceCode cell-code" id="cb104"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb104-1"><a href="#cb104-1" aria-hidden="true" tabindex="-1"></a>lookup <span class="op">=</span> load_lookup(root<span class="op">=</span><span class="st">'data/IMDB'</span>)</span>
<span id="cb104-2"><a href="#cb104-2" aria-hidden="true" tabindex="-1"></a><span class="co">' '</span>.join(lookup[i] <span class="cf">for</span> i <span class="kw">in</span> sample_review)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieving "IMDB_word_index.pkl" from "http://imdb.jtaylor.su.domains/jtaylor/data/".</code></pre>
</div>
<div class="cell-output cell-output-display" data-execution_count="71">
<pre><code>"&lt;START&gt; this film was just brilliant casting location scenery story direction everyone's"</code></pre>
</div>
</div>
<p>For our first model, we have created a binary feature for each of the 10,000 possible words in the dataset, with an entry of one in the <span class="math inline">i,j</span> entry if word <span class="math inline">j</span> appears in review <span class="math inline">i</span>. As most reviews are quite short, such a feature matrix has over 98% zeros. These data are accessed using <code>load_tensor()</code> from the <code>ISLP</code> library.</p>
<div id="638766b7" class="cell" data-execution_count="72">
<div class="sourceCode cell-code" id="cb107"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb107-1"><a href="#cb107-1" aria-hidden="true" tabindex="-1"></a>max_num_workers<span class="op">=</span><span class="dv">10</span></span>
<span id="cb107-2"><a href="#cb107-2" aria-hidden="true" tabindex="-1"></a>(imdb_train,</span>
<span id="cb107-3"><a href="#cb107-3" aria-hidden="true" tabindex="-1"></a> imdb_test) <span class="op">=</span> load_tensor(root<span class="op">=</span><span class="st">'data/IMDB'</span>)</span>
<span id="cb107-4"><a href="#cb107-4" aria-hidden="true" tabindex="-1"></a>imdb_dm <span class="op">=</span> SimpleDataModule(imdb_train,</span>
<span id="cb107-5"><a href="#cb107-5" aria-hidden="true" tabindex="-1"></a>                           imdb_test,</span>
<span id="cb107-6"><a href="#cb107-6" aria-hidden="true" tabindex="-1"></a>                           validation<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb107-7"><a href="#cb107-7" aria-hidden="true" tabindex="-1"></a>                           num_workers<span class="op">=</span><span class="bu">min</span>(<span class="dv">6</span>, max_num_workers),</span>
<span id="cb107-8"><a href="#cb107-8" aria-hidden="true" tabindex="-1"></a>                           batch_size<span class="op">=</span><span class="dv">512</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieving "IMDB_X_test.tensor.gz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".
Retrieving "IMDB_X_train.tensor.gz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".</code></pre>
</div>
</div>
<p>We’ll use a two-layer model for our first model.</p>
<div id="3e6f5d35" class="cell" data-execution_count="73">
<div class="sourceCode cell-code" id="cb109"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb109-1"><a href="#cb109-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> IMDBModel(nn.Module):</span>
<span id="cb109-2"><a href="#cb109-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-3"><a href="#cb109-3" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size):</span>
<span id="cb109-4"><a href="#cb109-4" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(IMDBModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb109-5"><a href="#cb109-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense1 <span class="op">=</span> nn.Linear(input_size, <span class="dv">16</span>)</span>
<span id="cb109-6"><a href="#cb109-6" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.activation <span class="op">=</span> nn.ReLU()</span>
<span id="cb109-7"><a href="#cb109-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense2 <span class="op">=</span> nn.Linear(<span class="dv">16</span>, <span class="dv">16</span>)</span>
<span id="cb109-8"><a href="#cb109-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.output <span class="op">=</span> nn.Linear(<span class="dv">16</span>, <span class="dv">1</span>)</span>
<span id="cb109-9"><a href="#cb109-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb109-10"><a href="#cb109-10" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb109-11"><a href="#cb109-11" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> x</span>
<span id="cb109-12"><a href="#cb109-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">for</span> _map <span class="kw">in</span> [<span class="va">self</span>.dense1,</span>
<span id="cb109-13"><a href="#cb109-13" aria-hidden="true" tabindex="-1"></a>                     <span class="va">self</span>.activation,</span>
<span id="cb109-14"><a href="#cb109-14" aria-hidden="true" tabindex="-1"></a>                     <span class="va">self</span>.dense2,</span>
<span id="cb109-15"><a href="#cb109-15" aria-hidden="true" tabindex="-1"></a>                     <span class="va">self</span>.activation,</span>
<span id="cb109-16"><a href="#cb109-16" aria-hidden="true" tabindex="-1"></a>                     <span class="va">self</span>.output]:</span>
<span id="cb109-17"><a href="#cb109-17" aria-hidden="true" tabindex="-1"></a>            val <span class="op">=</span> _map(val)</span>
<span id="cb109-18"><a href="#cb109-18" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.flatten(val)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We now instantiate our model and look at a summary.</p>
<div id="5bb42ad0" class="cell" data-execution_count="74">
<div class="sourceCode cell-code" id="cb110"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb110-1"><a href="#cb110-1" aria-hidden="true" tabindex="-1"></a>imdb_model <span class="op">=</span> IMDBModel(imdb_test.tensors[<span class="dv">0</span>].size()[<span class="dv">1</span>])</span>
<span id="cb110-2"><a href="#cb110-2" aria-hidden="true" tabindex="-1"></a>summary(imdb_model,</span>
<span id="cb110-3"><a href="#cb110-3" aria-hidden="true" tabindex="-1"></a>        input_size<span class="op">=</span>imdb_test.tensors[<span class="dv">0</span>].size(),</span>
<span id="cb110-4"><a href="#cb110-4" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb110-5"><a href="#cb110-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb110-6"><a href="#cb110-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torchinfo/torchinfo.py:295</span>, in <span class="ansi-cyan-fg">forward_pass</span><span class="ansi-blue-fg">(model, x, batch_dim, cache_forward_pass, device, mode, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    294</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">isinstance</span>(x, (<span style="color:rgb(0,135,0)">list</span>, <span style="color:rgb(0,135,0)">tuple</span>)):
<span class="ansi-green-fg">--&gt; 295</span>     _ <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    296</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(x, <span style="color:rgb(0,135,0)">dict</span>):

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1582</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1580</span>     args <span style="color:rgb(98,98,98)">=</span> bw_hook<span style="color:rgb(98,98,98)">.</span>setup_input_hook(args)
<span class="ansi-green-fg">-&gt; 1582</span> result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1583</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks:

Cell <span class="ansi-green-fg">In[73], line 17</span>, in <span class="ansi-cyan-fg">IMDBModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     12</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> _map <span style="font-weight:bold;color:rgb(175,0,255)">in</span> [<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense1,
<span class="ansi-green-fg ansi-bold">     13</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     14</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense2,
<span class="ansi-green-fg ansi-bold">     15</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     16</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>output]:
<span class="ansi-green-fg">---&gt; 17</span>     val <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">_map</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     18</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(val)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1582</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1580</span>     args <span style="color:rgb(98,98,98)">=</span> bw_hook<span style="color:rgb(98,98,98)">.</span>setup_input_hook(args)
<span class="ansi-green-fg">-&gt; 1582</span> result <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1583</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks:

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility

The above exception was the direct cause of the following exception:

<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[74], line 2</span>
<span class="ansi-green-fg ansi-bold">      1</span> imdb_model <span style="color:rgb(98,98,98)">=</span> IMDBModel(imdb_test<span style="color:rgb(98,98,98)">.</span>tensors[<span style="color:rgb(98,98,98)">0</span>]<span style="color:rgb(98,98,98)">.</span>size()[<span style="color:rgb(98,98,98)">1</span>])
<span class="ansi-green-fg">----&gt; 2</span> <span class="ansi-yellow-bg">summary</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">imdb_model</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      3</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">input_size</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">imdb_test</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">tensors</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">0</span><span class="ansi-yellow-bg">]</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">size</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      4</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">col_names</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">[</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">input_size</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      5</span> <span class="ansi-yellow-bg">                   </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">output_size</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      6</span> <span class="ansi-yellow-bg">                   </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">num_params</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">'</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torchinfo/torchinfo.py:223</span>, in <span class="ansi-cyan-fg">summary</span><span class="ansi-blue-fg">(model, input_size, input_data, batch_dim, cache_forward_pass, col_names, col_width, depth, device, dtypes, mode, row_settings, verbose, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    216</span> validate_user_params(
<span class="ansi-green-fg ansi-bold">    217</span>     input_data, input_size, columns, col_width, device, dtypes, verbose
<span class="ansi-green-fg ansi-bold">    218</span> )
<span class="ansi-green-fg ansi-bold">    220</span> x, correct_input_size <span style="color:rgb(98,98,98)">=</span> process_input(
<span class="ansi-green-fg ansi-bold">    221</span>     input_data, input_size, batch_dim, device, dtypes
<span class="ansi-green-fg ansi-bold">    222</span> )
<span class="ansi-green-fg">--&gt; 223</span> summary_list <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">forward_pass</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    224</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_dim</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">cache_forward_pass</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">device</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model_mode</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span>
<span class="ansi-green-fg ansi-bold">    225</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    226</span> formatting <span style="color:rgb(98,98,98)">=</span> FormattingOptions(depth, verbose, columns, col_width, rows)
<span class="ansi-green-fg ansi-bold">    227</span> results <span style="color:rgb(98,98,98)">=</span> ModelStatistics(
<span class="ansi-green-fg ansi-bold">    228</span>     summary_list, correct_input_size, get_total_memory_used(x), formatting
<span class="ansi-green-fg ansi-bold">    229</span> )

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torchinfo/torchinfo.py:304</span>, in <span class="ansi-cyan-fg">forward_pass</span><span class="ansi-blue-fg">(model, x, batch_dim, cache_forward_pass, device, mode, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    302</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">Exception</span> <span style="font-weight:bold;color:rgb(0,135,0)">as</span> e:
<span class="ansi-green-fg ansi-bold">    303</span>     executed_layers <span style="color:rgb(98,98,98)">=</span> [layer <span style="font-weight:bold;color:rgb(0,135,0)">for</span> layer <span style="font-weight:bold;color:rgb(175,0,255)">in</span> summary_list <span style="font-weight:bold;color:rgb(0,135,0)">if</span> layer<span style="color:rgb(98,98,98)">.</span>executed]
<span class="ansi-green-fg">--&gt; 304</span>     <span style="font-weight:bold;color:rgb(0,135,0)">raise</span> <span style="font-weight:bold;color:rgb(215,95,95)">RuntimeError</span>(
<span class="ansi-green-fg ansi-bold">    305</span>         <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Failed to run torchinfo. See above stack traces for more details. </span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    306</span>         <span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">Executed layers up to: </span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>executed_layers<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg ansi-bold">    307</span>     ) <span style="font-weight:bold;color:rgb(0,135,0)">from</span><span style="color:rgb(188,188,188)"> </span><span style="font-weight:bold;color:rgb(0,0,255)">e</span>
<span class="ansi-green-fg ansi-bold">    308</span> <span style="font-weight:bold;color:rgb(0,135,0)">finally</span>:
<span class="ansi-green-fg ansi-bold">    309</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> hooks:

<span class="ansi-red-fg">RuntimeError</span>: Failed to run torchinfo. See above stack traces for more details. Executed layers up to: [Linear: 1, ReLU: 1, Linear: 1, ReLU: 1]</pre>
</div>
</div>
</div>
<p>We’ll again use a smaller learning rate for these data, hence we pass an <code>optimizer</code> to the <code>SimpleModule</code>. Since the reviews are classified into positive or negative sentiment, we use <code>SimpleModule.binary_classification()</code>. {Our use of <code>binary_classification()</code> instead of <code>classification()</code> is due to some subtlety in how <code>torchmetrics.Accuracy()</code> works, as well as the data type of the targets.}</p>
<div id="d1337a5c" class="cell" data-execution_count="75">
<div class="sourceCode cell-code" id="cb111"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb111-1"><a href="#cb111-1" aria-hidden="true" tabindex="-1"></a>imdb_optimizer <span class="op">=</span> RMSprop(imdb_model.parameters(), lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb111-2"><a href="#cb111-2" aria-hidden="true" tabindex="-1"></a>imdb_module <span class="op">=</span> SimpleModule.binary_classification(</span>
<span id="cb111-3"><a href="#cb111-3" aria-hidden="true" tabindex="-1"></a>                         imdb_model,</span>
<span id="cb111-4"><a href="#cb111-4" aria-hidden="true" tabindex="-1"></a>                         optimizer<span class="op">=</span>imdb_optimizer)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Having loaded the datasets into a data module and created a <code>SimpleModule</code>, the remaining steps are familiar.</p>
<div id="4066cf2f" class="cell" data-execution_count="76">
<div class="sourceCode cell-code" id="cb112"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb112-1"><a href="#cb112-1" aria-hidden="true" tabindex="-1"></a>imdb_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'IMDB'</span>)</span>
<span id="cb112-2"><a href="#cb112-2" aria-hidden="true" tabindex="-1"></a>imdb_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb112-3"><a href="#cb112-3" aria-hidden="true" tabindex="-1"></a>                       max_epochs<span class="op">=</span><span class="dv">30</span>,</span>
<span id="cb112-4"><a href="#cb112-4" aria-hidden="true" tabindex="-1"></a>                       logger<span class="op">=</span>imdb_logger,</span>
<span id="cb112-5"><a href="#cb112-5" aria-hidden="true" tabindex="-1"></a>                       enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb112-6"><a href="#cb112-6" aria-hidden="true" tabindex="-1"></a>                       callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb112-7"><a href="#cb112-7" aria-hidden="true" tabindex="-1"></a>imdb_trainer.fit(imdb_module,</span>
<span id="cb112-8"><a href="#cb112-8" aria-hidden="true" tabindex="-1"></a>                 datamodule<span class="op">=</span>imdb_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
Missing logger folder: logs/IMDB
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type              | Params
--------------------------------------------
0 | model | IMDBModel         | 160 K 
1 | loss  | BCEWithLogitsLoss | 0     
--------------------------------------------
160 K     Trainable params
0         Non-trainable params
160 K     Total params
0.641     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[76], line 7</span>
<span class="ansi-green-fg ansi-bold">      1</span> imdb_logger <span style="color:rgb(98,98,98)">=</span> CSVLogger(<span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">logs</span><span style="color:rgb(175,0,0)">'</span>, name<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">IMDB</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">      2</span> imdb_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                        max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">30</span>,
<span class="ansi-green-fg ansi-bold">      4</span>                        logger<span style="color:rgb(98,98,98)">=</span>imdb_logger,
<span class="ansi-green-fg ansi-bold">      5</span>                        enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      6</span>                        callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 7</span> <span class="ansi-yellow-bg">imdb_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">imdb_module</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      8</span> <span class="ansi-yellow-bg">                 </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">imdb_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1031</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1029</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training:
<span class="ansi-green-fg ansi-bold">   1030</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> isolate_rng():
<span class="ansi-green-fg">-&gt; 1031</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_sanity_check</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg ansi-bold">   1033</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fit_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1060</span>, in <span class="ansi-cyan-fg">Trainer._run_sanity_check</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1057</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_start</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1059</span> <span style="font-style:italic;color:rgb(95,135,135)"># run eval step</span>
<span class="ansi-green-fg">-&gt; 1060</span> <span class="ansi-yellow-bg">val_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1062</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_end</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1064</span> <span style="font-style:italic;color:rgb(95,135,135)"># reset logger connector</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:261</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_validation_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    254</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_validation_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    255</span>                               trainer,
<span class="ansi-green-fg ansi-bold">    256</span>                               pl_module,
<span class="ansi-green-fg ansi-bold">    257</span>                               batch,
<span class="ansi-green-fg ansi-bold">    258</span>                               batch_idx,
<span class="ansi-green-fg ansi-bold">    259</span>                               dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    260</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 261</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    262</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[73], line 17</span>, in <span class="ansi-cyan-fg">IMDBModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     11</span> val <span style="color:rgb(98,98,98)">=</span> x
<span class="ansi-green-fg ansi-bold">     12</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> _map <span style="font-weight:bold;color:rgb(175,0,255)">in</span> [<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense1,
<span class="ansi-green-fg ansi-bold">     13</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     14</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense2,
<span class="ansi-green-fg ansi-bold">     15</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     16</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>output]:
<span class="ansi-green-fg">---&gt; 17</span>     val <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">_map</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     18</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(val)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>Evaluating the test error yields roughly 86% accuracy.</p>
<div id="723bd32d" class="cell" data-execution_count="77">
<div class="sourceCode cell-code" id="cb114"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb114-1"><a href="#cb114-1" aria-hidden="true" tabindex="-1"></a>test_results <span class="op">=</span> imdb_trainer.test(imdb_module, datamodule<span class="op">=</span>imdb_dm)</span>
<span id="cb114-2"><a href="#cb114-2" aria-hidden="true" tabindex="-1"></a>test_results</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[77], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> test_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">imdb_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">test</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">imdb_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">imdb_dm</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> test_results

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:754</span>, in <span class="ansi-cyan-fg">Trainer.test</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    752</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    753</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>testing <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 754</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    755</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_test_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">verbose</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span>
<span class="ansi-green-fg ansi-bold">    756</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:794</span>, in <span class="ansi-cyan-fg">Trainer._test_impl</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    790</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    791</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    792</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn, ckpt_path, model_provided<span style="color:rgb(98,98,98)">=</span>model_provided, model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    793</span> )
<span class="ansi-green-fg">--&gt; 794</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    795</span> <span style="font-style:italic;color:rgb(95,135,135)"># remove the tensors from the test results</span>
<span class="ansi-green-fg ansi-bold">    796</span> results <span style="color:rgb(98,98,98)">=</span> convert_tensors_to_scalars(results)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1026</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1023</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>zero_grad(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>zero_grad_kwargs)
<span class="ansi-green-fg ansi-bold">   1025</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>evaluating:
<span class="ansi-green-fg">-&gt; 1026</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1027</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predicting:
<span class="ansi-green-fg ansi-bold">   1028</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predict_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:297</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_test_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    290</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_test_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    291</span>                         trainer,
<span class="ansi-green-fg ansi-bold">    292</span>                         pl_module,
<span class="ansi-green-fg ansi-bold">    293</span>                         batch,
<span class="ansi-green-fg ansi-bold">    294</span>                         batch_idx,
<span class="ansi-green-fg ansi-bold">    295</span>                         dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    296</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 297</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    298</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[73], line 17</span>, in <span class="ansi-cyan-fg">IMDBModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">     11</span> val <span style="color:rgb(98,98,98)">=</span> x
<span class="ansi-green-fg ansi-bold">     12</span> <span style="font-weight:bold;color:rgb(0,135,0)">for</span> _map <span style="font-weight:bold;color:rgb(175,0,255)">in</span> [<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense1,
<span class="ansi-green-fg ansi-bold">     13</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     14</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>dense2,
<span class="ansi-green-fg ansi-bold">     15</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>activation,
<span class="ansi-green-fg ansi-bold">     16</span>              <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>output]:
<span class="ansi-green-fg">---&gt; 17</span>     val <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">_map</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     18</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(val)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<section id="comparison-to-lasso" class="level3">
<h3 class="anchored" data-anchor-id="comparison-to-lasso">Comparison to Lasso</h3>
<p>We now fit a lasso logistic regression model using <code>LogisticRegression()</code> from <code>sklearn</code>. Since <code>sklearn</code> does not recognize the sparse tensors of <code>torch</code>, we use a sparse matrix that is recognized by <code>sklearn.</code></p>
<div id="29369f3d" class="cell" data-execution_count="78">
<div class="sourceCode cell-code" id="cb116"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb116-1"><a href="#cb116-1" aria-hidden="true" tabindex="-1"></a>((X_train, Y_train),</span>
<span id="cb116-2"><a href="#cb116-2" aria-hidden="true" tabindex="-1"></a> (X_valid, Y_valid),</span>
<span id="cb116-3"><a href="#cb116-3" aria-hidden="true" tabindex="-1"></a> (X_test, Y_test)) <span class="op">=</span> load_sparse(validation<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb116-4"><a href="#cb116-4" aria-hidden="true" tabindex="-1"></a>                                 random_state<span class="op">=</span><span class="dv">0</span>,</span>
<span id="cb116-5"><a href="#cb116-5" aria-hidden="true" tabindex="-1"></a>                                 root<span class="op">=</span><span class="st">'data/IMDB'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Retrieving "IMDB_X_test.npz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".
Retrieving "IMDB_X_train.npz" from "http://imdb.jtaylor.su.domains/jtaylor/data/".</code></pre>
</div>
</div>
<p>Similar to what we did in Section~, we construct a series of 50 values for the lasso reguralization parameter <span class="math inline">\lambda</span>.</p>
<div id="4fd791c4" class="cell" data-execution_count="79">
<div class="sourceCode cell-code" id="cb118"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb118-1"><a href="#cb118-1" aria-hidden="true" tabindex="-1"></a>lam_max <span class="op">=</span> np.<span class="bu">abs</span>(X_train.T <span class="op">*</span> (Y_train <span class="op">-</span> Y_train.mean())).<span class="bu">max</span>()</span>
<span id="cb118-2"><a href="#cb118-2" aria-hidden="true" tabindex="-1"></a>lam_val <span class="op">=</span> lam_max <span class="op">*</span> np.exp(np.linspace(np.log(<span class="dv">1</span>),</span>
<span id="cb118-3"><a href="#cb118-3" aria-hidden="true" tabindex="-1"></a>                                       np.log(<span class="fl">1e-4</span>), <span class="dv">50</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>With <code>LogisticRegression()</code> the regularization parameter <span class="math inline">C</span> is specified as the inverse of <span class="math inline">\lambda</span>. There are several solvers for logistic regression; here we use <code>liblinear</code> which works well with the sparse input format.</p>
<div id="14cd8ffa" class="cell" data-execution_count="80">
<div class="sourceCode cell-code" id="cb119"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb119-1"><a href="#cb119-1" aria-hidden="true" tabindex="-1"></a>logit <span class="op">=</span> LogisticRegression(penalty<span class="op">=</span><span class="st">'l1'</span>, </span>
<span id="cb119-2"><a href="#cb119-2" aria-hidden="true" tabindex="-1"></a>                           C<span class="op">=</span><span class="dv">1</span><span class="op">/</span>lam_max,</span>
<span id="cb119-3"><a href="#cb119-3" aria-hidden="true" tabindex="-1"></a>                           solver<span class="op">=</span><span class="st">'liblinear'</span>,</span>
<span id="cb119-4"><a href="#cb119-4" aria-hidden="true" tabindex="-1"></a>                           warm_start<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb119-5"><a href="#cb119-5" aria-hidden="true" tabindex="-1"></a>                           fit_intercept<span class="op">=</span><span class="va">True</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The path of 50 values takes approximately 40 seconds to run.</p>
<div id="f5474189" class="cell" data-execution_count="81">
<div class="sourceCode cell-code" id="cb120"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb120-1"><a href="#cb120-1" aria-hidden="true" tabindex="-1"></a>coefs <span class="op">=</span> []</span>
<span id="cb120-2"><a href="#cb120-2" aria-hidden="true" tabindex="-1"></a>intercepts <span class="op">=</span> []</span>
<span id="cb120-3"><a href="#cb120-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb120-4"><a href="#cb120-4" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> l <span class="kw">in</span> lam_val:</span>
<span id="cb120-5"><a href="#cb120-5" aria-hidden="true" tabindex="-1"></a>    logit.C <span class="op">=</span> <span class="dv">1</span><span class="op">/</span>l</span>
<span id="cb120-6"><a href="#cb120-6" aria-hidden="true" tabindex="-1"></a>    logit.fit(X_train, Y_train)</span>
<span id="cb120-7"><a href="#cb120-7" aria-hidden="true" tabindex="-1"></a>    coefs.append(logit.coef_.copy())</span>
<span id="cb120-8"><a href="#cb120-8" aria-hidden="true" tabindex="-1"></a>    intercepts.append(logit.intercept_)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The coefficient and intercepts have an extraneous dimension which can be removed by the <code>np.squeeze()</code> function.</p>
<div id="fc3d3d9f" class="cell" data-execution_count="82">
<div class="sourceCode cell-code" id="cb121"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb121-1"><a href="#cb121-1" aria-hidden="true" tabindex="-1"></a>coefs <span class="op">=</span> np.squeeze(coefs)</span>
<span id="cb121-2"><a href="#cb121-2" aria-hidden="true" tabindex="-1"></a>intercepts <span class="op">=</span> np.squeeze(intercepts)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We’ll now make a plot to compare our neural network results with the lasso.</p>
<div id="167ccf50" class="cell" data-execution_count="83">
<div class="sourceCode cell-code" id="cb122"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb122-1"><a href="#cb122-1" aria-hidden="true" tabindex="-1"></a><span class="op">%%</span>capture</span>
<span id="cb122-2"><a href="#cb122-2" aria-hidden="true" tabindex="-1"></a>fig, axes <span class="op">=</span> subplots(<span class="dv">1</span>, <span class="dv">2</span>, figsize<span class="op">=</span>(<span class="dv">16</span>, <span class="dv">8</span>), sharey<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb122-3"><a href="#cb122-3" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> ((X_, Y_),</span>
<span id="cb122-4"><a href="#cb122-4" aria-hidden="true" tabindex="-1"></a>     data_,</span>
<span id="cb122-5"><a href="#cb122-5" aria-hidden="true" tabindex="-1"></a>     color) <span class="kw">in</span> <span class="bu">zip</span>([(X_train, Y_train),</span>
<span id="cb122-6"><a href="#cb122-6" aria-hidden="true" tabindex="-1"></a>                    (X_valid, Y_valid),</span>
<span id="cb122-7"><a href="#cb122-7" aria-hidden="true" tabindex="-1"></a>                    (X_test, Y_test)],</span>
<span id="cb122-8"><a href="#cb122-8" aria-hidden="true" tabindex="-1"></a>                    [<span class="st">'Training'</span>, <span class="st">'Validation'</span>, <span class="st">'Test'</span>],</span>
<span id="cb122-9"><a href="#cb122-9" aria-hidden="true" tabindex="-1"></a>                    [<span class="st">'black'</span>, <span class="st">'red'</span>, <span class="st">'blue'</span>]):</span>
<span id="cb122-10"><a href="#cb122-10" aria-hidden="true" tabindex="-1"></a>    linpred_ <span class="op">=</span> X_ <span class="op">*</span> coefs.T <span class="op">+</span> intercepts[<span class="va">None</span>,:]</span>
<span id="cb122-11"><a href="#cb122-11" aria-hidden="true" tabindex="-1"></a>    label_ <span class="op">=</span> np.array(linpred_ <span class="op">&gt;</span> <span class="dv">0</span>)</span>
<span id="cb122-12"><a href="#cb122-12" aria-hidden="true" tabindex="-1"></a>    accuracy_ <span class="op">=</span> np.array([np.mean(Y_ <span class="op">==</span> l) <span class="cf">for</span> l <span class="kw">in</span> label_.T])</span>
<span id="cb122-13"><a href="#cb122-13" aria-hidden="true" tabindex="-1"></a>    axes[<span class="dv">0</span>].plot(<span class="op">-</span>np.log(lam_val <span class="op">/</span> X_train.shape[<span class="dv">0</span>]),</span>
<span id="cb122-14"><a href="#cb122-14" aria-hidden="true" tabindex="-1"></a>                 accuracy_,</span>
<span id="cb122-15"><a href="#cb122-15" aria-hidden="true" tabindex="-1"></a>                 <span class="st">'.--'</span>,</span>
<span id="cb122-16"><a href="#cb122-16" aria-hidden="true" tabindex="-1"></a>                 color<span class="op">=</span>color,</span>
<span id="cb122-17"><a href="#cb122-17" aria-hidden="true" tabindex="-1"></a>                 markersize<span class="op">=</span><span class="dv">13</span>,</span>
<span id="cb122-18"><a href="#cb122-18" aria-hidden="true" tabindex="-1"></a>                 linewidth<span class="op">=</span><span class="dv">2</span>,</span>
<span id="cb122-19"><a href="#cb122-19" aria-hidden="true" tabindex="-1"></a>                 label<span class="op">=</span>data_)</span>
<span id="cb122-20"><a href="#cb122-20" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].legend()</span>
<span id="cb122-21"><a href="#cb122-21" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_xlabel(<span class="vs">r'$-\log(\lambda)$'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb122-22"><a href="#cb122-22" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">0</span>].set_ylabel(<span class="st">'Accuracy'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Notice the use of <code>%%capture</code>, which suppresses the displaying of the partially completed figure. This is useful when making a complex figure, since the steps can be spread across two or more cells. We now add a plot of the lasso accuracy, and display the composed figure by simply entering its name at the end of the cell.</p>
<div id="cbc91f06" class="cell" data-execution_count="84">
<div class="sourceCode cell-code" id="cb123"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb123-1"><a href="#cb123-1" aria-hidden="true" tabindex="-1"></a>imdb_results <span class="op">=</span> pd.read_csv(imdb_logger.experiment.metrics_file_path)</span>
<span id="cb123-2"><a href="#cb123-2" aria-hidden="true" tabindex="-1"></a>summary_plot(imdb_results,</span>
<span id="cb123-3"><a href="#cb123-3" aria-hidden="true" tabindex="-1"></a>             axes[<span class="dv">1</span>],</span>
<span id="cb123-4"><a href="#cb123-4" aria-hidden="true" tabindex="-1"></a>             col<span class="op">=</span><span class="st">'accuracy'</span>,</span>
<span id="cb123-5"><a href="#cb123-5" aria-hidden="true" tabindex="-1"></a>             ylabel<span class="op">=</span><span class="st">'Accuracy'</span>)</span>
<span id="cb123-6"><a href="#cb123-6" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">30</span>, <span class="dv">7</span>).astype(<span class="bu">int</span>))</span>
<span id="cb123-7"><a href="#cb123-7" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylabel(<span class="st">'Accuracy'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb123-8"><a href="#cb123-8" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_xlabel(<span class="st">'Epoch'</span>, fontsize<span class="op">=</span><span class="dv">20</span>)</span>
<span id="cb123-9"><a href="#cb123-9" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].set_ylim([<span class="fl">0.5</span>, <span class="dv">1</span>])<span class="op">;</span></span>
<span id="cb123-10"><a href="#cb123-10" aria-hidden="true" tabindex="-1"></a>axes[<span class="dv">1</span>].axhline(test_results[<span class="dv">0</span>][<span class="st">'test_accuracy'</span>],</span>
<span id="cb123-11"><a href="#cb123-11" aria-hidden="true" tabindex="-1"></a>                color<span class="op">=</span><span class="st">'blue'</span>,</span>
<span id="cb123-12"><a href="#cb123-12" aria-hidden="true" tabindex="-1"></a>                linestyle<span class="op">=</span><span class="st">'--'</span>,</span>
<span id="cb123-13"><a href="#cb123-13" aria-hidden="true" tabindex="-1"></a>                linewidth<span class="op">=</span><span class="dv">3</span>)</span>
<span id="cb123-14"><a href="#cb123-14" aria-hidden="true" tabindex="-1"></a>fig</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[84], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> imdb_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">imdb_logger</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">experiment</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">metrics_file_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> summary_plot(imdb_results,
<span class="ansi-green-fg ansi-bold">      3</span>              axes[<span style="color:rgb(98,98,98)">1</span>],
<span class="ansi-green-fg ansi-bold">      4</span>              col<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">accuracy</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      5</span>              ylabel<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Accuracy</span><span style="color:rgb(175,0,0)">'</span>)
<span class="ansi-green-fg ansi-bold">      6</span> axes[<span style="color:rgb(98,98,98)">1</span>]<span style="color:rgb(98,98,98)">.</span>set_xticks(np<span style="color:rgb(98,98,98)">.</span>linspace(<span style="color:rgb(98,98,98)">0</span>, <span style="color:rgb(98,98,98)">30</span>, <span style="color:rgb(98,98,98)">7</span>)<span style="color:rgb(98,98,98)">.</span>astype(<span style="color:rgb(0,135,0)">int</span>))

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg ansi-bold">   1013</span> kwds_defaults <span style="color:rgb(98,98,98)">=</span> _refine_defaults_read(
<span class="ansi-green-fg ansi-bold">   1014</span>     dialect,
<span class="ansi-green-fg ansi-bold">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1022</span>     dtype_backend<span style="color:rgb(98,98,98)">=</span>dtype_backend,
<span class="ansi-green-fg ansi-bold">   1023</span> )
<span class="ansi-green-fg ansi-bold">   1024</span> kwds<span style="color:rgb(98,98,98)">.</span>update(kwds_defaults)
<span class="ansi-green-fg">-&gt; 1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg ansi-bold">    617</span> _validate_names(kwds<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">names</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg ansi-bold">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; 620</span> parser <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg ansi-bold">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg ansi-bold">   1617</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>options[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> kwds[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">   1619</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles: IOHandles <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; 1620</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg ansi-bold">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg ansi-bold">   1879</span>         mode <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">-&gt; 1880</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">compression</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">memory_map</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding_errors</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">strict</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">storage_options</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1891</span> f <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles<span style="color:rgb(98,98,98)">.</span>handle

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg ansi-bold">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg ansi-bold">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg ansi-bold">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg ansi-bold">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs<span style="color:rgb(98,98,98)">.</span>encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs<span style="color:rgb(98,98,98)">.</span>mode:
<span class="ansi-green-fg ansi-bold">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; 873</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg ansi-bold">    882</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">open</span>(handle, ioargs<span style="color:rgb(98,98,98)">.</span>mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'logs/IMDB/version_0/metrics.csv'</pre>
</div>
</div>
</div>
<p>From the graphs we see that the accuracy of the lasso logistic regression peaks at about <span class="math inline">0.88</span>, as it does for the neural network.</p>
<p>Once again, we end with a cleanup.</p>
<div id="7f247789" class="cell" data-execution_count="85">
<div class="sourceCode cell-code" id="cb124"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb124-1"><a href="#cb124-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(imdb_model,</span>
<span id="cb124-2"><a href="#cb124-2" aria-hidden="true" tabindex="-1"></a>    imdb_trainer,</span>
<span id="cb124-3"><a href="#cb124-3" aria-hidden="true" tabindex="-1"></a>    imdb_logger,</span>
<span id="cb124-4"><a href="#cb124-4" aria-hidden="true" tabindex="-1"></a>    imdb_dm,</span>
<span id="cb124-5"><a href="#cb124-5" aria-hidden="true" tabindex="-1"></a>    imdb_train,</span>
<span id="cb124-6"><a href="#cb124-6" aria-hidden="true" tabindex="-1"></a>    imdb_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
</section>
<section id="recurrent-neural-networks" class="level2">
<h2 class="anchored" data-anchor-id="recurrent-neural-networks">Recurrent Neural Networks</h2>
<p>In this lab we fit the models illustrated in Section~.</p>
<section id="sequential-models-for-document-classification" class="level3">
<h3 class="anchored" data-anchor-id="sequential-models-for-document-classification">Sequential Models for Document Classification</h3>
<p>Here we fit a simple LSTM RNN for sentiment prediction to the <code>IMDb</code> movie-review data, as discussed in Section~. For an RNN we use the sequence of words in a document, taking their order into account. We loaded the preprocessed data at the beginning of Section~. A script that details the preprocessing can be found in the <code>ISLP</code> library. Notably, since more than 90% of the documents had fewer than 500 words, we set the document length to 500. For longer documents, we used the last 500 words, and for shorter documents, we padded the front with blanks.</p>
<div id="d9c2f2d4" class="cell" data-execution_count="86">
<div class="sourceCode cell-code" id="cb125"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb125-1"><a href="#cb125-1" aria-hidden="true" tabindex="-1"></a>imdb_seq_dm <span class="op">=</span> SimpleDataModule(imdb_seq_train,</span>
<span id="cb125-2"><a href="#cb125-2" aria-hidden="true" tabindex="-1"></a>                               imdb_seq_test,</span>
<span id="cb125-3"><a href="#cb125-3" aria-hidden="true" tabindex="-1"></a>                               validation<span class="op">=</span><span class="dv">2000</span>,</span>
<span id="cb125-4"><a href="#cb125-4" aria-hidden="true" tabindex="-1"></a>                               batch_size<span class="op">=</span><span class="dv">300</span>,</span>
<span id="cb125-5"><a href="#cb125-5" aria-hidden="true" tabindex="-1"></a>                               num_workers<span class="op">=</span><span class="bu">min</span>(<span class="dv">6</span>, max_num_workers)</span>
<span id="cb125-6"><a href="#cb125-6" aria-hidden="true" tabindex="-1"></a>                               )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The first layer of the RNN is an embedding layer of size 32, which will be learned during training. This layer one-hot encodes each document as a matrix of dimension <span class="math inline">500 \times 10,003</span>, and then maps these <span class="math inline">10,003</span> dimensions down to <span class="math inline">32</span>. {The extra 3 dimensions correspond to commonly occurring non-word entries in the reviews.} Since each word is represented by an integer, this is effectively achieved by the creation of an embedding matrix of size <span class="math inline">10,003\times 32</span>; each of the 500 integers in the document are then mapped to the appropriate 32 real numbers by indexing the appropriate rows of this matrix.</p>
<p>The second layer is an LSTM with 32 units, and the output layer is a single logit for the binary classification task. In the last line of the <code>forward()</code> method below, we take the last 32-dimensional output of the LSTM and map it to our response.</p>
<div id="9649200f" class="cell" data-execution_count="87">
<div class="sourceCode cell-code" id="cb126"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb126-1"><a href="#cb126-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> LSTMModel(nn.Module):</span>
<span id="cb126-2"><a href="#cb126-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>, input_size):</span>
<span id="cb126-3"><a href="#cb126-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(LSTMModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb126-4"><a href="#cb126-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.embedding <span class="op">=</span> nn.Embedding(input_size, <span class="dv">32</span>)</span>
<span id="cb126-5"><a href="#cb126-5" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.lstm <span class="op">=</span> nn.LSTM(input_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb126-6"><a href="#cb126-6" aria-hidden="true" tabindex="-1"></a>                            hidden_size<span class="op">=</span><span class="dv">32</span>,</span>
<span id="cb126-7"><a href="#cb126-7" aria-hidden="true" tabindex="-1"></a>                            batch_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb126-8"><a href="#cb126-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense <span class="op">=</span> nn.Linear(<span class="dv">32</span>, <span class="dv">1</span>)</span>
<span id="cb126-9"><a href="#cb126-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb126-10"><a href="#cb126-10" aria-hidden="true" tabindex="-1"></a>        val, (h_n, c_n) <span class="op">=</span> <span class="va">self</span>.lstm(<span class="va">self</span>.embedding(x))</span>
<span id="cb126-11"><a href="#cb126-11" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.flatten(<span class="va">self</span>.dense(val[:,<span class="op">-</span><span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We instantiate and take a look at the summary of the model, using the first 10 documents in the corpus.</p>
<div id="02f90b16" class="cell" data-execution_count="88">
<div class="sourceCode cell-code" id="cb127"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb127-1"><a href="#cb127-1" aria-hidden="true" tabindex="-1"></a>lstm_model <span class="op">=</span> LSTMModel(X_test.shape[<span class="op">-</span><span class="dv">1</span>])</span>
<span id="cb127-2"><a href="#cb127-2" aria-hidden="true" tabindex="-1"></a>summary(lstm_model,</span>
<span id="cb127-3"><a href="#cb127-3" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>imdb_seq_train.tensors[<span class="dv">0</span>][:<span class="dv">10</span>],</span>
<span id="cb127-4"><a href="#cb127-4" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb127-5"><a href="#cb127-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb127-6"><a href="#cb127-6" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="88">
<pre><code>===================================================================================================================
Layer (type:depth-idx)                   Input Shape               Output Shape              Param #
===================================================================================================================
LSTMModel                                [10, 500]                 [10]                      --
├─Embedding: 1-1                         [10, 500]                 [10, 500, 32]             320,096
├─LSTM: 1-2                              [10, 500, 32]             [10, 500, 32]             8,448
├─Linear: 1-3                            [10, 32]                  [10, 1]                   33
===================================================================================================================
Total params: 328,577
Trainable params: 328,577
Non-trainable params: 0
Total mult-adds (M): 45.44
===================================================================================================================
Input size (MB): 50.00
Forward/backward pass size (MB): 2.56
Params size (MB): 1.31
Estimated Total Size (MB): 53.87
===================================================================================================================</code></pre>
</div>
</div>
<p>The 10,003 is suppressed in the summary, but we see it in the parameter count, since <span class="math inline">10,003\times 32=320,096</span>.</p>
<div id="0a540f0a" class="cell" data-execution_count="89">
<div class="sourceCode cell-code" id="cb129"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb129-1"><a href="#cb129-1" aria-hidden="true" tabindex="-1"></a>lstm_module <span class="op">=</span> SimpleModule.binary_classification(lstm_model)</span>
<span id="cb129-2"><a href="#cb129-2" aria-hidden="true" tabindex="-1"></a>lstm_logger <span class="op">=</span> CSVLogger(<span class="st">'logs'</span>, name<span class="op">=</span><span class="st">'IMDB_LSTM'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="45e50317" class="cell" data-execution_count="90">
<div class="sourceCode cell-code" id="cb130"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb130-1"><a href="#cb130-1" aria-hidden="true" tabindex="-1"></a>lstm_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb130-2"><a href="#cb130-2" aria-hidden="true" tabindex="-1"></a>                       max_epochs<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb130-3"><a href="#cb130-3" aria-hidden="true" tabindex="-1"></a>                       logger<span class="op">=</span>lstm_logger,</span>
<span id="cb130-4"><a href="#cb130-4" aria-hidden="true" tabindex="-1"></a>                       enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb130-5"><a href="#cb130-5" aria-hidden="true" tabindex="-1"></a>                       callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb130-6"><a href="#cb130-6" aria-hidden="true" tabindex="-1"></a>lstm_trainer.fit(lstm_module,</span>
<span id="cb130-7"><a href="#cb130-7" aria-hidden="true" tabindex="-1"></a>                 datamodule<span class="op">=</span>imdb_seq_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
Missing logger folder: logs/IMDB_LSTM
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type              | Params
--------------------------------------------
0 | model | LSTMModel         | 328 K 
1 | loss  | BCEWithLogitsLoss | 0     
--------------------------------------------
328 K     Trainable params
0         Non-trainable params
328 K     Total params
1.314     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[90], line 6</span>
<span class="ansi-green-fg ansi-bold">      1</span> lstm_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                        max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">20</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                        logger<span style="color:rgb(98,98,98)">=</span>lstm_logger,
<span class="ansi-green-fg ansi-bold">      4</span>                        enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      5</span>                        callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 6</span> <span class="ansi-yellow-bg">lstm_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">lstm_module</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      7</span> <span class="ansi-yellow-bg">                 </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">imdb_seq_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1031</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1029</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training:
<span class="ansi-green-fg ansi-bold">   1030</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> isolate_rng():
<span class="ansi-green-fg">-&gt; 1031</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_sanity_check</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg ansi-bold">   1033</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fit_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1060</span>, in <span class="ansi-cyan-fg">Trainer._run_sanity_check</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1057</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_start</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1059</span> <span style="font-style:italic;color:rgb(95,135,135)"># run eval step</span>
<span class="ansi-green-fg">-&gt; 1060</span> <span class="ansi-yellow-bg">val_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1062</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_end</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1064</span> <span style="font-style:italic;color:rgb(95,135,135)"># reset logger connector</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:261</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_validation_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    254</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_validation_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    255</span>                               trainer,
<span class="ansi-green-fg ansi-bold">    256</span>                               pl_module,
<span class="ansi-green-fg ansi-bold">    257</span>                               batch,
<span class="ansi-green-fg ansi-bold">    258</span>                               batch_idx,
<span class="ansi-green-fg ansi-bold">    259</span>                               dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    260</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 261</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    262</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[87], line 11</span>, in <span class="ansi-cyan-fg">LSTMModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">      9</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg ansi-bold">     10</span>     val, (h_n, c_n) <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lstm(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>embedding(x))
<span class="ansi-green-fg">---&gt; 11</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dense</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">-</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">1</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>The rest is now similar to other networks we have fit. We track the test performance as the network is fit, and see that it attains 85% accuracy.</p>
<div id="183bdffb" class="cell" data-execution_count="91">
<div class="sourceCode cell-code" id="cb132"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb132-1"><a href="#cb132-1" aria-hidden="true" tabindex="-1"></a>lstm_trainer.test(lstm_module, datamodule<span class="op">=</span>imdb_seq_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[91], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> <span class="ansi-yellow-bg">lstm_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">test</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">lstm_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">imdb_seq_dm</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:754</span>, in <span class="ansi-cyan-fg">Trainer.test</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    752</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    753</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>testing <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 754</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    755</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_test_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">verbose</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span>
<span class="ansi-green-fg ansi-bold">    756</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:794</span>, in <span class="ansi-cyan-fg">Trainer._test_impl</span><span class="ansi-blue-fg">(self, model, dataloaders, ckpt_path, verbose, datamodule)</span>
<span class="ansi-green-fg ansi-bold">    790</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    791</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    792</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn, ckpt_path, model_provided<span style="color:rgb(98,98,98)">=</span>model_provided, model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    793</span> )
<span class="ansi-green-fg">--&gt; 794</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    795</span> <span style="font-style:italic;color:rgb(95,135,135)"># remove the tensors from the test results</span>
<span class="ansi-green-fg ansi-bold">    796</span> results <span style="color:rgb(98,98,98)">=</span> convert_tensors_to_scalars(results)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1026</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1023</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module<span style="color:rgb(98,98,98)">.</span>zero_grad(<span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>zero_grad_kwargs)
<span class="ansi-green-fg ansi-bold">   1025</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>evaluating:
<span class="ansi-green-fg">-&gt; 1026</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1027</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predicting:
<span class="ansi-green-fg ansi-bold">   1028</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>predict_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:297</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_test_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    290</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_test_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    291</span>                         trainer,
<span class="ansi-green-fg ansi-bold">    292</span>                         pl_module,
<span class="ansi-green-fg ansi-bold">    293</span>                         batch,
<span class="ansi-green-fg ansi-bold">    294</span>                         batch_idx,
<span class="ansi-green-fg ansi-bold">    295</span>                         dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    296</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 297</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    298</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>test_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[87], line 11</span>, in <span class="ansi-cyan-fg">LSTMModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">      9</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg ansi-bold">     10</span>     val, (h_n, c_n) <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lstm(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>embedding(x))
<span class="ansi-green-fg">---&gt; 11</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dense</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">-</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">1</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>We once again show the learning progress, followed by cleanup.</p>
<div id="228d1fb5" class="cell" data-execution_count="92">
<div class="sourceCode cell-code" id="cb134"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb134-1"><a href="#cb134-1" aria-hidden="true" tabindex="-1"></a>lstm_results <span class="op">=</span> pd.read_csv(lstm_logger.experiment.metrics_file_path)</span>
<span id="cb134-2"><a href="#cb134-2" aria-hidden="true" tabindex="-1"></a>fig, ax <span class="op">=</span> subplots(<span class="dv">1</span>, <span class="dv">1</span>, figsize<span class="op">=</span>(<span class="dv">6</span>, <span class="dv">6</span>))</span>
<span id="cb134-3"><a href="#cb134-3" aria-hidden="true" tabindex="-1"></a>summary_plot(lstm_results,</span>
<span id="cb134-4"><a href="#cb134-4" aria-hidden="true" tabindex="-1"></a>             ax,</span>
<span id="cb134-5"><a href="#cb134-5" aria-hidden="true" tabindex="-1"></a>             col<span class="op">=</span><span class="st">'accuracy'</span>,</span>
<span id="cb134-6"><a href="#cb134-6" aria-hidden="true" tabindex="-1"></a>             ylabel<span class="op">=</span><span class="st">'Accuracy'</span>)</span>
<span id="cb134-7"><a href="#cb134-7" aria-hidden="true" tabindex="-1"></a>ax.set_xticks(np.linspace(<span class="dv">0</span>, <span class="dv">20</span>, <span class="dv">5</span>).astype(<span class="bu">int</span>))</span>
<span id="cb134-8"><a href="#cb134-8" aria-hidden="true" tabindex="-1"></a>ax.set_ylabel(<span class="st">'Accuracy'</span>)</span>
<span id="cb134-9"><a href="#cb134-9" aria-hidden="true" tabindex="-1"></a>ax.set_ylim([<span class="fl">0.5</span>, <span class="dv">1</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">FileNotFoundError</span>                         Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[92], line 1</span>
<span class="ansi-green-fg">----&gt; 1</span> lstm_results <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">pd</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">read_csv</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">lstm_logger</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">experiment</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">metrics_file_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      2</span> fig, ax <span style="color:rgb(98,98,98)">=</span> subplots(<span style="color:rgb(98,98,98)">1</span>, <span style="color:rgb(98,98,98)">1</span>, figsize<span style="color:rgb(98,98,98)">=</span>(<span style="color:rgb(98,98,98)">6</span>, <span style="color:rgb(98,98,98)">6</span>))
<span class="ansi-green-fg ansi-bold">      3</span> summary_plot(lstm_results,
<span class="ansi-green-fg ansi-bold">      4</span>              ax,
<span class="ansi-green-fg ansi-bold">      5</span>              col<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">accuracy</span><span style="color:rgb(175,0,0)">'</span>,
<span class="ansi-green-fg ansi-bold">      6</span>              ylabel<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(175,0,0)">'</span><span style="color:rgb(175,0,0)">Accuracy</span><span style="color:rgb(175,0,0)">'</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1026</span>, in <span class="ansi-cyan-fg">read_csv</span><span class="ansi-blue-fg">(filepath_or_buffer, sep, delimiter, header, names, index_col, usecols, dtype, engine, converters, true_values, false_values, skipinitialspace, skiprows, skipfooter, nrows, na_values, keep_default_na, na_filter, verbose, skip_blank_lines, parse_dates, infer_datetime_format, keep_date_col, date_parser, date_format, dayfirst, cache_dates, iterator, chunksize, compression, thousands, decimal, lineterminator, quotechar, quoting, doublequote, escapechar, comment, encoding, encoding_errors, dialect, on_bad_lines, delim_whitespace, low_memory, memory_map, float_precision, storage_options, dtype_backend)</span>
<span class="ansi-green-fg ansi-bold">   1013</span> kwds_defaults <span style="color:rgb(98,98,98)">=</span> _refine_defaults_read(
<span class="ansi-green-fg ansi-bold">   1014</span>     dialect,
<span class="ansi-green-fg ansi-bold">   1015</span>     delimiter,
<span class="ansi-green-fg">   (...)</span>
<span class="ansi-green-fg ansi-bold">   1022</span>     dtype_backend<span style="color:rgb(98,98,98)">=</span>dtype_backend,
<span class="ansi-green-fg ansi-bold">   1023</span> )
<span class="ansi-green-fg ansi-bold">   1024</span> kwds<span style="color:rgb(98,98,98)">.</span>update(kwds_defaults)
<span class="ansi-green-fg">-&gt; 1026</span> <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">_read</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:620</span>, in <span class="ansi-cyan-fg">_read</span><span class="ansi-blue-fg">(filepath_or_buffer, kwds)</span>
<span class="ansi-green-fg ansi-bold">    617</span> _validate_names(kwds<span style="color:rgb(98,98,98)">.</span>get(<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">names</span><span style="color:rgb(175,0,0)">"</span>, <span style="font-weight:bold;color:rgb(0,135,0)">None</span>))
<span class="ansi-green-fg ansi-bold">    619</span> <span style="font-style:italic;color:rgb(95,135,135)"># Create the parser.</span>
<span class="ansi-green-fg">--&gt; 620</span> parser <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">TextFileReader</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">filepath_or_buffer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwds</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    622</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> chunksize <span style="font-weight:bold;color:rgb(175,0,255)">or</span> iterator:
<span class="ansi-green-fg ansi-bold">    623</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> parser

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1620</span>, in <span class="ansi-cyan-fg">TextFileReader.__init__</span><span class="ansi-blue-fg">(self, f, engine, **kwds)</span>
<span class="ansi-green-fg ansi-bold">   1617</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>options[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>] <span style="color:rgb(98,98,98)">=</span> kwds[<span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">has_index_names</span><span style="color:rgb(175,0,0)">"</span>]
<span class="ansi-green-fg ansi-bold">   1619</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles: IOHandles <span style="color:rgb(98,98,98)">|</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span> <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg">-&gt; 1620</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_engine <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_make_engine</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">engine</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/parsers/readers.py:1880</span>, in <span class="ansi-cyan-fg">TextFileReader._make_engine</span><span class="ansi-blue-fg">(self, f, engine)</span>
<span class="ansi-green-fg ansi-bold">   1878</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> mode:
<span class="ansi-green-fg ansi-bold">   1879</span>         mode <span style="color:rgb(98,98,98)">+</span><span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">-&gt; 1880</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">get_handle</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">   1881</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">f</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1882</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1883</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1884</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">compression</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">compression</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1885</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">memory_map</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">memory_map</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">False</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1886</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">is_text</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">is_text</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1887</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">encoding_errors</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">strict</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1888</span> <span class="ansi-yellow-bg">    </span><span class="ansi-yellow-bg">storage_options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">options</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">get</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">storage_options</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="font-weight:bold;color:rgb(0,135,0)" class="ansi-yellow-bg">None</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">   1889</span> <span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1890</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">   1891</span> f <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>handles<span style="color:rgb(98,98,98)">.</span>handle

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pandas/io/common.py:873</span>, in <span class="ansi-cyan-fg">get_handle</span><span class="ansi-blue-fg">(path_or_buf, mode, encoding, compression, memory_map, is_text, errors, storage_options)</span>
<span class="ansi-green-fg ansi-bold">    868</span> <span style="font-weight:bold;color:rgb(0,135,0)">elif</span> <span style="color:rgb(0,135,0)">isinstance</span>(handle, <span style="color:rgb(0,135,0)">str</span>):
<span class="ansi-green-fg ansi-bold">    869</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Check whether the filename is to be opened in binary mode.</span>
<span class="ansi-green-fg ansi-bold">    870</span>     <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode does not support 'encoding' and 'newline'.</span>
<span class="ansi-green-fg ansi-bold">    871</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> ioargs<span style="color:rgb(98,98,98)">.</span>encoding <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">b</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(175,0,255)">in</span> ioargs<span style="color:rgb(98,98,98)">.</span>mode:
<span class="ansi-green-fg ansi-bold">    872</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Encoding</span>
<span class="ansi-green-fg">--&gt; 873</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">open</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    874</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">handle</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    875</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">mode</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    876</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">encoding</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ioargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">encoding</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    877</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">errors</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">errors</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    878</span> <span class="ansi-yellow-bg">            </span><span class="ansi-yellow-bg">newline</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span style="color:rgb(175,0,0)" class="ansi-yellow-bg">"</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">    879</span> <span class="ansi-yellow-bg">        </span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    880</span>     <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg ansi-bold">    881</span>         <span style="font-style:italic;color:rgb(95,135,135)"># Binary mode</span>
<span class="ansi-green-fg ansi-bold">    882</span>         handle <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">open</span>(handle, ioargs<span style="color:rgb(98,98,98)">.</span>mode)

<span class="ansi-red-fg">FileNotFoundError</span>: [Errno 2] No such file or directory: 'logs/IMDB_LSTM/version_0/metrics.csv'</pre>
</div>
</div>
</div>
<div id="674ac0b7" class="cell" data-execution_count="93">
<div class="sourceCode cell-code" id="cb135"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb135-1"><a href="#cb135-1" aria-hidden="true" tabindex="-1"></a><span class="kw">del</span>(lstm_model,</span>
<span id="cb135-2"><a href="#cb135-2" aria-hidden="true" tabindex="-1"></a>    lstm_trainer,</span>
<span id="cb135-3"><a href="#cb135-3" aria-hidden="true" tabindex="-1"></a>    lstm_logger,</span>
<span id="cb135-4"><a href="#cb135-4" aria-hidden="true" tabindex="-1"></a>    imdb_seq_dm,</span>
<span id="cb135-5"><a href="#cb135-5" aria-hidden="true" tabindex="-1"></a>    imdb_seq_train,</span>
<span id="cb135-6"><a href="#cb135-6" aria-hidden="true" tabindex="-1"></a>    imdb_seq_test)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="time-series-prediction" class="level3">
<h3 class="anchored" data-anchor-id="time-series-prediction">Time Series Prediction</h3>
<p>We now show how to fit the models in Section~ for time series prediction. We first load and standardize the data.</p>
<div id="ca53fe60" class="cell" data-execution_count="94">
<div class="sourceCode cell-code" id="cb136"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb136-1"><a href="#cb136-1" aria-hidden="true" tabindex="-1"></a>NYSE <span class="op">=</span> load_data(<span class="st">'NYSE'</span>)</span>
<span id="cb136-2"><a href="#cb136-2" aria-hidden="true" tabindex="-1"></a>cols <span class="op">=</span> [<span class="st">'DJ_return'</span>, <span class="st">'log_volume'</span>, <span class="st">'log_volatility'</span>]</span>
<span id="cb136-3"><a href="#cb136-3" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> pd.DataFrame(StandardScaler(</span>
<span id="cb136-4"><a href="#cb136-4" aria-hidden="true" tabindex="-1"></a>                     with_mean<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb136-5"><a href="#cb136-5" aria-hidden="true" tabindex="-1"></a>                     with_std<span class="op">=</span><span class="va">True</span>).fit_transform(NYSE[cols]),</span>
<span id="cb136-6"><a href="#cb136-6" aria-hidden="true" tabindex="-1"></a>                 columns<span class="op">=</span>NYSE[cols].columns,</span>
<span id="cb136-7"><a href="#cb136-7" aria-hidden="true" tabindex="-1"></a>                 index<span class="op">=</span>NYSE.index)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Next we set up the lagged versions of the data, dropping any rows with missing values using the <code>dropna()</code> method.</p>
<div id="c296268f" class="cell" data-execution_count="95">
<div class="sourceCode cell-code" id="cb137"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb137-1"><a href="#cb137-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">1</span>, <span class="dv">6</span>):</span>
<span id="cb137-2"><a href="#cb137-2" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> cols:</span>
<span id="cb137-3"><a href="#cb137-3" aria-hidden="true" tabindex="-1"></a>        newcol <span class="op">=</span> np.zeros(X.shape[<span class="dv">0</span>]) <span class="op">*</span> np.nan</span>
<span id="cb137-4"><a href="#cb137-4" aria-hidden="true" tabindex="-1"></a>        newcol[lag:] <span class="op">=</span> X[col].values[:<span class="op">-</span>lag]</span>
<span id="cb137-5"><a href="#cb137-5" aria-hidden="true" tabindex="-1"></a>        X.insert(<span class="bu">len</span>(X.columns), <span class="st">"</span><span class="sc">{0}</span><span class="st">_</span><span class="sc">{1}</span><span class="st">"</span>.<span class="bu">format</span>(col, lag), newcol)</span>
<span id="cb137-6"><a href="#cb137-6" aria-hidden="true" tabindex="-1"></a>X.insert(<span class="bu">len</span>(X.columns), <span class="st">'train'</span>, NYSE[<span class="st">'train'</span>])</span>
<span id="cb137-7"><a href="#cb137-7" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X.dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Finally, we extract the response, training indicator, and drop the current day’s <code>DJ_return</code> and <code>log_volatility</code> to predict only from previous day’s data.</p>
<div id="0b14e81c" class="cell" data-execution_count="96">
<div class="sourceCode cell-code" id="cb138"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb138-1"><a href="#cb138-1" aria-hidden="true" tabindex="-1"></a>Y, train <span class="op">=</span> X[<span class="st">'log_volume'</span>], X[<span class="st">'train'</span>]</span>
<span id="cb138-2"><a href="#cb138-2" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X.drop(columns<span class="op">=</span>[<span class="st">'train'</span>] <span class="op">+</span> cols)</span>
<span id="cb138-3"><a href="#cb138-3" aria-hidden="true" tabindex="-1"></a>X.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="96">
<pre><code>Index(['DJ_return_1', 'log_volume_1', 'log_volatility_1', 'DJ_return_2',
       'log_volume_2', 'log_volatility_2', 'DJ_return_3', 'log_volume_3',
       'log_volatility_3', 'DJ_return_4', 'log_volume_4', 'log_volatility_4',
       'DJ_return_5', 'log_volume_5', 'log_volatility_5'],
      dtype='object')</code></pre>
</div>
</div>
<p>We first fit a simple linear model and compute the <span class="math inline">R^2</span> on the test data using the <code>score()</code> method.</p>
<div id="0cdde7fb" class="cell" data-execution_count="97">
<div class="sourceCode cell-code" id="cb140"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb140-1"><a href="#cb140-1" aria-hidden="true" tabindex="-1"></a>M <span class="op">=</span> LinearRegression()</span>
<span id="cb140-2"><a href="#cb140-2" aria-hidden="true" tabindex="-1"></a>M.fit(X[train], Y[train])</span>
<span id="cb140-3"><a href="#cb140-3" aria-hidden="true" tabindex="-1"></a>M.score(X[<span class="op">~</span>train], Y[<span class="op">~</span>train])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="97">
<pre><code>0.4128912938562521</code></pre>
</div>
</div>
<p>We refit this model, including the factor variable <code>day_of_week</code>. For a categorical series in <code>pandas</code>, we can form the indicators using the <code>get_dummies()</code> method.</p>
<div id="ee519477" class="cell" data-execution_count="98">
<div class="sourceCode cell-code" id="cb142"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb142-1"><a href="#cb142-1" aria-hidden="true" tabindex="-1"></a>X_day <span class="op">=</span> pd.concat([X, </span>
<span id="cb142-2"><a href="#cb142-2" aria-hidden="true" tabindex="-1"></a>                  pd.get_dummies(NYSE[<span class="st">'day_of_week'</span>])],</span>
<span id="cb142-3"><a href="#cb142-3" aria-hidden="true" tabindex="-1"></a>                  axis<span class="op">=</span><span class="dv">1</span>).dropna()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Note that we do not have to reinstantiate the linear regression model as its <code>fit()</code> method accepts a design matrix and a response directly.</p>
<div id="a86cb220" class="cell" data-execution_count="99">
<div class="sourceCode cell-code" id="cb143"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb143-1"><a href="#cb143-1" aria-hidden="true" tabindex="-1"></a>M.fit(X_day[train], Y[train])</span>
<span id="cb143-2"><a href="#cb143-2" aria-hidden="true" tabindex="-1"></a>M.score(X_day[<span class="op">~</span>train], Y[<span class="op">~</span>train])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="99">
<pre><code>0.4595563133053274</code></pre>
</div>
</div>
<p>This model achieves an <span class="math inline">R^2</span> of about 46%.</p>
<p>To fit the RNN, we must reshape the data, as it will expect 5 lagged versions of each feature as indicated by the <code>input_shape</code> argument to the layer <code>nn.RNN()</code> below. We first ensure the columns of our data frame are such that a reshaped matrix will have the variables correctly lagged. We use the <code>reindex()</code> method to do this.</p>
<p>For an input shape <code>(5,3)</code>, each row represents a lagged version of the three variables. The <code>nn.RNN()</code> layer also expects the first row of each observation to be earliest in time, so we must reverse the current order. Hence we loop over <code>range(5,0,-1)</code> below, which is an example of using a <code>slice()</code> to index iterable objects. The general notation is <code>start:end:step</code>.</p>
<div id="af374111" class="cell" data-execution_count="100">
<div class="sourceCode cell-code" id="cb145"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb145-1"><a href="#cb145-1" aria-hidden="true" tabindex="-1"></a>ordered_cols <span class="op">=</span> []</span>
<span id="cb145-2"><a href="#cb145-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> lag <span class="kw">in</span> <span class="bu">range</span>(<span class="dv">5</span>,<span class="dv">0</span>,<span class="op">-</span><span class="dv">1</span>):</span>
<span id="cb145-3"><a href="#cb145-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> col <span class="kw">in</span> cols:</span>
<span id="cb145-4"><a href="#cb145-4" aria-hidden="true" tabindex="-1"></a>        ordered_cols.append(<span class="st">'</span><span class="sc">{0}</span><span class="st">_</span><span class="sc">{1}</span><span class="st">'</span>.<span class="bu">format</span>(col, lag))</span>
<span id="cb145-5"><a href="#cb145-5" aria-hidden="true" tabindex="-1"></a>X <span class="op">=</span> X.reindex(columns<span class="op">=</span>ordered_cols)</span>
<span id="cb145-6"><a href="#cb145-6" aria-hidden="true" tabindex="-1"></a>X.columns</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="100">
<pre><code>Index(['DJ_return_5', 'log_volume_5', 'log_volatility_5', 'DJ_return_4',
       'log_volume_4', 'log_volatility_4', 'DJ_return_3', 'log_volume_3',
       'log_volatility_3', 'DJ_return_2', 'log_volume_2', 'log_volatility_2',
       'DJ_return_1', 'log_volume_1', 'log_volatility_1'],
      dtype='object')</code></pre>
</div>
</div>
<p>We now reshape the data.</p>
<div id="7b922f31" class="cell" data-execution_count="101">
<div class="sourceCode cell-code" id="cb147"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb147-1"><a href="#cb147-1" aria-hidden="true" tabindex="-1"></a>X_rnn <span class="op">=</span> X.to_numpy().reshape((<span class="op">-</span><span class="dv">1</span>,<span class="dv">5</span>,<span class="dv">3</span>))</span>
<span id="cb147-2"><a href="#cb147-2" aria-hidden="true" tabindex="-1"></a>X_rnn.shape</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="101">
<pre><code>(6046, 5, 3)</code></pre>
</div>
</div>
<p>By specifying the first size as -1, <code>numpy.reshape()</code> deduces its size based on the remaining arguments.</p>
<p>Now we are ready to proceed with the RNN, which uses 12 hidden units, and 10% dropout. After passing through the RNN, we extract the final time point as <code>val[:,-1]</code> in <code>forward()</code> below. This gets passed through a 10% dropout and then flattened through a linear layer.</p>
<div id="519d9aff" class="cell" data-execution_count="102">
<div class="sourceCode cell-code" id="cb149"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb149-1"><a href="#cb149-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NYSEModel(nn.Module):</span>
<span id="cb149-2"><a href="#cb149-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb149-3"><a href="#cb149-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(NYSEModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb149-4"><a href="#cb149-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.rnn <span class="op">=</span> nn.RNN(<span class="dv">3</span>,</span>
<span id="cb149-5"><a href="#cb149-5" aria-hidden="true" tabindex="-1"></a>                          <span class="dv">12</span>,</span>
<span id="cb149-6"><a href="#cb149-6" aria-hidden="true" tabindex="-1"></a>                          batch_first<span class="op">=</span><span class="va">True</span>)</span>
<span id="cb149-7"><a href="#cb149-7" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dense <span class="op">=</span> nn.Linear(<span class="dv">12</span>, <span class="dv">1</span>)</span>
<span id="cb149-8"><a href="#cb149-8" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>.dropout <span class="op">=</span> nn.Dropout(<span class="fl">0.1</span>)</span>
<span id="cb149-9"><a href="#cb149-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb149-10"><a href="#cb149-10" aria-hidden="true" tabindex="-1"></a>        val, h_n <span class="op">=</span> <span class="va">self</span>.rnn(x)</span>
<span id="cb149-11"><a href="#cb149-11" aria-hidden="true" tabindex="-1"></a>        val <span class="op">=</span> <span class="va">self</span>.dense(<span class="va">self</span>.dropout(val[:,<span class="op">-</span><span class="dv">1</span>]))</span>
<span id="cb149-12"><a href="#cb149-12" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.flatten(val)</span>
<span id="cb149-13"><a href="#cb149-13" aria-hidden="true" tabindex="-1"></a>nyse_model <span class="op">=</span> NYSEModel()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We fit the model in a similar fashion to previous networks. We supply the <code>fit</code> function with test data as validation data, so that when we monitor its progress and plot the history function we can see the progress on the test data. Of course we should not use this as a basis for early stopping, since then the test performance would be biased.</p>
<p>We form the training dataset similar to our <code>Hitters</code> example.</p>
<div id="0785ebe9" class="cell" data-execution_count="103">
<div class="sourceCode cell-code" id="cb150"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb150-1"><a href="#cb150-1" aria-hidden="true" tabindex="-1"></a>datasets <span class="op">=</span> []</span>
<span id="cb150-2"><a href="#cb150-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mask <span class="kw">in</span> [train, <span class="op">~</span>train]:</span>
<span id="cb150-3"><a href="#cb150-3" aria-hidden="true" tabindex="-1"></a>    X_rnn_t <span class="op">=</span> torch.tensor(X_rnn[mask].astype(np.float32))</span>
<span id="cb150-4"><a href="#cb150-4" aria-hidden="true" tabindex="-1"></a>    Y_t <span class="op">=</span> torch.tensor(Y[mask].astype(np.float32))</span>
<span id="cb150-5"><a href="#cb150-5" aria-hidden="true" tabindex="-1"></a>    datasets.append(TensorDataset(X_rnn_t, Y_t))</span>
<span id="cb150-6"><a href="#cb150-6" aria-hidden="true" tabindex="-1"></a>nyse_train, nyse_test <span class="op">=</span> datasets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>/tmp/ipykernel_126815/2100042546.py:4: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  Y_t = torch.tensor(Y[mask].astype(np.float32))
/tmp/ipykernel_126815/2100042546.py:4: FutureWarning: Series.__getitem__ treating keys as positions is deprecated. In a future version, integer keys will always be treated as labels (consistent with DataFrame behavior). To access a value by position, use `ser.iloc[pos]`
  Y_t = torch.tensor(Y[mask].astype(np.float32))</code></pre>
</div>
</div>
<p>Following our usual pattern, we inspect the summary.</p>
<div id="2bb0e141" class="cell" data-execution_count="104">
<div class="sourceCode cell-code" id="cb152"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb152-1"><a href="#cb152-1" aria-hidden="true" tabindex="-1"></a>summary(nyse_model,</span>
<span id="cb152-2"><a href="#cb152-2" aria-hidden="true" tabindex="-1"></a>        input_data<span class="op">=</span>X_rnn_t,</span>
<span id="cb152-3"><a href="#cb152-3" aria-hidden="true" tabindex="-1"></a>        col_names<span class="op">=</span>[<span class="st">'input_size'</span>,</span>
<span id="cb152-4"><a href="#cb152-4" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'output_size'</span>,</span>
<span id="cb152-5"><a href="#cb152-5" aria-hidden="true" tabindex="-1"></a>                   <span class="st">'num_params'</span>])</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-display" data-execution_count="104">
<pre><code>===================================================================================================================
Layer (type:depth-idx)                   Input Shape               Output Shape              Param #
===================================================================================================================
NYSEModel                                [1770, 5, 3]              [1770]                    --
├─RNN: 1-1                               [1770, 5, 3]              [1770, 5, 12]             204
├─Dropout: 1-2                           [1770, 12]                [1770, 12]                --
├─Linear: 1-3                            [1770, 12]                [1770, 1]                 13
===================================================================================================================
Total params: 217
Trainable params: 217
Non-trainable params: 0
Total mult-adds (M): 1.83
===================================================================================================================
Input size (MB): 0.11
Forward/backward pass size (MB): 0.86
Params size (MB): 0.00
Estimated Total Size (MB): 0.97
===================================================================================================================</code></pre>
</div>
</div>
<p>We again put the two datasets into a data module, with a batch size of 64.</p>
<div id="d5cb57cc" class="cell" data-execution_count="105">
<div class="sourceCode cell-code" id="cb154"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb154-1"><a href="#cb154-1" aria-hidden="true" tabindex="-1"></a>nyse_dm <span class="op">=</span> SimpleDataModule(nyse_train,</span>
<span id="cb154-2"><a href="#cb154-2" aria-hidden="true" tabindex="-1"></a>                           nyse_test,</span>
<span id="cb154-3"><a href="#cb154-3" aria-hidden="true" tabindex="-1"></a>                           num_workers<span class="op">=</span><span class="bu">min</span>(<span class="dv">4</span>, max_num_workers),</span>
<span id="cb154-4"><a href="#cb154-4" aria-hidden="true" tabindex="-1"></a>                           validation<span class="op">=</span>nyse_test,</span>
<span id="cb154-5"><a href="#cb154-5" aria-hidden="true" tabindex="-1"></a>                           batch_size<span class="op">=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We run some data through our model to be sure the sizes match up correctly.</p>
<div id="d868a7a4" class="cell" data-execution_count="106">
<div class="sourceCode cell-code" id="cb155"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb155-1"><a href="#cb155-1" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> idx, (x, y) <span class="kw">in</span> <span class="bu">enumerate</span>(nyse_dm.train_dataloader()):</span>
<span id="cb155-2"><a href="#cb155-2" aria-hidden="true" tabindex="-1"></a>    out <span class="op">=</span> nyse_model(x)</span>
<span id="cb155-3"><a href="#cb155-3" aria-hidden="true" tabindex="-1"></a>    <span class="bu">print</span>(y.size(), out.size())</span>
<span id="cb155-4"><a href="#cb155-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> idx <span class="op">&gt;=</span> <span class="dv">2</span>:</span>
<span id="cb155-5"><a href="#cb155-5" aria-hidden="true" tabindex="-1"></a>        <span class="cf">break</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>torch.Size([64]) torch.Size([64])
torch.Size([64]) torch.Size([64])
torch.Size([64]) torch.Size([64])</code></pre>
</div>
</div>
<p>We follow our previous example for setting up a trainer for a regression problem, requesting the <span class="math inline">R^2</span> metric to be be computed at each epoch.</p>
<div id="8511292c" class="cell" data-execution_count="107">
<div class="sourceCode cell-code" id="cb157"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb157-1"><a href="#cb157-1" aria-hidden="true" tabindex="-1"></a>nyse_optimizer <span class="op">=</span> RMSprop(nyse_model.parameters(),</span>
<span id="cb157-2"><a href="#cb157-2" aria-hidden="true" tabindex="-1"></a>                         lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb157-3"><a href="#cb157-3" aria-hidden="true" tabindex="-1"></a>nyse_module <span class="op">=</span> SimpleModule.regression(nyse_model,</span>
<span id="cb157-4"><a href="#cb157-4" aria-hidden="true" tabindex="-1"></a>                                      optimizer<span class="op">=</span>nyse_optimizer,</span>
<span id="cb157-5"><a href="#cb157-5" aria-hidden="true" tabindex="-1"></a>                                      metrics<span class="op">=</span>{<span class="st">'r2'</span>:R2Score()})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Fitting the model should by now be familiar. The results on the test data are very similar to the linear AR model.</p>
<div id="17531c82" class="cell" data-execution_count="108">
<div class="sourceCode cell-code" id="cb158"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb158-1"><a href="#cb158-1" aria-hidden="true" tabindex="-1"></a>nyse_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb158-2"><a href="#cb158-2" aria-hidden="true" tabindex="-1"></a>                       max_epochs<span class="op">=</span><span class="dv">200</span>,</span>
<span id="cb158-3"><a href="#cb158-3" aria-hidden="true" tabindex="-1"></a>                       enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb158-4"><a href="#cb158-4" aria-hidden="true" tabindex="-1"></a>                       callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb158-5"><a href="#cb158-5" aria-hidden="true" tabindex="-1"></a>nyse_trainer.fit(nyse_module,</span>
<span id="cb158-6"><a href="#cb158-6" aria-hidden="true" tabindex="-1"></a>                 datamodule<span class="op">=</span>nyse_dm)</span>
<span id="cb158-7"><a href="#cb158-7" aria-hidden="true" tabindex="-1"></a>nyse_trainer.test(nyse_module,</span>
<span id="cb158-8"><a href="#cb158-8" aria-hidden="true" tabindex="-1"></a>                  datamodule<span class="op">=</span>nyse_dm)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type      | Params
------------------------------------
0 | model | NYSEModel | 217   
1 | loss  | MSELoss   | 0     
------------------------------------
217       Trainable params
0         Non-trainable params
217       Total params
0.001     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[108], line 5</span>
<span class="ansi-green-fg ansi-bold">      1</span> nyse_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                        max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">200</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                        enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      4</span>                        callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 5</span> <span class="ansi-yellow-bg">nyse_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nyse_module</span><span class="ansi-yellow-bg">,</span>
<span class="ansi-green-fg ansi-bold">      6</span> <span class="ansi-yellow-bg">                 </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">nyse_dm</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      7</span> nyse_trainer<span style="color:rgb(98,98,98)">.</span>test(nyse_module,
<span class="ansi-green-fg ansi-bold">      8</span>                   datamodule<span style="color:rgb(98,98,98)">=</span>nyse_dm)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1031</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1029</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training:
<span class="ansi-green-fg ansi-bold">   1030</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> isolate_rng():
<span class="ansi-green-fg">-&gt; 1031</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_sanity_check</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg ansi-bold">   1033</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fit_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1060</span>, in <span class="ansi-cyan-fg">Trainer._run_sanity_check</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1057</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_start</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1059</span> <span style="font-style:italic;color:rgb(95,135,135)"># run eval step</span>
<span class="ansi-green-fg">-&gt; 1060</span> <span class="ansi-yellow-bg">val_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1062</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_end</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1064</span> <span style="font-style:italic;color:rgb(95,135,135)"># reset logger connector</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:261</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_validation_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    254</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_validation_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    255</span>                               trainer,
<span class="ansi-green-fg ansi-bold">    256</span>                               pl_module,
<span class="ansi-green-fg ansi-bold">    257</span>                               batch,
<span class="ansi-green-fg ansi-bold">    258</span>                               batch_idx,
<span class="ansi-green-fg ansi-bold">    259</span>                               dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    260</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 261</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    262</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[102], line 11</span>, in <span class="ansi-cyan-fg">NYSEModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">      9</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg ansi-bold">     10</span>     val, h_n <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>rnn(x)
<span class="ansi-green-fg">---&gt; 11</span>     val <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dense</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">dropout</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">val</span><span class="ansi-yellow-bg">[</span><span class="ansi-yellow-bg">:</span><span class="ansi-yellow-bg">,</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">-</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">1</span><span class="ansi-yellow-bg">]</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     12</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(val)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>
<p>We could also fit a model without the <code>nn.RNN()</code> layer by just using a <code>nn.Flatten()</code> layer instead. This would be a nonlinear AR model. If in addition we excluded the hidden layer, this would be equivalent to our earlier linear AR model.</p>
<p>Instead we will fit a nonlinear AR model using the feature set <code>X_day</code> that includes the <code>day_of_week</code> indicators. To do so, we must first create our test and training datasets and a corresponding data module. This may seem a little burdensome, but is part of the general pipeline for <code>torch</code>.</p>
<div id="350d3458" class="cell" data-execution_count="109">
<div class="sourceCode cell-code" id="cb160"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb160-1"><a href="#cb160-1" aria-hidden="true" tabindex="-1"></a>datasets <span class="op">=</span> []</span>
<span id="cb160-2"><a href="#cb160-2" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span> mask <span class="kw">in</span> [train, <span class="op">~</span>train]:</span>
<span id="cb160-3"><a href="#cb160-3" aria-hidden="true" tabindex="-1"></a>    X_day_t <span class="op">=</span> torch.tensor(</span>
<span id="cb160-4"><a href="#cb160-4" aria-hidden="true" tabindex="-1"></a>                   np.asarray(X_day[mask]).astype(np.float32))</span>
<span id="cb160-5"><a href="#cb160-5" aria-hidden="true" tabindex="-1"></a>    Y_t <span class="op">=</span> torch.tensor(np.asarray(Y[mask]).astype(np.float32))</span>
<span id="cb160-6"><a href="#cb160-6" aria-hidden="true" tabindex="-1"></a>    datasets.append(TensorDataset(X_day_t, Y_t))</span>
<span id="cb160-7"><a href="#cb160-7" aria-hidden="true" tabindex="-1"></a>day_train, day_test <span class="op">=</span> datasets</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Creating a data module follows a familiar pattern.</p>
<div id="3850ce23" class="cell" data-execution_count="110">
<div class="sourceCode cell-code" id="cb161"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb161-1"><a href="#cb161-1" aria-hidden="true" tabindex="-1"></a>day_dm <span class="op">=</span> SimpleDataModule(day_train,</span>
<span id="cb161-2"><a href="#cb161-2" aria-hidden="true" tabindex="-1"></a>                          day_test,</span>
<span id="cb161-3"><a href="#cb161-3" aria-hidden="true" tabindex="-1"></a>                          num_workers<span class="op">=</span><span class="bu">min</span>(<span class="dv">4</span>, max_num_workers),</span>
<span id="cb161-4"><a href="#cb161-4" aria-hidden="true" tabindex="-1"></a>                          validation<span class="op">=</span>day_test,</span>
<span id="cb161-5"><a href="#cb161-5" aria-hidden="true" tabindex="-1"></a>                          batch_size<span class="op">=</span><span class="dv">64</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We build a <code>NonLinearARModel()</code> that takes as input the 20 features and a hidden layer with 32 units. The remaining steps are familiar.</p>
<div id="157119ef" class="cell" data-execution_count="111">
<div class="sourceCode cell-code" id="cb162"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb162-1"><a href="#cb162-1" aria-hidden="true" tabindex="-1"></a><span class="kw">class</span> NonLinearARModel(nn.Module):</span>
<span id="cb162-2"><a href="#cb162-2" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> <span class="fu">__init__</span>(<span class="va">self</span>):</span>
<span id="cb162-3"><a href="#cb162-3" aria-hidden="true" tabindex="-1"></a>        <span class="bu">super</span>(NonLinearARModel, <span class="va">self</span>).<span class="fu">__init__</span>()</span>
<span id="cb162-4"><a href="#cb162-4" aria-hidden="true" tabindex="-1"></a>        <span class="va">self</span>._forward <span class="op">=</span> nn.Sequential(nn.Flatten(),</span>
<span id="cb162-5"><a href="#cb162-5" aria-hidden="true" tabindex="-1"></a>                                      nn.Linear(<span class="dv">20</span>, <span class="dv">32</span>),</span>
<span id="cb162-6"><a href="#cb162-6" aria-hidden="true" tabindex="-1"></a>                                      nn.ReLU(),</span>
<span id="cb162-7"><a href="#cb162-7" aria-hidden="true" tabindex="-1"></a>                                      nn.Dropout(<span class="fl">0.5</span>),</span>
<span id="cb162-8"><a href="#cb162-8" aria-hidden="true" tabindex="-1"></a>                                      nn.Linear(<span class="dv">32</span>, <span class="dv">1</span>))</span>
<span id="cb162-9"><a href="#cb162-9" aria-hidden="true" tabindex="-1"></a>    <span class="kw">def</span> forward(<span class="va">self</span>, x):</span>
<span id="cb162-10"><a href="#cb162-10" aria-hidden="true" tabindex="-1"></a>        <span class="cf">return</span> torch.flatten(<span class="va">self</span>._forward(x))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div id="d541af20" class="cell" data-execution_count="112">
<div class="sourceCode cell-code" id="cb163"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb163-1"><a href="#cb163-1" aria-hidden="true" tabindex="-1"></a>nl_model <span class="op">=</span> NonLinearARModel()</span>
<span id="cb163-2"><a href="#cb163-2" aria-hidden="true" tabindex="-1"></a>nl_optimizer <span class="op">=</span> RMSprop(nl_model.parameters(),</span>
<span id="cb163-3"><a href="#cb163-3" aria-hidden="true" tabindex="-1"></a>                           lr<span class="op">=</span><span class="fl">0.001</span>)</span>
<span id="cb163-4"><a href="#cb163-4" aria-hidden="true" tabindex="-1"></a>nl_module <span class="op">=</span> SimpleModule.regression(nl_model,</span>
<span id="cb163-5"><a href="#cb163-5" aria-hidden="true" tabindex="-1"></a>                                        optimizer<span class="op">=</span>nl_optimizer,</span>
<span id="cb163-6"><a href="#cb163-6" aria-hidden="true" tabindex="-1"></a>                                        metrics<span class="op">=</span>{<span class="st">'r2'</span>:R2Score()})</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We continue with the usual training steps, fit the model, and evaluate the test error. We see the test <span class="math inline">R^2</span> is a slight improvement over the linear AR model that also includes <code>day_of_week</code>.</p>
<div id="cc7b3081" class="cell" data-execution_count="113">
<div class="sourceCode cell-code" id="cb164"><pre class="sourceCode python code-with-copy"><code class="sourceCode python"><span id="cb164-1"><a href="#cb164-1" aria-hidden="true" tabindex="-1"></a>nl_trainer <span class="op">=</span> Trainer(deterministic<span class="op">=</span><span class="va">True</span>,</span>
<span id="cb164-2"><a href="#cb164-2" aria-hidden="true" tabindex="-1"></a>                     max_epochs<span class="op">=</span><span class="dv">20</span>,</span>
<span id="cb164-3"><a href="#cb164-3" aria-hidden="true" tabindex="-1"></a>                     enable_progress_bar<span class="op">=</span><span class="va">False</span>,</span>
<span id="cb164-4"><a href="#cb164-4" aria-hidden="true" tabindex="-1"></a>                     callbacks<span class="op">=</span>[ErrorTracker()])</span>
<span id="cb164-5"><a href="#cb164-5" aria-hidden="true" tabindex="-1"></a>nl_trainer.fit(nl_module, datamodule<span class="op">=</span>day_dm)</span>
<span id="cb164-6"><a href="#cb164-6" aria-hidden="true" tabindex="-1"></a>nl_trainer.test(nl_module, datamodule<span class="op">=</span>day_dm) </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>GPU available: True (cuda), used: True
TPU available: False, using: 0 TPU cores
IPU available: False, using: 0 IPUs
HPU available: False, using: 0 HPUs
LOCAL_RANK: 0 - CUDA_VISIBLE_DEVICES: [0]

  | Name  | Type             | Params
-------------------------------------------
0 | model | NonLinearARModel | 705   
1 | loss  | MSELoss          | 0     
-------------------------------------------
705       Trainable params
0         Non-trainable params
705       Total params
0.003     Total estimated model params size (MB)</code></pre>
</div>
<div class="cell-output cell-output-error">
<div class="ansi-escaped-output">
<pre><span class="ansi-red-fg">---------------------------------------------------------------------------</span>
<span class="ansi-red-fg">RuntimeError</span>                              Traceback (most recent call last)
Cell <span class="ansi-green-fg">In[113], line 5</span>
<span class="ansi-green-fg ansi-bold">      1</span> nl_trainer <span style="color:rgb(98,98,98)">=</span> Trainer(deterministic<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">      2</span>                      max_epochs<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">20</span>,
<span class="ansi-green-fg ansi-bold">      3</span>                      enable_progress_bar<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">False</span>,
<span class="ansi-green-fg ansi-bold">      4</span>                      callbacks<span style="color:rgb(98,98,98)">=</span>[ErrorTracker()])
<span class="ansi-green-fg">----&gt; 5</span> <span class="ansi-yellow-bg">nl_trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">fit</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">nl_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">day_dm</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">      6</span> nl_trainer<span style="color:rgb(98,98,98)">.</span>test(nl_module, datamodule<span style="color:rgb(98,98,98)">=</span>day_dm) 

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:544</span>, in <span class="ansi-cyan-fg">Trainer.fit</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    542</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>status <span style="color:rgb(98,98,98)">=</span> TrainerStatus<span style="color:rgb(98,98,98)">.</span>RUNNING
<span class="ansi-green-fg ansi-bold">    543</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">True</span>
<span class="ansi-green-fg">--&gt; 544</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_and_handle_interrupt</span><span class="ansi-yellow-bg">(</span>
<span class="ansi-green-fg ansi-bold">    545</span> <span class="ansi-yellow-bg">    </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_fit_impl</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">train_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">val_dataloaders</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">datamodule</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span>
<span class="ansi-green-fg ansi-bold">    546</span> <span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:44</span>, in <span class="ansi-cyan-fg">_call_and_handle_interrupt</span><span class="ansi-blue-fg">(trainer, trainer_fn, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">     42</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>:
<span class="ansi-green-fg ansi-bold">     43</span>         <span style="font-weight:bold;color:rgb(0,135,0)">return</span> trainer<span style="color:rgb(98,98,98)">.</span>strategy<span style="color:rgb(98,98,98)">.</span>launcher<span style="color:rgb(98,98,98)">.</span>launch(trainer_fn, <span style="color:rgb(98,98,98)">*</span>args, trainer<span style="color:rgb(98,98,98)">=</span>trainer, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)
<span class="ansi-green-fg">---&gt; 44</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">trainer_fn</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">     46</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> _TunerExitException:
<span class="ansi-green-fg ansi-bold">     47</span>     _call_teardown_hook(trainer)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:580</span>, in <span class="ansi-cyan-fg">Trainer._fit_impl</span><span class="ansi-blue-fg">(self, model, train_dataloaders, val_dataloaders, datamodule, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    573</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    574</span> ckpt_path <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_checkpoint_connector<span style="color:rgb(98,98,98)">.</span>_select_ckpt_path(
<span class="ansi-green-fg ansi-bold">    575</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>fn,
<span class="ansi-green-fg ansi-bold">    576</span>     ckpt_path,
<span class="ansi-green-fg ansi-bold">    577</span>     model_provided<span style="color:rgb(98,98,98)">=</span><span style="font-weight:bold;color:rgb(0,135,0)">True</span>,
<span class="ansi-green-fg ansi-bold">    578</span>     model_connected<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>lightning_module <span style="font-weight:bold;color:rgb(175,0,255)">is</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>,
<span class="ansi-green-fg ansi-bold">    579</span> )
<span class="ansi-green-fg">--&gt; 580</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">ckpt_path</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">=</span><span class="ansi-yellow-bg">ckpt_path</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    582</span> <span style="font-weight:bold;color:rgb(0,135,0)">assert</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>state<span style="color:rgb(98,98,98)">.</span>stopped
<span class="ansi-green-fg ansi-bold">    583</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">False</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:987</span>, in <span class="ansi-cyan-fg">Trainer._run</span><span class="ansi-blue-fg">(self, model, ckpt_path)</span>
<span class="ansi-green-fg ansi-bold">    982</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_signal_connector<span style="color:rgb(98,98,98)">.</span>register_signal_handlers()
<span class="ansi-green-fg ansi-bold">    984</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    985</span> <span style="font-style:italic;color:rgb(95,135,135)"># RUN THE TRAINER</span>
<span class="ansi-green-fg ansi-bold">    986</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg">--&gt; 987</span> results <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_stage</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    989</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    990</span> <span style="font-style:italic;color:rgb(95,135,135)"># POST-Training CLEAN UP</span>
<span class="ansi-green-fg ansi-bold">    991</span> <span style="font-style:italic;color:rgb(95,135,135)"># ----------------------------</span>
<span class="ansi-green-fg ansi-bold">    992</span> log<span style="color:rgb(98,98,98)">.</span>debug(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span><span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__class__</span><span style="color:rgb(98,98,98)">.</span><span style="color:rgb(0,0,135)">__name__</span><span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">: trainer tearing down</span><span style="color:rgb(175,0,0)">"</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1031</span>, in <span class="ansi-cyan-fg">Trainer._run_stage</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1029</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>training:
<span class="ansi-green-fg ansi-bold">   1030</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> isolate_rng():
<span class="ansi-green-fg">-&gt; 1031</span>         <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_run_sanity_check</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1032</span>     <span style="font-weight:bold;color:rgb(0,135,0)">with</span> torch<span style="color:rgb(98,98,98)">.</span>autograd<span style="color:rgb(98,98,98)">.</span>set_detect_anomaly(<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_detect_anomaly):
<span class="ansi-green-fg ansi-bold">   1033</span>         <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>fit_loop<span style="color:rgb(98,98,98)">.</span>run()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/trainer.py:1060</span>, in <span class="ansi-cyan-fg">Trainer._run_sanity_check</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">   1057</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_start</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1059</span> <span style="font-style:italic;color:rgb(95,135,135)"># run eval step</span>
<span class="ansi-green-fg">-&gt; 1060</span> <span class="ansi-yellow-bg">val_loop</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">run</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1062</span> call<span style="color:rgb(98,98,98)">.</span>_call_callback_hooks(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_sanity_check_end</span><span style="color:rgb(175,0,0)">"</span>)
<span class="ansi-green-fg ansi-bold">   1064</span> <span style="font-style:italic;color:rgb(95,135,135)"># reset logger connector</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/utilities.py:182</span>, in <span class="ansi-cyan-fg">_no_grad_context.&lt;locals&gt;._decorator</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    180</span>     context_manager <span style="color:rgb(98,98,98)">=</span> torch<span style="color:rgb(98,98,98)">.</span>no_grad
<span class="ansi-green-fg ansi-bold">    181</span> <span style="font-weight:bold;color:rgb(0,135,0)">with</span> context_manager():
<span class="ansi-green-fg">--&gt; 182</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">loop_run</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:135</span>, in <span class="ansi-cyan-fg">_EvaluationLoop.run</span><span class="ansi-blue-fg">(self)</span>
<span class="ansi-green-fg ansi-bold">    133</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>is_last_batch <span style="color:rgb(98,98,98)">=</span> data_fetcher<span style="color:rgb(98,98,98)">.</span>done
<span class="ansi-green-fg ansi-bold">    134</span>     <span style="font-style:italic;color:rgb(95,135,135)"># run step hooks</span>
<span class="ansi-green-fg">--&gt; 135</span>     <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_evaluation_step</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">batch</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">batch_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_idx</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">dataloader_iter</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    136</span> <span style="font-weight:bold;color:rgb(0,135,0)">except</span> <span style="font-weight:bold;color:rgb(215,95,95)">StopIteration</span>:
<span class="ansi-green-fg ansi-bold">    137</span>     <span style="font-style:italic;color:rgb(95,135,135)"># this needs to wrap the `*_step` call too (not just `next`) for `dataloader_iter` support</span>
<span class="ansi-green-fg ansi-bold">    138</span>     <span style="font-weight:bold;color:rgb(0,135,0)">break</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/loops/evaluation_loop.py:385</span>, in <span class="ansi-cyan-fg">_EvaluationLoop._evaluation_step</span><span class="ansi-blue-fg">(self, batch, batch_idx, dataloader_idx, dataloader_iter)</span>
<span class="ansi-green-fg ansi-bold">    380</span> trainer<span style="color:rgb(98,98,98)">.</span>_logger_connector<span style="color:rgb(98,98,98)">.</span>on_batch_start(
<span class="ansi-green-fg ansi-bold">    381</span>     batch, dataloader_idx <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_is_sequential <span style="font-weight:bold;color:rgb(175,0,255)">and</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>num_dataloaders <span style="color:rgb(98,98,98)">&gt;</span> <span style="color:rgb(98,98,98)">1</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>
<span class="ansi-green-fg ansi-bold">    382</span> )
<span class="ansi-green-fg ansi-bold">    384</span> hook_name <span style="color:rgb(98,98,98)">=</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_test_batch_start</span><span style="color:rgb(175,0,0)">"</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> trainer<span style="color:rgb(98,98,98)">.</span>testing <span style="font-weight:bold;color:rgb(0,135,0)">else</span> <span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">on_validation_batch_start</span><span style="color:rgb(175,0,0)">"</span>
<span class="ansi-green-fg">--&gt; 385</span> <span class="ansi-yellow-bg">call</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_callback_hooks</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">hook_name</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">hook_kwargs</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">values</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">)</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    386</span> call<span style="color:rgb(98,98,98)">.</span>_call_lightning_module_hook(trainer, hook_name, <span style="color:rgb(98,98,98)">*</span>hook_kwargs<span style="color:rgb(98,98,98)">.</span>values())
<span class="ansi-green-fg ansi-bold">    388</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>batch_progress<span style="color:rgb(98,98,98)">.</span>increment_started()

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/pytorch_lightning/trainer/call.py:208</span>, in <span class="ansi-cyan-fg">_call_callback_hooks</span><span class="ansi-blue-fg">(trainer, hook_name, monitoring_callbacks, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">    206</span>     <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="color:rgb(0,135,0)">callable</span>(fn):
<span class="ansi-green-fg ansi-bold">    207</span>         <span style="font-weight:bold;color:rgb(0,135,0)">with</span> trainer<span style="color:rgb(98,98,98)">.</span>profiler<span style="color:rgb(98,98,98)">.</span>profile(<span style="color:rgb(175,0,0)">f</span><span style="color:rgb(175,0,0)">"</span><span style="color:rgb(175,0,0)">[Callback]</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>callback<span style="color:rgb(98,98,98)">.</span>state_key<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">.</span><span style="font-weight:bold;color:rgb(175,95,135)">{</span>hook_name<span style="font-weight:bold;color:rgb(175,95,135)">}</span><span style="color:rgb(175,0,0)">"</span>):
<span class="ansi-green-fg">--&gt; 208</span>             <span class="ansi-yellow-bg">fn</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">trainer</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span class="ansi-yellow-bg">trainer</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">lightning_module</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    210</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> pl_module:
<span class="ansi-green-fg ansi-bold">    211</span>     <span style="font-style:italic;color:rgb(95,135,135)"># restore current_fx when nested context</span>
<span class="ansi-green-fg ansi-bold">    212</span>     pl_module<span style="color:rgb(98,98,98)">.</span>_current_fx_name <span style="color:rgb(98,98,98)">=</span> prev_fx_name

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:261</span>, in <span class="ansi-cyan-fg">ErrorTracker.on_validation_batch_start</span><span class="ansi-blue-fg">(self, trainer, pl_module, batch, batch_idx, dataloader_idx)</span>
<span class="ansi-green-fg ansi-bold">    254</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">on_validation_batch_start</span>(<span style="color:rgb(0,135,0)">self</span>,
<span class="ansi-green-fg ansi-bold">    255</span>                               trainer,
<span class="ansi-green-fg ansi-bold">    256</span>                               pl_module,
<span class="ansi-green-fg ansi-bold">    257</span>                               batch,
<span class="ansi-green-fg ansi-bold">    258</span>                               batch_idx,
<span class="ansi-green-fg ansi-bold">    259</span>                               dataloader_idx<span style="color:rgb(98,98,98)">=</span><span style="color:rgb(98,98,98)">0</span>):
<span class="ansi-green-fg ansi-bold">    260</span>     x, y <span style="color:rgb(98,98,98)">=</span> batch
<span class="ansi-green-fg">--&gt; 261</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_preds<span style="color:rgb(98,98,98)">.</span>append(<span class="ansi-yellow-bg">pl_module</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)
<span class="ansi-green-fg ansi-bold">    262</span>     <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>val_targets<span style="color:rgb(98,98,98)">.</span>append(y)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/ISLP/torch/lightning.py:151</span>, in <span class="ansi-cyan-fg">SimpleModule.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">    150</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">--&gt; 151</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">model</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

Cell <span class="ansi-green-fg">In[111], line 10</span>, in <span class="ansi-cyan-fg">NonLinearARModel.forward</span><span class="ansi-blue-fg">(self, x)</span>
<span class="ansi-green-fg ansi-bold">      9</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, x):
<span class="ansi-green-fg">---&gt; 10</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> torch<span style="color:rgb(98,98,98)">.</span>flatten(<span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_forward</span><span class="ansi-yellow-bg">(</span><span class="ansi-yellow-bg">x</span><span class="ansi-yellow-bg">)</span>)

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/container.py:217</span>, in <span class="ansi-cyan-fg">Sequential.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    215</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>):
<span class="ansi-green-fg ansi-bold">    216</span>     <span style="font-weight:bold;color:rgb(0,135,0)">for</span> module <span style="font-weight:bold;color:rgb(175,0,255)">in</span> <span style="color:rgb(0,135,0)">self</span>:
<span class="ansi-green-fg">--&gt; 217</span>         <span style="color:rgb(0,135,0)">input</span> <span style="color:rgb(98,98,98)">=</span> <span class="ansi-yellow-bg">module</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">    218</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">input</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1532</span>, in <span class="ansi-cyan-fg">Module._wrapped_call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1530</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_compiled_call_impl(<span style="color:rgb(98,98,98)">*</span>args, <span style="color:rgb(98,98,98)">*</span><span style="color:rgb(98,98,98)">*</span>kwargs)  <span style="font-style:italic;color:rgb(95,135,135)"># type: ignore[misc]</span>
<span class="ansi-green-fg ansi-bold">   1531</span> <span style="font-weight:bold;color:rgb(0,135,0)">else</span>:
<span class="ansi-green-fg">-&gt; 1532</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">_call_impl</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/module.py:1541</span>, in <span class="ansi-cyan-fg">Module._call_impl</span><span class="ansi-blue-fg">(self, *args, **kwargs)</span>
<span class="ansi-green-fg ansi-bold">   1536</span> <span style="font-style:italic;color:rgb(95,135,135)"># If we don't have any hooks, we want to skip the rest of the logic in</span>
<span class="ansi-green-fg ansi-bold">   1537</span> <span style="font-style:italic;color:rgb(95,135,135)"># this function, and just call forward.</span>
<span class="ansi-green-fg ansi-bold">   1538</span> <span style="font-weight:bold;color:rgb(0,135,0)">if</span> <span style="font-weight:bold;color:rgb(175,0,255)">not</span> (<span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> <span style="color:rgb(0,135,0)">self</span><span style="color:rgb(98,98,98)">.</span>_forward_pre_hooks
<span class="ansi-green-fg ansi-bold">   1539</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_pre_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_backward_hooks
<span class="ansi-green-fg ansi-bold">   1540</span>         <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_hooks <span style="font-weight:bold;color:rgb(175,0,255)">or</span> _global_forward_pre_hooks):
<span class="ansi-green-fg">-&gt; 1541</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">forward_call</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">args</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">*</span><span class="ansi-yellow-bg">kwargs</span><span class="ansi-yellow-bg">)</span>
<span class="ansi-green-fg ansi-bold">   1543</span> <span style="font-weight:bold;color:rgb(0,135,0)">try</span>:
<span class="ansi-green-fg ansi-bold">   1544</span>     result <span style="color:rgb(98,98,98)">=</span> <span style="font-weight:bold;color:rgb(0,135,0)">None</span>

File <span class="ansi-green-fg">~/work/notes/notes-islr-py/.venv/lib/python3.10/site-packages/torch/nn/modules/linear.py:116</span>, in <span class="ansi-cyan-fg">Linear.forward</span><span class="ansi-blue-fg">(self, input)</span>
<span class="ansi-green-fg ansi-bold">    115</span> <span style="font-weight:bold;color:rgb(0,135,0)">def</span><span style="color:rgb(188,188,188)"> </span><span style="color:rgb(0,0,255)">forward</span>(<span style="color:rgb(0,135,0)">self</span>, <span style="color:rgb(0,135,0)">input</span>: Tensor) <span style="color:rgb(98,98,98)">-</span><span style="color:rgb(98,98,98)">&gt;</span> Tensor:
<span class="ansi-green-fg">--&gt; 116</span>     <span style="font-weight:bold;color:rgb(0,135,0)">return</span> <span class="ansi-yellow-bg">F</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">linear</span><span class="ansi-yellow-bg">(</span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">input</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">weight</span><span class="ansi-yellow-bg">,</span><span class="ansi-yellow-bg"> </span><span style="color:rgb(0,135,0)" class="ansi-yellow-bg">self</span><span style="color:rgb(98,98,98)" class="ansi-yellow-bg">.</span><span class="ansi-yellow-bg">bias</span><span class="ansi-yellow-bg">)</span>

<span class="ansi-red-fg">RuntimeError</span>: Deterministic behavior was enabled with either `torch.use_deterministic_algorithms(True)` or `at::Context::setDeterministicAlgorithms(true)`, but this operation is not deterministic because it uses CuBLAS and you have CUDA &gt;= 10.2. To enable deterministic behavior in this case, you must set an environment variable before running your PyTorch application: CUBLAS_WORKSPACE_CONFIG=:4096:8 or CUBLAS_WORKSPACE_CONFIG=:16:8. For more information, go to https://docs.nvidia.com/cuda/cublas/index.html#results-reproducibility</pre>
</div>
</div>
</div>


</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" id="quarto-reuse"><h2 class="anchored quarto-appendix-heading">Reuse</h2><div class="quarto-appendix-contents"><div>CC SA BY-NC-ND</div></div></section><section class="quarto-appendix-contents" id="quarto-citation"><h2 class="anchored quarto-appendix-heading">Citation</h2><div><div class="quarto-appendix-secondary-label">BibTeX citation:</div><pre class="sourceCode code-with-copy quarto-appendix-bibtex"><code class="sourceCode bibtex">@online{bochman2024,
  author = {Bochman, Oren},
  title = {Chapter 10: {Deep} {Learning}},
  date = {2024-08-21},
  url = {https://orenbochman.github.io/notes-islr/posts/ch10/Ch10-deeplearning-lab.html},
  langid = {en}
}
</code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre><div class="quarto-appendix-secondary-label">For attribution, please cite this work as:</div><div id="ref-bochman2024" class="csl-entry quarto-appendix-citeas" role="listitem">
Bochman, Oren. 2024. <span>“Chapter 10: Deep Learning.”</span> August
21, 2024. <a href="https://orenbochman.github.io/notes-islr/posts/ch10/Ch10-deeplearning-lab.html">https://orenbochman.github.io/notes-islr/posts/ch10/Ch10-deeplearning-lab.html</a>.
</div></div></section></div></main> <!-- /main -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const disableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'prefetch';
    }
  }
  const enableStylesheet = (stylesheets) => {
    for (let i=0; i < stylesheets.length; i++) {
      const stylesheet = stylesheets[i];
      stylesheet.rel = 'stylesheet';
    }
  }
  const manageTransitions = (selector, allowTransitions) => {
    const els = window.document.querySelectorAll(selector);
    for (let i=0; i < els.length; i++) {
      const el = els[i];
      if (allowTransitions) {
        el.classList.remove('notransition');
      } else {
        el.classList.add('notransition');
      }
    }
  }
  const toggleGiscusIfUsed = (isAlternate, darkModeDefault) => {
    const baseTheme = document.querySelector('#giscus-base-theme')?.value ?? 'light';
    const alternateTheme = document.querySelector('#giscus-alt-theme')?.value ?? 'dark';
    let newTheme = '';
    if(darkModeDefault) {
      newTheme = isAlternate ? baseTheme : alternateTheme;
    } else {
      newTheme = isAlternate ? alternateTheme : baseTheme;
    }
    const changeGiscusTheme = () => {
      // From: https://github.com/giscus/giscus/issues/336
      const sendMessage = (message) => {
        const iframe = document.querySelector('iframe.giscus-frame');
        if (!iframe) return;
        iframe.contentWindow.postMessage({ giscus: message }, 'https://giscus.app');
      }
      sendMessage({
        setConfig: {
          theme: newTheme
        }
      });
    }
    const isGiscussLoaded = window.document.querySelector('iframe.giscus-frame') !== null;
    if (isGiscussLoaded) {
      changeGiscusTheme();
    }
  }
  const toggleColorMode = (alternate) => {
    // Switch the stylesheets
    const alternateStylesheets = window.document.querySelectorAll('link.quarto-color-scheme.quarto-color-alternate');
    manageTransitions('#quarto-margin-sidebar .nav-link', false);
    if (alternate) {
      enableStylesheet(alternateStylesheets);
      for (const sheetNode of alternateStylesheets) {
        if (sheetNode.id === "quarto-bootstrap") {
          toggleBodyColorMode(sheetNode);
        }
      }
    } else {
      disableStylesheet(alternateStylesheets);
      toggleBodyColorPrimary();
    }
    manageTransitions('#quarto-margin-sidebar .nav-link', true);
    // Switch the toggles
    const toggles = window.document.querySelectorAll('.quarto-color-scheme-toggle');
    for (let i=0; i < toggles.length; i++) {
      const toggle = toggles[i];
      if (toggle) {
        if (alternate) {
          toggle.classList.add("alternate");     
        } else {
          toggle.classList.remove("alternate");
        }
      }
    }
    // Hack to workaround the fact that safari doesn't
    // properly recolor the scrollbar when toggling (#1455)
    if (navigator.userAgent.indexOf('Safari') > 0 && navigator.userAgent.indexOf('Chrome') == -1) {
      manageTransitions("body", false);
      window.scrollTo(0, 1);
      setTimeout(() => {
        window.scrollTo(0, 0);
        manageTransitions("body", true);
      }, 40);  
    }
  }
  const isFileUrl = () => { 
    return window.location.protocol === 'file:';
  }
  const hasAlternateSentinel = () => {  
    let styleSentinel = getColorSchemeSentinel();
    if (styleSentinel !== null) {
      return styleSentinel === "alternate";
    } else {
      return false;
    }
  }
  const setStyleSentinel = (alternate) => {
    const value = alternate ? "alternate" : "default";
    if (!isFileUrl()) {
      window.localStorage.setItem("quarto-color-scheme", value);
    } else {
      localAlternateSentinel = value;
    }
  }
  const getColorSchemeSentinel = () => {
    if (!isFileUrl()) {
      const storageValue = window.localStorage.getItem("quarto-color-scheme");
      return storageValue != null ? storageValue : localAlternateSentinel;
    } else {
      return localAlternateSentinel;
    }
  }
  const darkModeDefault = false;
  let localAlternateSentinel = darkModeDefault ? 'alternate' : 'default';
  // Dark / light mode switch
  window.quartoToggleColorScheme = () => {
    // Read the current dark / light value 
    let toAlternate = !hasAlternateSentinel();
    toggleColorMode(toAlternate);
    setStyleSentinel(toAlternate);
    toggleGiscusIfUsed(toAlternate, darkModeDefault);
  };
  // Ensure there is a toggle, if there isn't float one in the top right
  if (window.document.querySelector('.quarto-color-scheme-toggle') === null) {
    const a = window.document.createElement('a');
    a.classList.add('top-right');
    a.classList.add('quarto-color-scheme-toggle');
    a.href = "";
    a.onclick = function() { try { window.quartoToggleColorScheme(); } catch {} return false; };
    const i = window.document.createElement("i");
    i.classList.add('bi');
    a.appendChild(i);
    window.document.body.appendChild(a);
  }
  // Switch to dark mode if need be
  if (hasAlternateSentinel()) {
    toggleColorMode(true);
  } else {
    toggleColorMode(false);
  }
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
  const viewSource = window.document.getElementById('quarto-view-source') ||
                     window.document.getElementById('quarto-code-tools-source');
  if (viewSource) {
    const sourceUrl = viewSource.getAttribute("data-quarto-source-url");
    viewSource.addEventListener("click", function(e) {
      if (sourceUrl) {
        // rstudio viewer pane
        if (/\bcapabilities=\b/.test(window.location)) {
          window.open(sourceUrl);
        } else {
          window.location.href = sourceUrl;
        }
      } else {
        const modal = new bootstrap.Modal(document.getElementById('quarto-embedded-source-code-modal'));
        modal.show();
      }
      return false;
    });
  }
  function toggleCodeHandler(show) {
    return function(e) {
      const detailsSrc = window.document.querySelectorAll(".cell > details > .sourceCode");
      for (let i=0; i<detailsSrc.length; i++) {
        const details = detailsSrc[i].parentElement;
        if (show) {
          details.open = true;
        } else {
          details.removeAttribute("open");
        }
      }
      const cellCodeDivs = window.document.querySelectorAll(".cell > .sourceCode");
      const fromCls = show ? "hidden" : "unhidden";
      const toCls = show ? "unhidden" : "hidden";
      for (let i=0; i<cellCodeDivs.length; i++) {
        const codeDiv = cellCodeDivs[i];
        if (codeDiv.classList.contains(fromCls)) {
          codeDiv.classList.remove(fromCls);
          codeDiv.classList.add(toCls);
        } 
      }
      return false;
    }
  }
  const hideAllCode = window.document.getElementById("quarto-hide-all-code");
  if (hideAllCode) {
    hideAllCode.addEventListener("click", toggleCodeHandler(false));
  }
  const showAllCode = window.document.getElementById("quarto-show-all-code");
  if (showAllCode) {
    showAllCode.addEventListener("click", toggleCodeHandler(true));
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp("https:\/\/orenbochman\.github\.io\/notes-islr\/");
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
          // target, if specified
          link.setAttribute("target", "_blank");
          if (link.getAttribute("rel") === null) {
            link.setAttribute("rel", "noopener");
          }
          // default icon
          link.classList.add("external");
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      const annoteTargets = window.document.querySelectorAll('.code-annotation-anchor');
      for (let i=0; i<annoteTargets.length; i++) {
        const annoteTarget = annoteTargets[i];
        const targetCell = annoteTarget.getAttribute("data-target-cell");
        const targetAnnotation = annoteTarget.getAttribute("data-target-annotation");
        const contentFn = () => {
          const content = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          if (content) {
            const tipContent = content.cloneNode(true);
            tipContent.classList.add("code-annotation-tip-content");
            return tipContent.outerHTML;
          }
        }
        const config = {
          allowHTML: true,
          content: contentFn,
          onShow: (instance) => {
            selectCodeLines(instance.reference);
            instance.reference.classList.add('code-annotation-active');
            window.tippy.hideAll();
          },
          onHide: (instance) => {
            unselectCodeLines();
            instance.reference.classList.remove('code-annotation-active');
          },
          maxWidth: 300,
          delay: [50, 0],
          duration: [200, 0],
          offset: [5, 10],
          arrow: true,
          appendTo: function(el) {
            return el.parentElement.parentElement.parentElement;
          },
          interactive: true,
          interactiveBorder: 10,
          theme: 'quarto',
          placement: 'right',
          popperOptions: {
            modifiers: [
            {
              name: 'flip',
              options: {
                flipVariations: false, // true by default
                allowedAutoPlacements: ['right'],
                fallbackPlacements: ['right', 'top', 'top-start', 'top-end', 'bottom', 'bottom-start', 'bottom-end', 'left'],
              },
            },
            {
              name: 'preventOverflow',
              options: {
                mainAxis: false,
                altAxis: false
              }
            }
            ]        
          }      
        };
        window.tippy(annoteTarget, config); 
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
<script src="https://utteranc.es/client.js" repo="OrenBochman/blogComments" issue-term="pathname" theme="github-light" crossorigin="anonymous" async="">
</script>
</div> <!-- /content -->
<footer class="footer">
  <div class="nav-footer">
    <div class="nav-footer-left">
<p>© Copyright 2024-2025, Oren Bochman</p>
</div>   
    <div class="nav-footer-center">
      &nbsp;
    <div class="toc-actions d-sm-block d-md-none"><ul><li><a href="https://github.com/OrenBochman/notes-islr-py/edit/main/posts/ch10/Ch10-deeplearning-lab.qmd" class="toc-action"><i class="bi bi-github"></i>Edit this page</a></li><li><a href="https://github.com/OrenBochman/notes-islr-py/issues/new" class="toc-action"><i class="bi empty"></i>Report an issue</a></li></ul></div></div>
    <div class="nav-footer-right">
<p>This page is built with 💛 and <a href="https://quarto.org/">Quarto</a>.</p>
</div>
  </div>
</footer>
    <script type="text/javascript">
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let pseudocodeOptions = {
          indentSize: el.dataset.indentSize || "1.2em",
          commentDelimiter: el.dataset.commentDelimiter || "//",
          lineNumber: el.dataset.lineNumber === "true" ? true : false,
          lineNumberPunc: el.dataset.lineNumberPunc || ":",
          noEnd: el.dataset.noEnd === "true" ? true : false,
          titlePrefix: el.dataset.captionPrefix || "Algorithm"
        };
        pseudocode.renderElement(el.querySelector(".pseudocode"), pseudocodeOptions);
      });
    })(document);
    (function(d) {
      d.querySelectorAll(".pseudocode-container").forEach(function(el) {
        let captionSpan = el.querySelector(".ps-root > .ps-algorithm > .ps-line > .ps-keyword")
        if (captionSpan !== null) {
          let captionPrefix = el.dataset.captionPrefix + " ";
          let captionNumber = "";
          if (el.dataset.pseudocodeNumber) {
            captionNumber = el.dataset.pseudocodeNumber + " ";
            if (el.dataset.chapterLevel) {
              captionNumber = el.dataset.chapterLevel + "." + captionNumber;
            }
          }
          captionSpan.innerHTML = captionPrefix + captionNumber;
        }
      });
    })(document);
    </script>
  
<script>var lightboxQuarto = GLightbox({"closeEffect":"zoom","descPosition":"bottom","loop":false,"openEffect":"zoom","selector":".lightbox"});
(function() {
  let previousOnload = window.onload;
  window.onload = () => {
    if (previousOnload) {
      previousOnload();
    }
    lightboxQuarto.on('slide_before_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      const href = trigger.getAttribute('href');
      if (href !== null) {
        const imgEl = window.document.querySelector(`a[href="${href}"] img`);
        if (imgEl !== null) {
          const srcAttr = imgEl.getAttribute("src");
          if (srcAttr && srcAttr.startsWith("data:")) {
            slideConfig.href = srcAttr;
          }
        }
      } 
    });
  
    lightboxQuarto.on('slide_after_load', (data) => {
      const { slideIndex, slideNode, slideConfig, player, trigger } = data;
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(slideNode);
      }
    });
  
  };
  
})();
          </script>




</body></html>